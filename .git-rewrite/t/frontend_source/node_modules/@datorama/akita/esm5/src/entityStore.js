/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { isEmpty } from './isEmpty';
import { setEntities } from './setEntities';
import { Store } from './store';
import { getActiveEntities } from './getActiveEntities';
import { addEntities } from './addEntities';
import { coerceArray } from './coerceArray';
import { removeEntities } from './removeEntities';
import { getInitialEntitiesState } from './getInitialEntitiesState';
import { isDefined } from './isDefined';
import { updateEntities } from './updateEntities';
import { transaction } from './transaction';
import { isNil } from './isNil';
import { isFunction } from './isFunction';
import { isUndefined } from './isUndefined';
import { logAction, setAction } from './actions';
import { isDev } from './env';
import { hasEntity } from './hasEntity';
import { Subject } from 'rxjs';
import { EntityActions } from './entityActions';
import { DEFAULT_ID_KEY } from './defaultIDKey';
/**
 *
 * Store for managing a collection of entities
 *
 * \@example
 *
 * export interface WidgetsState extends EntityState<Widget> { }
 *
 * \@StoreConfig({ name: 'widgets' })
 *  export class WidgetsStore extends EntityStore<WidgetsState> {
 *   constructor() {
 *     super();
 *   }
 * }
 *
 *
 * @template S, EntityType, IDType
 */
var EntityStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityStore, _super);
    function EntityStore(initialState, options) {
        if (initialState === void 0) { initialState = {}; }
        if (options === void 0) { options = {}; }
        var _this = _super.call(this, tslib_1.__assign({}, getInitialEntitiesState(), initialState), options) || this;
        _this.options = options;
        _this.entityActions = new Subject();
        return _this;
    }
    Object.defineProperty(EntityStore.prototype, "selectEntityAction$", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return this.entityActions.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "idKey", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return ((/** @type {?} */ (this.config))).idKey || this.options.idKey || DEFAULT_ID_KEY;
        },
        enumerable: true,
        configurable: true
    });
    /**
     *
     * Replace current collection with provided collection
     *
     * @example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     */
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @return {?}
     */
    EntityStore.prototype.set = /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @return {?}
     */
    function (entities) {
        var _this = this;
        if (isNil(entities))
            return;
        isDev() && setAction('Set Entity');
        /** @type {?} */
        var isNativePreAdd = this.akitaPreAddEntity === EntityStore.prototype.akitaPreAddEntity;
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return setEntities({
                state: state,
                entities: entities,
                idKey: _this.idKey,
                preAddEntity: _this.akitaPreAddEntity,
                isNativePreAdd: isNativePreAdd
            });
        }));
        this.setHasCache(true, { restartTTL: true });
        if (this.hasInitialUIState()) {
            this.handleUICreation();
        }
        this.entityActions.next({ type: EntityActions.Set, ids: this.ids });
    };
    /**
     * Add entities
     *
     * @example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     */
    /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.add = /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        if (options === void 0) { options = { loading: false }; }
        /** @type {?} */
        var collection = coerceArray(entities);
        if (isEmpty(collection))
            return;
        /** @type {?} */
        var data = addEntities({
            state: this._value(),
            preAddEntity: this.akitaPreAddEntity,
            entities: collection,
            idKey: this.idKey,
            options: options
        });
        if (data) {
            isDev() && setAction('Add Entity');
            data.newState.loading = options.loading;
            this._setState((/**
             * @return {?}
             */
            function () { return data.newState; }));
            if (this.hasInitialUIState()) {
                this.handleUICreation(true);
            }
            this.entityActions.next({ type: EntityActions.Add, ids: data.newIds });
        }
    };
    /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    EntityStore.prototype.update = /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    function (idsOrFnOrState, newStateOrFn) {
        var _this = this;
        if (isUndefined(newStateOrFn)) {
            _super.prototype.update.call(this, (/** @type {?} */ (idsOrFnOrState)));
            return;
        }
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFnOrState)) {
            // We need to filter according the predicate function
            ids = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            function (id) { return ((/** @type {?} */ (idsOrFnOrState)))(_this.entities[id]); }));
        }
        else {
            // If it's nil we want all of them
            ids = isNil(idsOrFnOrState) ? this.ids : coerceArray((/** @type {?} */ (idsOrFnOrState)));
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Update Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return updateEntities({
                idKey: _this.idKey,
                ids: ids,
                preUpdateEntity: _this.akitaPreUpdateEntity,
                state: state,
                newStateOrFn: newStateOrFn
            });
        }));
        this.entityActions.next({ type: EntityActions.Update, ids: ids });
    };
    /**
     *
     * Create or update
     *
     * @example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     */
    /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.upsert = /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    function (ids, newState, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var toArray = coerceArray(ids);
        /** @type {?} */
        var predicate = (/**
         * @param {?} isUpdate
         * @return {?}
         */
        function (isUpdate) { return (/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return hasEntity(_this.entities, id) === isUpdate; }); });
        /** @type {?} */
        var isClassBased = isFunction(options.baseClass);
        /** @type {?} */
        var updateIds = toArray.filter(predicate(true));
        /** @type {?} */
        var newEntities = toArray.filter(predicate(false)).map((/**
         * @param {?} id
         * @return {?}
         */
        function (id) {
            var _a;
            /** @type {?} */
            var entity = isFunction(newState) ? newState((/** @type {?} */ ({}))) : newState;
            /** @type {?} */
            var withId = tslib_1.__assign({}, ((/** @type {?} */ (entity))), (_a = {}, _a[_this.idKey] = id, _a));
            if (isClassBased) {
                return new options.baseClass(withId);
            }
            return withId;
        }));
        // it can be any of the three types
        this.update((/** @type {?} */ (updateIds)), (/** @type {?} */ (newState)));
        this.add(newEntities);
        isDev() && logAction('Upsert Entity');
    };
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * @example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     */
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.upsertMany = /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        if (options === void 0) { options = {}; }
        var e_1, _a;
        /** @type {?} */
        var addedIds = [];
        /** @type {?} */
        var updatedIds = [];
        /** @type {?} */
        var updatedEntities = {};
        try {
            // Update the state directly to optimize performance
            for (var entities_1 = tslib_1.__values(entities), entities_1_1 = entities_1.next(); !entities_1_1.done; entities_1_1 = entities_1.next()) {
                var entity = entities_1_1.value;
                /** @type {?} */
                var withPreCheckHook = this.akitaPreCheckEntity(entity);
                /** @type {?} */
                var id = withPreCheckHook[this.idKey];
                if (hasEntity(this.entities, id)) {
                    /** @type {?} */
                    var prev = this._value().entities[id];
                    /** @type {?} */
                    var merged = tslib_1.__assign({}, this._value().entities[id], withPreCheckHook);
                    /** @type {?} */
                    var next = options.baseClass ? new options.baseClass(merged) : merged;
                    /** @type {?} */
                    var withHook = this.akitaPreUpdateEntity(prev, next);
                    /** @type {?} */
                    var nextId = withHook[this.idKey];
                    updatedEntities[nextId] = withHook;
                    updatedIds.push(nextId);
                }
                else {
                    /** @type {?} */
                    var newEntity = options.baseClass ? new options.baseClass(withPreCheckHook) : withPreCheckHook;
                    /** @type {?} */
                    var withHook = this.akitaPreAddEntity(newEntity);
                    /** @type {?} */
                    var nextId = withHook[this.idKey];
                    addedIds.push(nextId);
                    updatedEntities[nextId] = withHook;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (entities_1_1 && !entities_1_1.done && (_a = entities_1.return)) _a.call(entities_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        isDev() && logAction('Upsert Many');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { ids: addedIds.length ? tslib_1.__spread(state.ids, addedIds) : state.ids, entities: tslib_1.__assign({}, state.entities, updatedEntities), loading: !!options.loading })); }));
        updatedIds.length && this.entityActions.next({ type: EntityActions.Update, ids: updatedIds });
        addedIds.length && this.entityActions.next({ type: EntityActions.Add, ids: addedIds });
        if (addedIds.length && this.hasUIStore()) {
            this.handleUICreation(true);
        }
    };
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * @example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     */
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    EntityStore.prototype.replace = /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    function (ids, newState) {
        var e_2, _a;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var replaced = {};
        try {
            for (var toArray_1 = tslib_1.__values(toArray), toArray_1_1 = toArray_1.next(); !toArray_1_1.done; toArray_1_1 = toArray_1.next()) {
                var id = toArray_1_1.value;
                newState[this.idKey] = id;
                replaced[id] = newState;
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (toArray_1_1 && !toArray_1_1.done && (_a = toArray_1.return)) _a.call(toArray_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
        isDev() && setAction('Replace Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { entities: tslib_1.__assign({}, state.entities, replaced) })); }));
    };
    /**
     *
     * Move entity inside the collection
     *
     *
     * @example
     *
     * this.store.move(fromIndex, toIndex)
     */
    /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    EntityStore.prototype.move = /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    function (from, to) {
        /** @type {?} */
        var ids = this.ids.slice();
        ids.splice(to < 0 ? ids.length + to : to, 0, ids.splice(from, 1)[0]);
        isDev() && setAction('Move Entity');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { entities: tslib_1.__assign({}, state.entities), ids: ids })); }));
    };
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    EntityStore.prototype.remove = /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    function (idsOrFn) {
        var _this = this;
        if (isEmpty(this.ids))
            return;
        /** @type {?} */
        var idPassed = isDefined(idsOrFn);
        // null means remove all
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFn)) {
            ids = this.ids.filter((/**
             * @param {?} entityId
             * @return {?}
             */
            function (entityId) { return idsOrFn(_this.entities[entityId]); }));
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Remove Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return removeEntities({ state: state, ids: ids }); }));
        if (ids === null) {
            this.setHasCache(false);
        }
        this.handleUIRemove(ids);
        this.entityActions.next({ type: EntityActions.Remove, ids: ids });
    };
    /**
     *
     * Update the active entity
     *
     * @example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     */
    /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    EntityStore.prototype.updateActive = /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    function (newStateOrCallback) {
        /** @type {?} */
        var ids = coerceArray(this.active);
        isDev() && setAction('Update Active', ids);
        this.update(ids, (/** @type {?} */ (newStateOrCallback)));
    };
    /**
     * @param {?} idOrOptions
     * @return {?}
     */
    EntityStore.prototype.setActive = /**
     * @param {?} idOrOptions
     * @return {?}
     */
    function (idOrOptions) {
        /** @type {?} */
        var active = getActiveEntities(idOrOptions, this.ids, this.active);
        if (active === undefined) {
            return;
        }
        isDev() && setAction('Set Active', active);
        this._setActive(active);
    };
    /**
     * Add active entities
     *
     * @example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     */
    /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.addActive = /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var everyExist = toArray.every((/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.indexOf(id) > -1; }));
        if (everyExist)
            return;
        isDev() && setAction('Add Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            /**
             * Protect against case that one of the items in the array exist
             * @type {?}
             */
            var uniques = Array.from(new Set(tslib_1.__spread(((/** @type {?} */ (state.active))), toArray)));
            return tslib_1.__assign({}, state, { active: uniques });
        }));
    };
    /**
     * Remove active entities
     *
     * @example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     */
    /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.removeActive = /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var someExist = toArray.some((/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.indexOf(id) > -1; }));
        if (!someExist)
            return;
        isDev() && setAction('Remove Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return tslib_1.__assign({}, state, { active: Array.isArray(state.active) ? state.active.filter((/**
                 * @param {?} currentId
                 * @return {?}
                 */
                function (currentId) { return toArray.indexOf(currentId) === -1; })) : null });
        }));
    };
    /**
     * Toggle active entities
     *
     * @example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     */
    /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.toggleActive = /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        /** @type {?} */
        var filterExists = (/**
         * @param {?} remove
         * @return {?}
         */
        function (remove) { return (/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.includes(id) === remove; }); });
        /** @type {?} */
        var remove = toArray.filter(filterExists(true));
        /** @type {?} */
        var add = toArray.filter(filterExists(false));
        this.removeActive(remove);
        this.addActive(add);
        isDev() && logAction('Toggle Active');
    };
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * @example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     */
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    EntityStore.prototype.createUIStore = /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    function (initialState, storeConfig) {
        if (initialState === void 0) { initialState = {}; }
        if (storeConfig === void 0) { storeConfig = {}; }
        /** @type {?} */
        var defaults = { name: "UI/" + this.storeName, idKey: this.idKey };
        this.ui = new EntityUIStore(initialState, tslib_1.__assign({}, defaults, storeConfig));
        return this.ui;
    };
    // @internal
    // @internal
    /**
     * @return {?}
     */
    EntityStore.prototype.destroy = 
    // @internal
    /**
     * @return {?}
     */
    function () {
        _super.prototype.destroy.call(this);
        if (this.ui instanceof EntityStore) {
            this.ui.destroy();
        }
        this.entityActions.complete();
    };
    // @internal
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreUpdateEntity = 
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    function (_, nextEntity) {
        return (/** @type {?} */ (nextEntity));
    };
    // @internal
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreAddEntity = 
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    function (newEntity) {
        return (/** @type {?} */ (newEntity));
    };
    // @internal
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreCheckEntity = 
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    function (newEntity) {
        return newEntity;
    };
    Object.defineProperty(EntityStore.prototype, "ids", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().ids;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "entities", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().entities;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "active", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().active;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype._setActive = /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return tslib_1.__assign({}, state, { active: ids });
        }));
    };
    /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    EntityStore.prototype.handleUICreation = /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    function (add) {
        var _this = this;
        if (add === void 0) { add = false; }
        /** @type {?} */
        var ids = this.ids;
        /** @type {?} */
        var isFunc = isFunction(this.ui._akitaCreateEntityFn);
        /** @type {?} */
        var uiEntities;
        /** @type {?} */
        var createFn = (/**
         * @param {?} id
         * @return {?}
         */
        function (id) {
            var _a;
            /** @type {?} */
            var current = _this.entities[id];
            /** @type {?} */
            var ui = isFunc ? _this.ui._akitaCreateEntityFn(current) : _this.ui._akitaCreateEntityFn;
            return tslib_1.__assign((_a = {}, _a[_this.idKey] = current[_this.idKey], _a), ui);
        });
        if (add) {
            uiEntities = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            function (id) { return isUndefined(_this.ui.entities[id]); })).map(createFn);
        }
        else {
            uiEntities = ids.map(createFn);
        }
        add ? this.ui.add(uiEntities) : this.ui.set(uiEntities);
    };
    /**
     * @private
     * @return {?}
     */
    EntityStore.prototype.hasInitialUIState = /**
     * @private
     * @return {?}
     */
    function () {
        return this.hasUIStore() && isUndefined(this.ui._akitaCreateEntityFn) === false;
    };
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.handleUIRemove = /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        if (this.hasUIStore()) {
            this.ui.remove(ids);
        }
    };
    /**
     * @private
     * @return {?}
     */
    EntityStore.prototype.hasUIStore = /**
     * @private
     * @return {?}
     */
    function () {
        return this.ui instanceof EntityUIStore;
    };
    var _a;
    tslib_1.__decorate([
        transaction(),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object, Object, Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], EntityStore.prototype, "upsert", null);
    tslib_1.__decorate([
        transaction(),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof T !== "undefined" && T) === "function" ? _a : Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], EntityStore.prototype, "toggleActive", null);
    return EntityStore;
}(Store));
export { EntityStore };
if (false) {
    /** @type {?} */
    EntityStore.prototype.ui;
    /**
     * @type {?}
     * @private
     */
    EntityStore.prototype.entityActions;
    /**
     * @type {?}
     * @protected
     */
    EntityStore.prototype.options;
}
// @internal
/**
 * @template UIState, DEPRECATED
 */
var 
// @internal
/**
 * @template UIState, DEPRECATED
 */
EntityUIStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityUIStore, _super);
    function EntityUIStore(initialState, storeConfig) {
        if (initialState === void 0) { initialState = {}; }
        if (storeConfig === void 0) { storeConfig = {}; }
        return _super.call(this, initialState, storeConfig) || this;
    }
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * @example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     */
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    EntityUIStore.prototype.setInitialEntityState = /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    function (createFn) {
        this._akitaCreateEntityFn = createFn;
    };
    return EntityUIStore;
}(EntityStore));
// @internal
/**
 * @template UIState, DEPRECATED
 */
export { EntityUIStore };
if (false) {
    /** @type {?} */
    EntityUIStore.prototype._akitaCreateEntityFn;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5U3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvZW50aXR5U3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sRUFBZSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVoQyxPQUFPLEVBQUUsaUJBQWlCLEVBQW9CLE1BQU0scUJBQXFCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFdBQVcsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU1QyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQzlCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMz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MlBEO1FBREMsV0FBVyxFQUFFOztxRUFDeUIsQ0FBQyxvQkFBRCxDQUFDOzttREFRdkM7SUErR0gsa0JBQUM7Q0FBQSxBQXhpQkQsQ0FBb0gsS0FBSyxHQXdpQnhIO1NBeGlCWSxXQUFXOzs7SUFDdEIseUJBQW1DOzs7OztJQUNuQyxvQ0FBNEQ7Ozs7O0lBRWpCLDhCQUFtRDs7Ozs7O0FBdWlCaEc7Ozs7OztJQUE4RCx5Q0FBb0I7SUFHaEYsdUJBQVksWUFBaUIsRUFBRSxXQUE2QztRQUFoRSw2QkFBQSxFQUFBLGlCQUFpQjtRQUFFLDRCQUFBLEVBQUEsZ0JBQTZDO2VBQzFFLGtCQUFNLFlBQVksRUFBRSxXQUFXLENBQUM7SUFDbEMsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7O09BYUc7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUNILDZDQUFxQjs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFBckIsVUFBb0QsUUFBNEM7UUFDOUYsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsQ0FBQztJQUN2QyxDQUFDO0lBQ0gsb0JBQUM7QUFBRCxDQUFDLEFBeEJELENBQThELFdBQVcsR0F3QnhFOzs7Ozs7OztJQXZCQyw2Q0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0VtcHR5IH0gZnJvbSAnLi9pc0VtcHR5JztcbmltcG9ydCB7IFNldEVudGl0aWVzLCBzZXRFbnRpdGllcyB9IGZyb20gJy4vc2V0RW50aXRpZXMnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICcuL3N0b3JlJztcbmltcG9ydCB7IENvbnN0cnVjdG9yLCBFbnRpdHlTdGF0ZSwgRW50aXR5VUlDcmVhdGVGbiwgSUQsIElEUywgT3JBcnJheSwgU3RhdGVXaXRoQWN0aXZlLCBVcGRhdGVFbnRpdHlQcmVkaWNhdGUsIFVwZGF0ZVN0YXRlQ2FsbGJhY2ssIGdldEVudGl0eVR5cGUsIGdldElEVHlwZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZ2V0QWN0aXZlRW50aXRpZXMsIFNldEFjdGl2ZU9wdGlvbnMgfSBmcm9tICcuL2dldEFjdGl2ZUVudGl0aWVzJztcbmltcG9ydCB7IGFkZEVudGl0aWVzLCBBZGRFbnRpdGllc09wdGlvbnMgfSBmcm9tICcuL2FkZEVudGl0aWVzJztcbmltcG9ydCB7IGNvZXJjZUFycmF5IH0gZnJvbSAnLi9jb2VyY2VBcnJheSc7XG5pbXBvcnQgeyByZW1vdmVFbnRpdGllcyB9IGZyb20gJy4vcmVtb3ZlRW50aXRpZXMnO1xuaW1wb3J0IHsgZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUgfSBmcm9tICcuL2dldEluaXRpYWxFbnRpdGllc1N0YXRlJztcbmltcG9ydCB7IGlzRGVmaW5lZCB9IGZyb20gJy4vaXNEZWZpbmVkJztcbmltcG9ydCB7IHVwZGF0ZUVudGl0aWVzIH0gZnJvbSAnLi91cGRhdGVFbnRpdGllcyc7XG5pbXBvcnQgeyB0cmFuc2FjdGlvbiB9IGZyb20gJy4vdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHsgaXNOaWwgfSBmcm9tICcuL2lzTmlsJztcbmltcG9ydCB7IGlzRnVuY3Rpb24gfSBmcm9tICcuL2lzRnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNVbmRlZmluZWQgfSBmcm9tICcuL2lzVW5kZWZpbmVkJztcbmltcG9ydCB7IFN0b3JlQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4vc3RvcmVDb25maWcnO1xuaW1wb3J0IHsgbG9nQWN0aW9uLCBzZXRBY3Rpb24gfSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgaXNEZXYgfSBmcm9tICcuL2Vudic7XG5pbXBvcnQgeyBoYXNFbnRpdHkgfSBmcm9tICcuL2hhc0VudGl0eSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFbnRpdHlBY3Rpb24sIEVudGl0eUFjdGlvbnMgfSBmcm9tICcuL2VudGl0eUFjdGlvbnMnO1xuaW1wb3J0IHsgREVGQVVMVF9JRF9LRVkgfSBmcm9tICcuL2RlZmF1bHRJREtleSc7XG5cbi8qKlxuICpcbiAqIFN0b3JlIGZvciBtYW5hZ2luZyBhIGNvbGxlY3Rpb24gb2YgZW50aXRpZXNcbiAqXG4gKiBAZXhhbXBsZVxuICpcbiAqIGV4cG9ydCBpbnRlcmZhY2UgV2lkZ2V0c1N0YXRlIGV4dGVuZHMgRW50aXR5U3RhdGU8V2lkZ2V0PiB7IH1cbiAqXG4gKiBAU3RvcmVDb25maWcoeyBuYW1lOiAnd2lkZ2V0cycgfSlcbiAqICBleHBvcnQgY2xhc3MgV2lkZ2V0c1N0b3JlIGV4dGVuZHMgRW50aXR5U3RvcmU8V2lkZ2V0c1N0YXRlPiB7XG4gKiAgIGNvbnN0cnVjdG9yKCkge1xuICogICAgIHN1cGVyKCk7XG4gKiAgIH1cbiAqIH1cbiAqXG4gKlxuICovXG5leHBvcnQgY2xhc3MgRW50aXR5U3RvcmU8UyBleHRlbmRzIEVudGl0eVN0YXRlID0gYW55LCBFbnRpdHlUeXBlID0gZ2V0RW50aXR5VHlwZTxTPiwgSURUeXBlID0gZ2V0SURUeXBlPFM+PiBleHRlbmRzIFN0b3JlPFM+IHtcbiAgdWk6IEVudGl0eVVJU3RvcmU8YW55LCBFbnRpdHlUeXBlPjtcbiAgcHJpdmF0ZSBlbnRpdHlBY3Rpb25zID0gbmV3IFN1YmplY3Q8RW50aXR5QWN0aW9uPElEVHlwZT4+KCk7XG5cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlOiBQYXJ0aWFsPFM+ID0ge30sIHByb3RlY3RlZCBvcHRpb25zOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIHN1cGVyKHsgLi4uZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUoKSwgLi4uaW5pdGlhbFN0YXRlIH0sIG9wdGlvbnMpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBzZWxlY3RFbnRpdHlBY3Rpb24kKCk6IE9ic2VydmFibGU8RW50aXR5QWN0aW9uPElEVHlwZT4+IHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdHlBY3Rpb25zLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBpZEtleSgpIHtcbiAgICByZXR1cm4gKHRoaXMuY29uZmlnIGFzIFN0b3JlQ29uZmlnT3B0aW9ucykuaWRLZXkgfHwgdGhpcy5vcHRpb25zLmlkS2V5IHx8IERFRkFVTFRfSURfS0VZO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlcGxhY2UgY3VycmVudCBjb2xsZWN0aW9uIHdpdGggcHJvdmlkZWQgY29sbGVjdGlvblxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnNldChbRW50aXR5LCBFbnRpdHldKVxuICAgKiB0aGlzLnN0b3JlLnNldCh7aWRzOiBbXSwgZW50aXRpZXM6IHt9fSlcbiAgICogdGhpcy5zdG9yZS5zZXQoeyAxOiB7fSwgMjoge319KVxuICAgKlxuICAgKi9cbiAgc2V0KGVudGl0aWVzOiBTZXRFbnRpdGllczxFbnRpdHlUeXBlPikge1xuICAgIGlmIChpc05pbChlbnRpdGllcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdTZXQgRW50aXR5Jyk7XG5cbiAgICBjb25zdCBpc05hdGl2ZVByZUFkZCA9IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHkgPT09IEVudGl0eVN0b3JlLnByb3RvdHlwZS5ha2l0YVByZUFkZEVudGl0eTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PlxuICAgICAgc2V0RW50aXRpZXMoe1xuICAgICAgICBzdGF0ZSxcbiAgICAgICAgZW50aXRpZXMsXG4gICAgICAgIGlkS2V5OiB0aGlzLmlkS2V5LFxuICAgICAgICBwcmVBZGRFbnRpdHk6IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHksXG4gICAgICAgIGlzTmF0aXZlUHJlQWRkXG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLnNldEhhc0NhY2hlKHRydWUsIHsgcmVzdGFydFRUTDogdHJ1ZSB9KTtcblxuICAgIGlmICh0aGlzLmhhc0luaXRpYWxVSVN0YXRlKCkpIHtcbiAgICAgIHRoaXMuaGFuZGxlVUlDcmVhdGlvbigpO1xuICAgIH1cblxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5TZXQsIGlkczogdGhpcy5pZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUuYWRkKFtFbnRpdHksIEVudGl0eV0pXG4gICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSlcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5LCB7IHByZXBlbmQ6IHRydWUgfSlcbiAgICpcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5LCB7IGxvYWRpbmc6IGZhbHNlIH0pXG4gICAqL1xuICBhZGQoZW50aXRpZXM6IE9yQXJyYXk8RW50aXR5VHlwZT4sIG9wdGlvbnM6IEFkZEVudGl0aWVzT3B0aW9ucyA9IHsgbG9hZGluZzogZmFsc2UgfSkge1xuICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBjb2VyY2VBcnJheShlbnRpdGllcyk7XG5cbiAgICBpZiAoaXNFbXB0eShjb2xsZWN0aW9uKSkgcmV0dXJuO1xuXG4gICAgY29uc3QgZGF0YSA9IGFkZEVudGl0aWVzKHtcbiAgICAgIHN0YXRlOiB0aGlzLl92YWx1ZSgpLFxuICAgICAgcHJlQWRkRW50aXR5OiB0aGlzLmFraXRhUHJlQWRkRW50aXR5LFxuICAgICAgZW50aXRpZXM6IGNvbGxlY3Rpb24sXG4gICAgICBpZEtleTogdGhpcy5pZEtleSxcbiAgICAgIG9wdGlvbnNcbiAgICB9KTtcblxuICAgIGlmIChkYXRhKSB7XG4gICAgICBpc0RldigpICYmIHNldEFjdGlvbignQWRkIEVudGl0eScpO1xuICAgICAgZGF0YS5uZXdTdGF0ZS5sb2FkaW5nID0gb3B0aW9ucy5sb2FkaW5nO1xuXG4gICAgICB0aGlzLl9zZXRTdGF0ZSgoKSA9PiBkYXRhLm5ld1N0YXRlKTtcblxuICAgICAgaWYgKHRoaXMuaGFzSW5pdGlhbFVJU3RhdGUoKSkge1xuICAgICAgICB0aGlzLmhhbmRsZVVJQ3JlYXRpb24odHJ1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5BZGQsIGlkczogZGF0YS5uZXdJZHMgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cGRhdGUoMSwgZW50aXR5ID0+IC4uLilcbiAgICogc3RvcmUudXBkYXRlKFsxLCAyLCAzXSwgZW50aXR5ID0+IC4uLilcbiAgICogc3RvcmUudXBkYXRlKG51bGwsIGVudGl0eSA9PiAuLi4pXG4gICAqL1xuICB1cGRhdGUoaWQ6IE9yQXJyYXk8SURUeXBlPiB8IG51bGwsIG5ld1N0YXRlRm46IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4pO1xuICAvKipcbiAgICogc3RvcmUudXBkYXRlKDEsIHsgbmFtZTogbmV3TmFtZSB9KVxuICAgKi9cbiAgdXBkYXRlKGlkOiBPckFycmF5PElEVHlwZT4gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPik7XG4gIC8qKlxuICAgKiBzdG9yZS51cGRhdGUoZW50aXR5ID0+IGVudGl0eS5wcmljZSA+IDMsIGVudGl0eSA9PiAoeyBuYW1lOiBuZXdOYW1lIH0pKVxuICAgKi9cbiAgdXBkYXRlKHByZWRpY2F0ZTogVXBkYXRlRW50aXR5UHJlZGljYXRlPEVudGl0eVR5cGU+LCBuZXdTdGF0ZUZuOiBVcGRhdGVTdGF0ZUNhbGxiYWNrPEVudGl0eVR5cGU+KTtcbiAgLyoqXG4gICAqIHN0b3JlLnVwZGF0ZShlbnRpdHkgPT4gZW50aXR5LnByaWNlID4gMywgeyBuYW1lOiBuZXdOYW1lIH0pXG4gICAqL1xuICB1cGRhdGUocHJlZGljYXRlOiBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sIG5ld1N0YXRlOiBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgLyoqIFN1cHBvcnQgbm9uLWVudGl0eSB1cGRhdGVzICovXG4gIHVwZGF0ZShuZXdTdGF0ZTogVXBkYXRlU3RhdGVDYWxsYmFjazxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShcbiAgICBpZHNPckZuT3JTdGF0ZTogT3JBcnJheTxJRFR5cGU+IHwgbnVsbCB8IFBhcnRpYWw8Uz4gfCBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+IHwgVXBkYXRlRW50aXR5UHJlZGljYXRlPEVudGl0eVR5cGU+LFxuICAgIG5ld1N0YXRlT3JGbj86IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPEVudGl0eVR5cGU+IHwgUGFydGlhbDxTPlxuICApIHtcbiAgICBpZiAoaXNVbmRlZmluZWQobmV3U3RhdGVPckZuKSkge1xuICAgICAgc3VwZXIudXBkYXRlKGlkc09yRm5PclN0YXRlIGFzIFBhcnRpYWw8Uz4pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgaWRzOiBJRFR5cGVbXSA9IFtdO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbk9yU3RhdGUpKSB7XG4gICAgICAvLyBXZSBuZWVkIHRvIGZpbHRlciBhY2NvcmRpbmcgdGhlIHByZWRpY2F0ZSBmdW5jdGlvblxuICAgICAgaWRzID0gdGhpcy5pZHMuZmlsdGVyKGlkID0+IChpZHNPckZuT3JTdGF0ZSBhcyBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4pKHRoaXMuZW50aXRpZXNbaWRdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIElmIGl0J3MgbmlsIHdlIHdhbnQgYWxsIG9mIHRoZW1cbiAgICAgIGlkcyA9IGlzTmlsKGlkc09yRm5PclN0YXRlKSA/IHRoaXMuaWRzIDogY29lcmNlQXJyYXkoaWRzT3JGbk9yU3RhdGUgYXMgT3JBcnJheTxJRFR5cGU+KTtcbiAgICB9XG5cbiAgICBpZiAoaXNFbXB0eShpZHMpKSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignVXBkYXRlIEVudGl0eScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT5cbiAgICAgIHVwZGF0ZUVudGl0aWVzKHtcbiAgICAgICAgaWRLZXk6IHRoaXMuaWRLZXksXG4gICAgICAgIGlkcyxcbiAgICAgICAgcHJlVXBkYXRlRW50aXR5OiB0aGlzLmFraXRhUHJlVXBkYXRlRW50aXR5LFxuICAgICAgICBzdGF0ZSxcbiAgICAgICAgbmV3U3RhdGVPckZuXG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuVXBkYXRlLCBpZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQ3JlYXRlIG9yIHVwZGF0ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cHNlcnQoMSwgeyBhY3RpdmU6IHRydWUgfSlcbiAgICogc3RvcmUudXBzZXJ0KFsyLCAzXSwgeyBhY3RpdmU6IHRydWUgfSlcbiAgICogc3RvcmUudXBzZXJ0KFsyLCAzXSwgZW50aXR5ID0+ICh7IGlzT3BlbjogIWVudGl0eS5pc09wZW59KSlcbiAgICpcbiAgICovXG4gIEB0cmFuc2FjdGlvbigpXG4gIHVwc2VydChpZHM6IE9yQXJyYXk8SURUeXBlPiwgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4gfCBFbnRpdHlUeXBlIHwgVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IEVudGl0eVR5cGVbXSwgb3B0aW9uczogeyBiYXNlQ2xhc3M/OiBDb25zdHJ1Y3RvciB9ID0ge30pIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBjb25zdCBwcmVkaWNhdGUgPSBpc1VwZGF0ZSA9PiBpZCA9PiBoYXNFbnRpdHkodGhpcy5lbnRpdGllcywgaWQpID09PSBpc1VwZGF0ZTtcbiAgICBjb25zdCBpc0NsYXNzQmFzZWQgPSBpc0Z1bmN0aW9uKG9wdGlvbnMuYmFzZUNsYXNzKTtcbiAgICBjb25zdCB1cGRhdGVJZHMgPSB0b0FycmF5LmZpbHRlcihwcmVkaWNhdGUodHJ1ZSkpO1xuICAgIGNvbnN0IG5ld0VudGl0aWVzID0gdG9BcnJheS5maWx0ZXIocHJlZGljYXRlKGZhbHNlKSkubWFwKGlkID0+IHtcbiAgICAgIGxldCBlbnRpdHkgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlKSA/IG5ld1N0YXRlKHt9IGFzIEVudGl0eVR5cGUpIDogbmV3U3RhdGU7XG4gICAgICBjb25zdCB3aXRoSWQgPSB7IC4uLihlbnRpdHkgYXMgRW50aXR5VHlwZSksIFt0aGlzLmlkS2V5XTogaWQgfTtcbiAgICAgIGlmIChpc0NsYXNzQmFzZWQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBvcHRpb25zLmJhc2VDbGFzcyh3aXRoSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHdpdGhJZDtcbiAgICB9KTtcblxuICAgIC8vIGl0IGNhbiBiZSBhbnkgb2YgdGhlIHRocmVlIHR5cGVzXG4gICAgdGhpcy51cGRhdGUodXBkYXRlSWRzIGFzIGFueSwgbmV3U3RhdGUgYXMgYW55KTtcbiAgICB0aGlzLmFkZChuZXdFbnRpdGllcyk7XG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1Vwc2VydCBFbnRpdHknKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBVcHNlcnQgZW50aXR5IGNvbGxlY3Rpb24gKGlkS2V5IG11c3QgYmUgcHJlc2VudClcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSk7XG4gICAqXG4gICAqIHN0b3JlLnVwc2VydE1hbnkoWyB7IGlkOiAxIH0sIHsgaWQ6IDIgfV0sIHsgbG9hZGluZzogdHJ1ZSAgfSk7XG4gICAqIHN0b3JlLnVwc2VydE1hbnkoWyB7IGlkOiAxIH0sIHsgaWQ6IDIgfV0sIHsgYmFzZUNsYXNzOiBUb2RvICB9KTtcbiAgICpcbiAgICovXG4gIHVwc2VydE1hbnkoZW50aXRpZXM6IEVudGl0eVR5cGVbXSwgb3B0aW9uczogeyBiYXNlQ2xhc3M/OiBDb25zdHJ1Y3RvcjsgbG9hZGluZz86IGJvb2xlYW4gfSA9IHt9KSB7XG4gICAgY29uc3QgYWRkZWRJZHMgPSBbXTtcbiAgICBjb25zdCB1cGRhdGVkSWRzID0gW107XG4gICAgY29uc3QgdXBkYXRlZEVudGl0aWVzID0ge307XG5cbiAgICAvLyBVcGRhdGUgdGhlIHN0YXRlIGRpcmVjdGx5IHRvIG9wdGltaXplIHBlcmZvcm1hbmNlXG4gICAgZm9yIChjb25zdCBlbnRpdHkgb2YgZW50aXRpZXMpIHtcbiAgICAgIGNvbnN0IHdpdGhQcmVDaGVja0hvb2sgPSB0aGlzLmFraXRhUHJlQ2hlY2tFbnRpdHkoZW50aXR5KTtcbiAgICAgIGNvbnN0IGlkID0gd2l0aFByZUNoZWNrSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgIGlmIChoYXNFbnRpdHkodGhpcy5lbnRpdGllcywgaWQpKSB7XG4gICAgICAgIGNvbnN0IHByZXYgPSB0aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXTtcbiAgICAgICAgY29uc3QgbWVyZ2VkID0geyAuLi50aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXSwgLi4ud2l0aFByZUNoZWNrSG9vayB9O1xuICAgICAgICBjb25zdCBuZXh0ID0gb3B0aW9ucy5iYXNlQ2xhc3MgPyBuZXcgb3B0aW9ucy5iYXNlQ2xhc3MobWVyZ2VkKSA6IG1lcmdlZDtcbiAgICAgICAgY29uc3Qgd2l0aEhvb2sgPSB0aGlzLmFraXRhUHJlVXBkYXRlRW50aXR5KHByZXYsIG5leHQpO1xuICAgICAgICBjb25zdCBuZXh0SWQgPSB3aXRoSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgICAgdXBkYXRlZEVudGl0aWVzW25leHRJZF0gPSB3aXRoSG9vaztcbiAgICAgICAgdXBkYXRlZElkcy5wdXNoKG5leHRJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBuZXdFbnRpdHkgPSBvcHRpb25zLmJhc2VDbGFzcyA/IG5ldyBvcHRpb25zLmJhc2VDbGFzcyh3aXRoUHJlQ2hlY2tIb29rKSA6IHdpdGhQcmVDaGVja0hvb2s7XG4gICAgICAgIGNvbnN0IHdpdGhIb29rID0gdGhpcy5ha2l0YVByZUFkZEVudGl0eShuZXdFbnRpdHkpO1xuICAgICAgICBjb25zdCBuZXh0SWQgPSB3aXRoSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgICAgYWRkZWRJZHMucHVzaChuZXh0SWQpO1xuICAgICAgICB1cGRhdGVkRW50aXRpZXNbbmV4dElkXSA9IHdpdGhIb29rO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlzRGV2KCkgJiYgbG9nQWN0aW9uKCdVcHNlcnQgTWFueScpO1xuXG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgaWRzOiBhZGRlZElkcy5sZW5ndGggPyBbLi4uc3RhdGUuaWRzLCAuLi5hZGRlZElkc10gOiBzdGF0ZS5pZHMsXG4gICAgICBlbnRpdGllczoge1xuICAgICAgICAuLi5zdGF0ZS5lbnRpdGllcyxcbiAgICAgICAgLi4udXBkYXRlZEVudGl0aWVzXG4gICAgICB9LFxuICAgICAgbG9hZGluZzogISFvcHRpb25zLmxvYWRpbmdcbiAgICB9KSk7XG5cbiAgICB1cGRhdGVkSWRzLmxlbmd0aCAmJiB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuVXBkYXRlLCBpZHM6IHVwZGF0ZWRJZHMgfSk7XG4gICAgYWRkZWRJZHMubGVuZ3RoICYmIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5BZGQsIGlkczogYWRkZWRJZHMgfSk7XG4gICAgaWYgKGFkZGVkSWRzLmxlbmd0aCAmJiB0aGlzLmhhc1VJU3RvcmUoKSkge1xuICAgICAgdGhpcy5oYW5kbGVVSUNyZWF0aW9uKHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZXBsYWNlIG9uZSBvciBtb3JlIGVudGl0aWVzIChleGNlcHQgdGhlIGlkIHByb3BlcnR5KVxuICAgKlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnJlcGxhY2UoNSwgbmV3RW50aXR5KVxuICAgKiB0aGlzLnN0b3JlLnJlcGxhY2UoWzEsMiwzXSwgbmV3RW50aXR5KVxuICAgKi9cbiAgcmVwbGFjZShpZHM6IElEUywgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4pIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBpZiAoaXNFbXB0eSh0b0FycmF5KSkgcmV0dXJuO1xuICAgIGxldCByZXBsYWNlZCA9IHt9O1xuICAgIGZvciAoY29uc3QgaWQgb2YgdG9BcnJheSkge1xuICAgICAgbmV3U3RhdGVbdGhpcy5pZEtleV0gPSBpZDtcbiAgICAgIHJlcGxhY2VkW2lkXSA9IG5ld1N0YXRlO1xuICAgIH1cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignUmVwbGFjZSBFbnRpdHknLCBpZHMpO1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICAuLi5yZXBsYWNlZFxuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBNb3ZlIGVudGl0eSBpbnNpZGUgdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS5tb3ZlKGZyb21JbmRleCwgdG9JbmRleClcbiAgICovXG4gIG1vdmUoZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyKSB7XG4gICAgY29uc3QgaWRzID0gdGhpcy5pZHMuc2xpY2UoKTtcbiAgICBpZHMuc3BsaWNlKHRvIDwgMCA/IGlkcy5sZW5ndGggKyB0byA6IHRvLCAwLCBpZHMuc3BsaWNlKGZyb20sIDEpWzBdKTtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdNb3ZlIEVudGl0eScpO1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIC8vIENoYW5nZSB0aGUgZW50aXRpZXMgcmVmZXJlbmNlIHNvIHRoYXQgc2VsZWN0QWxsIGVtaXRcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzXG4gICAgICB9LFxuICAgICAgaWRzXG4gICAgfSkpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlbW92ZSBvbmUgb3IgbW9yZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSg1KVxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShbMSwyLDNdKVxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSgpXG4gICAqL1xuICByZW1vdmUoaWQ/OiBPckFycmF5PElEVHlwZT4pO1xuICAvKipcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoZW50aXR5ID0+IGVudGl0eS5pZCA9PT0gMSlcbiAgICovXG4gIHJlbW92ZShwcmVkaWNhdGU6IChlbnRpdHk6IFJlYWRvbmx5PEVudGl0eVR5cGU+KSA9PiBib29sZWFuKTtcbiAgcmVtb3ZlKGlkc09yRm4/OiBPckFycmF5PElEVHlwZT4gfCAoKGVudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pID0+IGJvb2xlYW4pKSB7XG4gICAgaWYgKGlzRW1wdHkodGhpcy5pZHMpKSByZXR1cm47XG5cbiAgICBjb25zdCBpZFBhc3NlZCA9IGlzRGVmaW5lZChpZHNPckZuKTtcblxuICAgIC8vIG51bGwgbWVhbnMgcmVtb3ZlIGFsbFxuICAgIGxldCBpZHM6IElEVHlwZVtdIHwgbnVsbCA9IFtdO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbikpIHtcbiAgICAgIGlkcyA9IHRoaXMuaWRzLmZpbHRlcihlbnRpdHlJZCA9PiBpZHNPckZuKHRoaXMuZW50aXRpZXNbZW50aXR5SWRdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IGlkUGFzc2VkID8gY29lcmNlQXJyYXkoaWRzT3JGbikgOiBudWxsO1xuICAgIH1cblxuICAgIGlmIChpc0VtcHR5KGlkcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZW1vdmUgRW50aXR5JywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZSgoc3RhdGU6IFN0YXRlV2l0aEFjdGl2ZTxTPikgPT4gcmVtb3ZlRW50aXRpZXMoeyBzdGF0ZSwgaWRzIH0pKTtcbiAgICBpZiAoaWRzID09PSBudWxsKSB7XG4gICAgICB0aGlzLnNldEhhc0NhY2hlKGZhbHNlKTtcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZVVJUmVtb3ZlKGlkcyk7XG4gICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLlJlbW92ZSwgaWRzIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSB0aGUgYWN0aXZlIGVudGl0eVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZUFjdGl2ZSh7IGNvbXBsZXRlZDogdHJ1ZSB9KVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZUFjdGl2ZShhY3RpdmUgPT4ge1xuICAgKiAgIHJldHVybiB7XG4gICAqICAgICBjb25maWc6IHtcbiAgICogICAgICAuLmFjdGl2ZS5jb25maWcsXG4gICAqICAgICAgZGF0ZVxuICAgKiAgICAgfVxuICAgKiAgIH1cbiAgICogfSlcbiAgICovXG4gIHVwZGF0ZUFjdGl2ZShuZXdTdGF0ZU9yQ2FsbGJhY2s6IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPEVudGl0eVR5cGU+KSB7XG4gICAgY29uc3QgaWRzID0gY29lcmNlQXJyYXkodGhpcy5hY3RpdmUpO1xuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdVcGRhdGUgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLnVwZGF0ZShpZHMsIG5ld1N0YXRlT3JDYWxsYmFjayBhcyBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGdpdmVuIGVudGl0eSBhcyBhY3RpdmVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUuc2V0QWN0aXZlKDEpXG4gICAqIHN0b3JlLnNldEFjdGl2ZShbMSwgMiwgM10pXG4gICAqL1xuICBzZXRBY3RpdmUoaWRPck9wdGlvbnM6IFNbJ2FjdGl2ZSddIGV4dGVuZHMgYW55W10gPyBTWydhY3RpdmUnXSA6IChTZXRBY3RpdmVPcHRpb25zIHwgU1snYWN0aXZlJ10pKTtcbiAgc2V0QWN0aXZlKGlkT3JPcHRpb25zOiBJRFR5cGUgfCBTZXRBY3RpdmVPcHRpb25zIHwgbnVsbCkge1xuICAgIGNvbnN0IGFjdGl2ZSA9IGdldEFjdGl2ZUVudGl0aWVzKGlkT3JPcHRpb25zLCB0aGlzLmlkcywgdGhpcy5hY3RpdmUpO1xuXG4gICAgaWYgKGFjdGl2ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBBY3RpdmUnLCBhY3RpdmUpO1xuICAgIHRoaXMuX3NldEFjdGl2ZShhY3RpdmUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhY3RpdmUgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUuYWRkQWN0aXZlKDIpO1xuICAgKiBzdG9yZS5hZGRBY3RpdmUoWzMsIDQsIDVdKTtcbiAgICovXG4gIGFkZEFjdGl2ZTxUID0gT3JBcnJheTxJRFR5cGU+PihpZHM6IFQpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBpZiAoaXNFbXB0eSh0b0FycmF5KSkgcmV0dXJuO1xuICAgIGNvbnN0IGV2ZXJ5RXhpc3QgPSB0b0FycmF5LmV2ZXJ5KGlkID0+IHRoaXMuYWN0aXZlLmluZGV4T2YoaWQpID4gLTEpO1xuICAgIGlmIChldmVyeUV4aXN0KSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignQWRkIEFjdGl2ZScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgLyoqIFByb3RlY3QgYWdhaW5zdCBjYXNlIHRoYXQgb25lIG9mIHRoZSBpdGVtcyBpbiB0aGUgYXJyYXkgZXhpc3QgKi9cbiAgICAgIGNvbnN0IHVuaXF1ZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLihzdGF0ZS5hY3RpdmUgYXMgSURUeXBlW10pLCAuLi50b0FycmF5XSkpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogdW5pcXVlc1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYWN0aXZlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnJlbW92ZUFjdGl2ZSgyKVxuICAgKiBzdG9yZS5yZW1vdmVBY3RpdmUoWzMsIDQsIDVdKVxuICAgKi9cbiAgcmVtb3ZlQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgY29uc3Qgc29tZUV4aXN0ID0gdG9BcnJheS5zb21lKGlkID0+IHRoaXMuYWN0aXZlLmluZGV4T2YoaWQpID4gLTEpO1xuICAgIGlmICghc29tZUV4aXN0KSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignUmVtb3ZlIEFjdGl2ZScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogQXJyYXkuaXNBcnJheShzdGF0ZS5hY3RpdmUpID8gc3RhdGUuYWN0aXZlLmZpbHRlcihjdXJyZW50SWQgPT4gdG9BcnJheS5pbmRleE9mKGN1cnJlbnRJZCkgPT09IC0xKSA6IG51bGxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlIGFjdGl2ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS50b2dnbGUoMilcbiAgICogc3RvcmUudG9nZ2xlKFszLCA0LCA1XSlcbiAgICovXG4gIEB0cmFuc2FjdGlvbigpXG4gIHRvZ2dsZUFjdGl2ZTxUID0gT3JBcnJheTxJRFR5cGU+PihpZHM6IFQpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBjb25zdCBmaWx0ZXJFeGlzdHMgPSByZW1vdmUgPT4gaWQgPT4gdGhpcy5hY3RpdmUuaW5jbHVkZXMoaWQpID09PSByZW1vdmU7XG4gICAgY29uc3QgcmVtb3ZlID0gdG9BcnJheS5maWx0ZXIoZmlsdGVyRXhpc3RzKHRydWUpKTtcbiAgICBjb25zdCBhZGQgPSB0b0FycmF5LmZpbHRlcihmaWx0ZXJFeGlzdHMoZmFsc2UpKTtcbiAgICB0aGlzLnJlbW92ZUFjdGl2ZShyZW1vdmUpO1xuICAgIHRoaXMuYWRkQWN0aXZlKGFkZCk7XG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1RvZ2dsZSBBY3RpdmUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDcmVhdGUgc3ViIFVJIHN0b3JlIGZvciBtYW5hZ2luZyBFbnRpdHkncyBVSSBzdGF0ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBleHBvcnQgdHlwZSBQcm9kdWN0VUkgPSB7XG4gICAqICAgaXNMb2FkaW5nOiBib29sZWFuO1xuICAgKiAgIGlzT3BlbjogYm9vbGVhblxuICAgKiB9XG4gICAqXG4gICAqIGludGVyZmFjZSBQcm9kdWN0c1VJU3RhdGUgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxQcm9kdWN0VUk+IHt9XG4gICAqXG4gICAqIGV4cG9ydCBjbGFzcyBQcm9kdWN0c1N0b3JlIEVudGl0eVN0b3JlPFByb2R1Y3RzU3RhdGUsIFByb2R1Y3Q+IHtcbiAgICogICB1aTogRW50aXR5VUlTdG9yZTxQcm9kdWN0c1VJU3RhdGUsIFByb2R1Y3RVST47XG4gICAqXG4gICAqICAgY29uc3RydWN0b3IoKSB7XG4gICAqICAgICBzdXBlcigpO1xuICAgKiAgICAgdGhpcy5jcmVhdGVVSVN0b3JlKCk7XG4gICAqICAgfVxuICAgKlxuICAgKiB9XG4gICAqL1xuICBjcmVhdGVVSVN0b3JlKGluaXRpYWxTdGF0ZSA9IHt9LCBzdG9yZUNvbmZpZzogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0ge30pIHtcbiAgICBjb25zdCBkZWZhdWx0czogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0geyBuYW1lOiBgVUkvJHt0aGlzLnN0b3JlTmFtZX1gLCBpZEtleTogdGhpcy5pZEtleSB9O1xuICAgIHRoaXMudWkgPSBuZXcgRW50aXR5VUlTdG9yZShpbml0aWFsU3RhdGUsIHsgLi4uZGVmYXVsdHMsIC4uLnN0b3JlQ29uZmlnIH0pO1xuICAgIHJldHVybiB0aGlzLnVpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGRlc3Ryb3koKSB7XG4gICAgc3VwZXIuZGVzdHJveSgpO1xuICAgIGlmICh0aGlzLnVpIGluc3RhbmNlb2YgRW50aXR5U3RvcmUpIHtcbiAgICAgIHRoaXMudWkuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLmVudGl0eUFjdGlvbnMuY29tcGxldGUoKTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZVVwZGF0ZUVudGl0eShfOiBSZWFkb25seTxFbnRpdHlUeXBlPiwgbmV4dEVudGl0eTogYW55KTogRW50aXR5VHlwZSB7XG4gICAgcmV0dXJuIG5leHRFbnRpdHkgYXMgRW50aXR5VHlwZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZUFkZEVudGl0eShuZXdFbnRpdHk6IGFueSk6IEVudGl0eVR5cGUge1xuICAgIHJldHVybiBuZXdFbnRpdHkgYXMgRW50aXR5VHlwZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZUNoZWNrRW50aXR5KG5ld0VudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pOiBFbnRpdHlUeXBlIHtcbiAgICByZXR1cm4gbmV3RW50aXR5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaWRzKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmlkcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGVudGl0aWVzKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmVudGl0aWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgYWN0aXZlKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmFjdGl2ZTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldEFjdGl2ZShpZHM6IE9yQXJyYXk8SURUeXBlPikge1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBhY3RpdmU6IGlkc1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVUlDcmVhdGlvbihhZGQgPSBmYWxzZSkge1xuICAgIGNvbnN0IGlkcyA9IHRoaXMuaWRzO1xuICAgIGNvbnN0IGlzRnVuYyA9IGlzRnVuY3Rpb24odGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbik7XG4gICAgbGV0IHVpRW50aXRpZXM7XG4gICAgY29uc3QgY3JlYXRlRm4gPSBpZCA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5lbnRpdGllc1tpZF07XG4gICAgICBjb25zdCB1aSA9IGlzRnVuYyA/IHRoaXMudWkuX2FraXRhQ3JlYXRlRW50aXR5Rm4oY3VycmVudCkgOiB0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgW3RoaXMuaWRLZXldOiBjdXJyZW50W3RoaXMuaWRLZXldLFxuICAgICAgICAuLi51aVxuICAgICAgfTtcbiAgICB9O1xuXG4gICAgaWYgKGFkZCkge1xuICAgICAgdWlFbnRpdGllcyA9IHRoaXMuaWRzLmZpbHRlcihpZCA9PiBpc1VuZGVmaW5lZCh0aGlzLnVpLmVudGl0aWVzW2lkXSkpLm1hcChjcmVhdGVGbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVpRW50aXRpZXMgPSBpZHMubWFwKGNyZWF0ZUZuKTtcbiAgICB9XG5cbiAgICBhZGQgPyB0aGlzLnVpLmFkZCh1aUVudGl0aWVzKSA6IHRoaXMudWkuc2V0KHVpRW50aXRpZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNJbml0aWFsVUlTdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNVSVN0b3JlKCkgJiYgaXNVbmRlZmluZWQodGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbikgPT09IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVVSVJlbW92ZShpZHM6IElEVHlwZVtdKSB7XG4gICAgaWYgKHRoaXMuaGFzVUlTdG9yZSgpKSB7XG4gICAgICB0aGlzLnVpLnJlbW92ZShpZHMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzVUlTdG9yZSgpIHtcbiAgICByZXR1cm4gdGhpcy51aSBpbnN0YW5jZW9mIEVudGl0eVVJU3RvcmU7XG4gIH1cbn1cblxuLy8gQGludGVybmFsXG5leHBvcnQgY2xhc3MgRW50aXR5VUlTdG9yZTxVSVN0YXRlLCBERVBSRUNBVEVEID0gYW55PiBleHRlbmRzIEVudGl0eVN0b3JlPFVJU3RhdGU+IHtcbiAgX2FraXRhQ3JlYXRlRW50aXR5Rm46IEVudGl0eVVJQ3JlYXRlRm47XG5cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlID0ge30sIHN0b3JlQ29uZmlnOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIHN1cGVyKGluaXRpYWxTdGF0ZSwgc3RvcmVDb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFNldCB0aGUgaW5pdGlhbCBVSSBlbnRpdHkgc3RhdGUuIFRoaXMgZnVuY3Rpb24gd2lsbCBkZXRlcm1pbmUgdGhlIGVudGl0eSdzXG4gICAqIGluaXRpYWwgc3RhdGUgd2hlbiB3ZSBjYWxsIGBzZXQoKWAgb3IgYGFkZCgpYC5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogY29uc3RydWN0b3IoKSB7XG4gICAqICAgc3VwZXIoKTtcbiAgICogICB0aGlzLmNyZWF0ZVVJU3RvcmUoKS5zZXRJbml0aWFsRW50aXR5U3RhdGUoZW50aXR5ID0+ICh7IGlzTG9hZGluZzogZmFsc2UsIGlzT3BlbjogdHJ1ZSB9KSk7XG4gICAqICAgdGhpcy5jcmVhdGVVSVN0b3JlKCkuc2V0SW5pdGlhbEVudGl0eVN0YXRlKHsgaXNMb2FkaW5nOiBmYWxzZSwgaXNPcGVuOiB0cnVlIH0pO1xuICAgKiB9XG4gICAqXG4gICAqL1xuICBzZXRJbml0aWFsRW50aXR5U3RhdGU8RW50aXR5VUkgPSBhbnksIEVudGl0eSA9IGFueT4oY3JlYXRlRm46IEVudGl0eVVJQ3JlYXRlRm48RW50aXR5VUksIEVudGl0eT4pIHtcbiAgICB0aGlzLl9ha2l0YUNyZWF0ZUVudGl0eUZuID0gY3JlYXRlRm47XG4gIH1cbn1cbiJdfQ==