/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { filter, skip } from 'rxjs/operators';
import { from, isObservable, of, ReplaySubject } from 'rxjs';
import { isFunction } from './isFunction';
import { AkitaError } from './errors';
import { __stores__ } from './stores';
import { getValue } from './getValueByString';
import { setAction } from './actions';
import { setValue } from './setValueByString';
import { $$addStore, $$deleteStore } from './dispatchers';
import { isNil } from './isNil';
import { isObject } from './isObject';
import { isNotBrowser } from './root';
/** @type {?} */
var skipStorageUpdate = false;
/** @type {?} */
var _persistStateInit = new ReplaySubject(1);
/**
 * @return {?}
 */
export function selectPersistStateInit() {
    return _persistStateInit.asObservable();
}
/**
 * @param {?} skip
 * @return {?}
 */
export function setSkipStorageUpdate(skip) {
    skipStorageUpdate = skip;
}
/**
 * @return {?}
 */
export function getSkipStorageUpdate() {
    return skipStorageUpdate;
}
/**
 * @record
 */
export function PersistStateStorage() { }
if (false) {
    /**
     * @param {?} key
     * @return {?}
     */
    PersistStateStorage.prototype.getItem = function (key) { };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    PersistStateStorage.prototype.setItem = function (key, value) { };
    /**
     * @return {?}
     */
    PersistStateStorage.prototype.clear = function () { };
}
/**
 * @param {?} v
 * @return {?}
 */
function isPromise(v) {
    return v && isFunction(v.then);
}
/**
 * @param {?} asyncOrValue
 * @return {?}
 */
function observify(asyncOrValue) {
    if (isPromise(asyncOrValue) || isObservable(asyncOrValue)) {
        return from(asyncOrValue);
    }
    return of(asyncOrValue);
}
/**
 * @record
 */
export function PersistStateParams() { }
if (false) {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Whether to enable persistState in a non-browser environment
     * @type {?}
     */
    PersistStateParams.prototype.enableInNonBrowser;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
    /** @type {?} */
    PersistStateParams.prototype.skipStorageUpdate;
    /** @type {?} */
    PersistStateParams.prototype.preStorageUpdateOperator;
    /**
     * Whether to persist a dynamic store upon destroy
     * @type {?}
     */
    PersistStateParams.prototype.persistOnDestroy;
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStorageUpdate = function (storeName, state) { };
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStoreUpdate = function (storeName, state) { };
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    /** @type {?} */
    var defaults = {
        key: 'AkitaStores',
        enableInNonBrowser: false,
        storage: typeof localStorage === 'undefined' ? params.storage : localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        // @deprecated
        exclude: [],
        persistOnDestroy: false,
        preStorageUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        preStoreUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        skipStorageUpdate: getSkipStorageUpdate,
        preStorageUpdateOperator: (/**
         * @return {?}
         */
        function () { return (/**
         * @param {?} source
         * @return {?}
         */
        function (source) { return source; }); })
    };
    var _a = Object.assign({}, defaults, params), storage = _a.storage, enableInNonBrowser = _a.enableInNonBrowser, deserialize = _a.deserialize, serialize = _a.serialize, include = _a.include, exclude = _a.exclude, key = _a.key, preStorageUpdate = _a.preStorageUpdate, persistOnDestroy = _a.persistOnDestroy, preStorageUpdateOperator = _a.preStorageUpdateOperator, preStoreUpdate = _a.preStoreUpdate, skipStorageUpdate = _a.skipStorageUpdate;
    if (isNotBrowser && !enableInNonBrowser)
        return;
    /** @type {?} */
    var hasInclude = include.length > 0;
    /** @type {?} */
    var hasExclude = exclude.length > 0;
    /** @type {?} */
    var includeStores;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    if (hasInclude) {
        includeStores = include.reduce((/**
         * @param {?} acc
         * @param {?} path
         * @return {?}
         */
        function (acc, path) {
            if (isFunction(path)) {
                acc.fns.push(path);
            }
            else {
                /** @type {?} */
                var storeName = path.split('.')[0];
                acc[storeName] = path;
            }
            return acc;
        }), { fns: [] });
    }
    /** @type {?} */
    var stores = {};
    /** @type {?} */
    var acc = {};
    /** @type {?} */
    var subscriptions = [];
    /** @type {?} */
    var buffer = [];
    /**
     * @param {?} v
     * @return {?}
     */
    function _save(v) {
        observify(v).subscribe((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var next = buffer.shift();
            next && _save(next);
        }));
    }
    // when we use the local/session storage we perform the serialize, otherwise we let the passed storage implementation to do it
    /** @type {?} */
    var isLocalStorage = typeof localStorage !== 'undefined' && (storage === localStorage || storage === sessionStorage);
    observify(storage.getItem(key)).subscribe((/**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        /** @type {?} */
        var storageState = isObject(value) ? value : deserialize(value || '{}');
        /**
         * @param {?} storeCache
         * @return {?}
         */
        function save(storeCache) {
            storageState['$cache'] = tslib_1.__assign({}, (storageState['$cache'] || {}), storeCache);
            storageState = Object.assign({}, storageState, acc);
            buffer.push(storage.setItem(key, isLocalStorage ? serialize(storageState) : storageState));
            _save(buffer.shift());
        }
        /**
         * @param {?} storeName
         * @param {?} path
         * @return {?}
         */
        function subscribe(storeName, path) {
            stores[storeName] = __stores__[storeName]
                ._select((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return getValue(state, path); }))
                .pipe(skip(1), filter((/**
             * @return {?}
             */
            function () { return skipStorageUpdate() === false; })), preStorageUpdateOperator())
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                acc[storeName] = preStorageUpdate(storeName, data);
                Promise.resolve().then((/**
                 * @return {?}
                 */
                function () {
                    var _a;
                    return save((_a = {}, _a[storeName] = __stores__[storeName]._cache().getValue(), _a));
                }));
            }));
        }
        /**
         * @param {?} storeName
         * @param {?} store
         * @param {?} path
         * @return {?}
         */
        function setInitial(storeName, store, path) {
            if (storeName in storageState) {
                setAction('@PersistState');
                store._setState((/**
                 * @param {?} state
                 * @return {?}
                 */
                function (state) {
                    return setValue(state, path, preStoreUpdate(storeName, storageState[storeName]));
                }));
                /** @type {?} */
                var hasCache = storageState['$cache'] ? storageState['$cache'][storeName] : false;
                __stores__[storeName].setHasCache(hasCache, { restartTTL: true });
            }
        }
        subscriptions.push($$deleteStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        function (storeName) {
            var _a;
            if (stores[storeName]) {
                if (persistOnDestroy === false) {
                    save((_a = {}, _a[storeName] = false, _a));
                }
                stores[storeName].unsubscribe();
                delete stores[storeName];
            }
        })));
        subscriptions.push($$addStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        function (storeName) {
            if (hasExclude && exclude.includes(storeName)) {
                return;
            }
            /** @type {?} */
            var store = __stores__[storeName];
            if (hasInclude) {
                /** @type {?} */
                var path = includeStores[storeName];
                if (!path) {
                    /** @type {?} */
                    var passPredicate = includeStores.fns.some((/**
                     * @param {?} fn
                     * @return {?}
                     */
                    function (fn) { return fn(storeName); }));
                    if (passPredicate) {
                        path = storeName;
                    }
                    else {
                        return;
                    }
                }
                setInitial(storeName, store, path);
                subscribe(storeName, path);
            }
            else {
                setInitial(storeName, store, storeName);
                subscribe(storeName, storeName);
            }
        })));
        _persistStateInit.next();
    }));
    return {
        destroy: /**
         * @return {?}
         */
        function () {
            subscriptions.forEach((/**
             * @param {?} s
             * @return {?}
             */
            function (s) { return s.unsubscribe(); }));
            for (var i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                var storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        clear: /**
         * @return {?}
         */
        function () {
            storage.clear();
        },
        clearStore: /**
         * @param {?=} storeName
         * @return {?}
         */
        function (storeName) {
            if (isNil(storeName)) {
                /** @type {?} */
                var value_1 = observify(storage.setItem(key, '{}'));
                value_1.subscribe();
                return;
            }
            /** @type {?} */
            var value = storage.getItem(key);
            observify(value).subscribe((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var storageState = deserialize(v || '{}');
                if (storageState[storeName]) {
                    delete storageState[storeName];
                    /** @type {?} */
                    var value_2 = observify(storage.setItem(key, serialize(storageState)));
                    value_2.subscribe();
                }
            }));
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdFN0YXRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BlcnNpc3RTdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFvQixhQUFhLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBRTdGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQzs7SUFFbEMsaUJBQWlCLEdBQUcsS0FBSzs7SUFFdkIsaUJBQWlCLEdBQUcsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDOzs7O0FBRTlDLE1BQU0sVUFBVSxzQkFBc0I7SUFDcEMsT0FBTyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUMxQyxDQUFDOzs7OztBQUVELE1BQU0sVUFBVSxvQkFBb0IsQ0FBQyxJQUFhO0lBQ2hELGlCQUFpQixHQUFHLElBQUksQ0FBQztBQUMzQixD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LENBQUMsU0FBUyxDQUFDLEVBQUU7O29CQUNkLE9BQUssR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ25ELE9BQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDbEIsT0FBTzthQUNSOztnQkFDSyxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDbEMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVM7Ozs7WUFBQyxVQUFBLENBQUM7O29CQUNwQixZQUFZLEdBQUcsV0FBVyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7Z0JBRTNDLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUMzQixPQUFPLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQzs7d0JBQ3pCLE9BQUssR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ3RFLE9BQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDbkI7WUFDSCxDQUFDLEVBQUMsQ0FBQztRQUNMLENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbHRlciwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGZyb20sIGlzT2JzZXJ2YWJsZSwgb2YsIE9wZXJhdG9yRnVuY3Rpb24sIFJlcGxheVN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSGFzaE1hcCwgTWF5YmVBc3luYyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4vaXNGdW5jdGlvbic7XG5pbXBvcnQgeyBBa2l0YUVycm9yIH0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgX19zdG9yZXNfXyB9IGZyb20gJy4vc3RvcmVzJztcbmltcG9ydCB7IGdldFZhbHVlIH0gZnJvbSAnLi9nZXRWYWx1ZUJ5U3RyaW5nJztcbmltcG9ydCB7IHNldEFjdGlvbiB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBzZXRWYWx1ZSB9IGZyb20gJy4vc2V0VmFsdWVCeVN0cmluZyc7XG5pbXBvcnQgeyAkJGFkZFN0b3JlLCAkJGRlbGV0ZVN0b3JlIH0gZnJvbSAnLi9kaXNwYXRjaGVycyc7XG5pbXBvcnQgeyBpc05pbCB9IGZyb20gJy4vaXNOaWwnO1xuaW1wb3J0IHsgaXNPYmplY3QgfSBmcm9tICcuL2lzT2JqZWN0JztcbmltcG9ydCB7IGlzTm90QnJvd3NlciB9IGZyb20gJy4vcm9vdCc7XG5cbmxldCBza2lwU3RvcmFnZVVwZGF0ZSA9IGZhbHNlO1xuXG5jb25zdCBfcGVyc2lzdFN0YXRlSW5pdCA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0UGVyc2lzdFN0YXRlSW5pdCgpIHtcbiAgcmV0dXJuIF9wZXJzaXN0U3RhdGVJbml0LmFzT2JzZXJ2YWJsZSgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0U2tpcFN0b3JhZ2VVcGRhdGUoc2tpcDogYm9vbGVhbikge1xuICBza2lwU3RvcmFnZVVwZGF0ZSA9IHNraXA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTa2lwU3RvcmFnZVVwZGF0ZSgpIHtcbiAgcmV0dXJuIHNraXBTdG9yYWdlVXBkYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlcnNpc3RTdGF0ZVN0b3JhZ2Uge1xuICBnZXRJdGVtKGtleTogc3RyaW5nKTogTWF5YmVBc3luYztcblxuICBzZXRJdGVtKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogTWF5YmVBc3luYztcblxuICBjbGVhcigpOiB2b2lkO1xufVxuXG5mdW5jdGlvbiBpc1Byb21pc2UodjogYW55KSB7XG4gIHJldHVybiB2ICYmIGlzRnVuY3Rpb24odi50aGVuKTtcbn1cblxuZnVuY3Rpb24gb2JzZXJ2aWZ5KGFzeW5jT3JWYWx1ZTogYW55KSB7XG4gIGlmIChpc1Byb21pc2UoYXN5bmNPclZhbHVlKSB8fCBpc09ic2VydmFibGUoYXN5bmNPclZhbHVlKSkge1xuICAgIHJldHVybiBmcm9tKGFzeW5jT3JWYWx1ZSk7XG4gIH1cblxuICByZXR1cm4gb2YoYXN5bmNPclZhbHVlKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZXJzaXN0U3RhdGVQYXJhbXMge1xuICAvKiogVGhlIHN0b3JhZ2Uga2V5ICovXG4gIGtleTogc3RyaW5nO1xuICAvKiogV2hldGhlciB0byBlbmFibGUgcGVyc2lzdFN0YXRlIGluIGEgbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQgKi9cbiAgZW5hYmxlSW5Ob25Ccm93c2VyOiBib29sZWFuO1xuICAvKiogU3RvcmFnZSBzdHJhdGVneSB0byB1c2UuIFRoaXMgZGVmYXVsdHMgdG8gTG9jYWxTdG9yYWdlIGJ1dCB5b3UgY2FuIHBhc3MgU2Vzc2lvblN0b3JhZ2Ugb3IgYW55dGhpbmcgdGhhdCBpbXBsZW1lbnRzIHRoZSBTdG9yYWdlRW5naW5lIEFQSS4gKi9cbiAgc3RvcmFnZTogUGVyc2lzdFN0YXRlU3RvcmFnZTtcbiAgLyoqIEN1c3RvbSBkZXNlcmlhbGl6ZXIuIERlZmF1bHRzIHRvIEpTT04ucGFyc2UgKi9cbiAgZGVzZXJpYWxpemU6IEZ1bmN0aW9uO1xuICAvKiogQ3VzdG9tIHNlcmlhbGl6ZXIsIGRlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5ICovXG4gIHNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBpbmNsdWRlIG9ubHkgdGhlIHN0b3JlcyB5b3UgbmVlZC5cbiAgICogUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBpbmNsdWRlOiAoc3RyaW5nIHwgKChzdG9yZU5hbWU6IHN0cmluZykgPT4gYm9vbGVhbikpW107XG4gIC8qKlxuICAgKiAgQnkgZGVmYXVsdCB0aGUgd2hvbGUgc3RhdGUgaXMgc2F2ZWQgdG8gc3RvcmFnZSwgdXNlIHRoaXMgcGFyYW0gdG8gZXhjbHVkZSBzdG9yZXMgdGhhdCB5b3UgZG9uJ3QgbmVlZC5cbiAgICogIFBheSBhdHRlbnRpb24gdGhhdCB5b3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVxuICAgKi9cbiAgZXhjbHVkZTogc3RyaW5nW107XG5cbiAgcHJlU3RvcmFnZVVwZGF0ZShzdG9yZU5hbWU6IHN0cmluZywgc3RhdGU6IGFueSk6IGFueTtcblxuICBwcmVTdG9yZVVwZGF0ZShzdG9yZU5hbWU6IHN0cmluZywgc3RhdGU6IGFueSk6IGFueTtcblxuICBza2lwU3RvcmFnZVVwZGF0ZTogKCkgPT4gYm9vbGVhbjtcbiAgcHJlU3RvcmFnZVVwZGF0ZU9wZXJhdG9yOiAoKSA9PiBPcGVyYXRvckZ1bmN0aW9uPGFueSwgYW55PjtcbiAgLyoqIFdoZXRoZXIgdG8gcGVyc2lzdCBhIGR5bmFtaWMgc3RvcmUgdXBvbiBkZXN0cm95ICovXG4gIHBlcnNpc3RPbkRlc3Ryb3k6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJzaXN0U3RhdGUocGFyYW1zPzogUGFydGlhbDxQZXJzaXN0U3RhdGVQYXJhbXM+KSB7XG4gIGNvbnN0IGRlZmF1bHRzOiBQZXJzaXN0U3RhdGVQYXJhbXMgPSB7XG4gICAga2V5OiAnQWtpdGFTdG9yZXMnLFxuICAgIGVuYWJsZUluTm9uQnJvd3NlcjogZmFsc2UsXG4gICAgc3RvcmFnZTogdHlwZW9mIGxvY2FsU3RvcmFnZSA9PT0gJ3VuZGVmaW5lZCcgPyBwYXJhbXMuc3RvcmFnZSA6IGxvY2FsU3RvcmFnZSxcbiAgICBkZXNlcmlhbGl6ZTogSlNPTi5wYXJzZSxcbiAgICBzZXJpYWxpemU6IEpTT04uc3RyaW5naWZ5LFxuICAgIGluY2x1ZGU6IFtdLFxuICAgIC8vIEBkZXByZWNhdGVkXG4gICAgZXhjbHVkZTogW10sXG4gICAgcGVyc2lzdE9uRGVzdHJveTogZmFsc2UsXG4gICAgcHJlU3RvcmFnZVVwZGF0ZTogZnVuY3Rpb24oc3RvcmVOYW1lLCBzdGF0ZSkge1xuICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH0sXG4gICAgcHJlU3RvcmVVcGRhdGU6IGZ1bmN0aW9uKHN0b3JlTmFtZSwgc3RhdGUpIHtcbiAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9LFxuICAgIHNraXBTdG9yYWdlVXBkYXRlOiBnZXRTa2lwU3RvcmFnZVVwZGF0ZSxcbiAgICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3I6ICgpID0+IHNvdXJjZSA9PiBzb3VyY2VcbiAgfTtcblxuICBjb25zdCB7IHN0b3JhZ2UsIGVuYWJsZUluTm9uQnJvd3NlciwgZGVzZXJpYWxpemUsIHNlcmlhbGl6ZSwgaW5jbHVkZSwgZXhjbHVkZSwga2V5LCBwcmVTdG9yYWdlVXBkYXRlLCBwZXJzaXN0T25EZXN0cm95LCBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3IsIHByZVN0b3JlVXBkYXRlLCBza2lwU3RvcmFnZVVwZGF0ZSB9ID0gT2JqZWN0LmFzc2lnbihcbiAgICB7fSxcbiAgICBkZWZhdWx0cyxcbiAgICBwYXJhbXNcbiAgKTtcblxuICBpZiAoaXNOb3RCcm93c2VyICYmICFlbmFibGVJbk5vbkJyb3dzZXIpIHJldHVybjtcblxuICBjb25zdCBoYXNJbmNsdWRlID0gaW5jbHVkZS5sZW5ndGggPiAwO1xuICBjb25zdCBoYXNFeGNsdWRlID0gZXhjbHVkZS5sZW5ndGggPiAwO1xuICBsZXQgaW5jbHVkZVN0b3JlczogeyBmbnM6IEZ1bmN0aW9uW107IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uW10gfCBzdHJpbmcgfTtcblxuICBpZiAoaGFzSW5jbHVkZSAmJiBoYXNFeGNsdWRlKSB7XG4gICAgdGhyb3cgbmV3IEFraXRhRXJyb3IoXCJZb3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVwiKTtcbiAgfVxuXG4gIGlmIChoYXNJbmNsdWRlKSB7XG4gICAgaW5jbHVkZVN0b3JlcyA9IGluY2x1ZGUucmVkdWNlKFxuICAgICAgKGFjYywgcGF0aCkgPT4ge1xuICAgICAgICBpZiAoaXNGdW5jdGlvbihwYXRoKSkge1xuICAgICAgICAgIGFjYy5mbnMucHVzaChwYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBzdG9yZU5hbWUgPSBwYXRoLnNwbGl0KCcuJylbMF07XG4gICAgICAgICAgYWNjW3N0b3JlTmFtZV0gPSBwYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAgeyBmbnM6IFtdIH1cbiAgICApO1xuICB9XG5cbiAgbGV0IHN0b3JlczogSGFzaE1hcDxTdWJzY3JpcHRpb24+ID0ge307XG4gIGxldCBhY2MgPSB7fTtcbiAgbGV0IHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgY29uc3QgYnVmZmVyID0gW107XG5cbiAgZnVuY3Rpb24gX3NhdmUodjogYW55KSB7XG4gICAgb2JzZXJ2aWZ5KHYpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBjb25zdCBuZXh0ID0gYnVmZmVyLnNoaWZ0KCk7XG4gICAgICBuZXh0ICYmIF9zYXZlKG5leHQpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gd2hlbiB3ZSB1c2UgdGhlIGxvY2FsL3Nlc3Npb24gc3RvcmFnZSB3ZSBwZXJmb3JtIHRoZSBzZXJpYWxpemUsIG90aGVyd2lzZSB3ZSBsZXQgdGhlIHBhc3NlZCBzdG9yYWdlIGltcGxlbWVudGF0aW9uIHRvIGRvIGl0XG4gIGNvbnN0IGlzTG9jYWxTdG9yYWdlID0gdHlwZW9mIGxvY2FsU3RvcmFnZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHN0b3JhZ2UgPT09IGxvY2FsU3RvcmFnZSB8fCBzdG9yYWdlID09PSBzZXNzaW9uU3RvcmFnZSk7XG5cbiAgb2JzZXJ2aWZ5KHN0b3JhZ2UuZ2V0SXRlbShrZXkpKS5zdWJzY3JpYmUoKHZhbHVlOiBhbnkpID0+IHtcbiAgICBsZXQgc3RvcmFnZVN0YXRlID0gaXNPYmplY3QodmFsdWUpID8gdmFsdWUgOiBkZXNlcmlhbGl6ZSh2YWx1ZSB8fCAne30nKTtcblxuICAgIGZ1bmN0aW9uIHNhdmUoc3RvcmVDYWNoZSkge1xuICAgICAgc3RvcmFnZVN0YXRlWyckY2FjaGUnXSA9IHsgLi4uKHN0b3JhZ2VTdGF0ZVsnJGNhY2hlJ10gfHwge30pLCAuLi5zdG9yZUNhY2hlIH07XG4gICAgICBzdG9yYWdlU3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdG9yYWdlU3RhdGUsIGFjYyk7XG5cbiAgICAgIGJ1ZmZlci5wdXNoKHN0b3JhZ2Uuc2V0SXRlbShrZXksIGlzTG9jYWxTdG9yYWdlID8gc2VyaWFsaXplKHN0b3JhZ2VTdGF0ZSkgOiBzdG9yYWdlU3RhdGUpKTtcbiAgICAgIF9zYXZlKGJ1ZmZlci5zaGlmdCgpKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzdWJzY3JpYmUoc3RvcmVOYW1lLCBwYXRoKSB7XG4gICAgICBzdG9yZXNbc3RvcmVOYW1lXSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXVxuICAgICAgICAuX3NlbGVjdChzdGF0ZSA9PiBnZXRWYWx1ZShzdGF0ZSwgcGF0aCkpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHNraXAoMSksXG4gICAgICAgICAgZmlsdGVyKCgpID0+IHNraXBTdG9yYWdlVXBkYXRlKCkgPT09IGZhbHNlKSxcbiAgICAgICAgICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3IoKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgICAgYWNjW3N0b3JlTmFtZV0gPSBwcmVTdG9yYWdlVXBkYXRlKHN0b3JlTmFtZSwgZGF0YSk7XG4gICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBzYXZlKHsgW3N0b3JlTmFtZV06IF9fc3RvcmVzX19bc3RvcmVOYW1lXS5fY2FjaGUoKS5nZXRWYWx1ZSgpIH0pKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2V0SW5pdGlhbChzdG9yZU5hbWUsIHN0b3JlLCBwYXRoKSB7XG4gICAgICBpZiAoc3RvcmVOYW1lIGluIHN0b3JhZ2VTdGF0ZSkge1xuICAgICAgICBzZXRBY3Rpb24oJ0BQZXJzaXN0U3RhdGUnKTtcbiAgICAgICAgc3RvcmUuX3NldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgICAgICByZXR1cm4gc2V0VmFsdWUoc3RhdGUsIHBhdGgsIHByZVN0b3JlVXBkYXRlKHN0b3JlTmFtZSwgc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGhhc0NhY2hlID0gc3RvcmFnZVN0YXRlWyckY2FjaGUnXSA/IHN0b3JhZ2VTdGF0ZVsnJGNhY2hlJ11bc3RvcmVOYW1lXSA6IGZhbHNlO1xuICAgICAgICBfX3N0b3Jlc19fW3N0b3JlTmFtZV0uc2V0SGFzQ2FjaGUoaGFzQ2FjaGUsIHsgcmVzdGFydFRUTDogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBzdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAkJGRlbGV0ZVN0b3JlLnN1YnNjcmliZShzdG9yZU5hbWUgPT4ge1xuICAgICAgICBpZiAoc3RvcmVzW3N0b3JlTmFtZV0pIHtcbiAgICAgICAgICBpZiAocGVyc2lzdE9uRGVzdHJveSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHNhdmUoeyBbc3RvcmVOYW1lXTogZmFsc2UgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgZGVsZXRlIHN0b3Jlc1tzdG9yZU5hbWVdO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBzdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAkJGFkZFN0b3JlLnN1YnNjcmliZShzdG9yZU5hbWUgPT4ge1xuICAgICAgICBpZiAoaGFzRXhjbHVkZSAmJiBleGNsdWRlLmluY2x1ZGVzKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdG9yZSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXTtcbiAgICAgICAgaWYgKGhhc0luY2x1ZGUpIHtcbiAgICAgICAgICBsZXQgcGF0aCA9IGluY2x1ZGVTdG9yZXNbc3RvcmVOYW1lXTtcblxuICAgICAgICAgIGlmICghcGF0aCkge1xuICAgICAgICAgICAgY29uc3QgcGFzc1ByZWRpY2F0ZSA9IGluY2x1ZGVTdG9yZXMuZm5zLnNvbWUoZm4gPT4gZm4oc3RvcmVOYW1lKSk7XG4gICAgICAgICAgICBpZiAocGFzc1ByZWRpY2F0ZSkge1xuICAgICAgICAgICAgICBwYXRoID0gc3RvcmVOYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpO1xuICAgICAgICAgIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNldEluaXRpYWwoc3RvcmVOYW1lLCBzdG9yZSwgc3RvcmVOYW1lKTtcbiAgICAgICAgICBzdWJzY3JpYmUoc3RvcmVOYW1lLCBzdG9yZU5hbWUpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBfcGVyc2lzdFN0YXRlSW5pdC5uZXh0KCk7XG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgZGVzdHJveSgpIHtcbiAgICAgIHN1YnNjcmlwdGlvbnMuZm9yRWFjaChzID0+IHMudW5zdWJzY3JpYmUoKSk7XG4gICAgICBmb3IgKGxldCBpID0gMCwga2V5cyA9IE9iamVjdC5rZXlzKHN0b3Jlcyk7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN0b3JlTmFtZSA9IGtleXNbaV07XG4gICAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgICBzdG9yZXMgPSB7fTtcbiAgICB9LFxuICAgIGNsZWFyKCkge1xuICAgICAgc3RvcmFnZS5jbGVhcigpO1xuICAgIH0sXG4gICAgY2xlYXJTdG9yZShzdG9yZU5hbWU/OiBzdHJpbmcpIHtcbiAgICAgIGlmIChpc05pbChzdG9yZU5hbWUpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JzZXJ2aWZ5KHN0b3JhZ2Uuc2V0SXRlbShrZXksICd7fScpKTtcbiAgICAgICAgdmFsdWUuc3Vic2NyaWJlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlID0gc3RvcmFnZS5nZXRJdGVtKGtleSk7XG4gICAgICBvYnNlcnZpZnkodmFsdWUpLnN1YnNjcmliZSh2ID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmFnZVN0YXRlID0gZGVzZXJpYWxpemUodiB8fCAne30nKTtcblxuICAgICAgICBpZiAoc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pIHtcbiAgICAgICAgICBkZWxldGUgc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV07XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBvYnNlcnZpZnkoc3RvcmFnZS5zZXRJdGVtKGtleSwgc2VyaWFsaXplKHN0b3JhZ2VTdGF0ZSkpKTtcbiAgICAgICAgICB2YWx1ZS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuIl19