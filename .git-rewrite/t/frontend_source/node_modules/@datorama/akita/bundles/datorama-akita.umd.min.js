!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@datorama/akita",["exports","rxjs","rxjs/operators"],e):e((t.datorama=t.datorama||{},t.datorama.akita={}),t.rxjs,t.rxjs.operators)}(this,function(i,s,O){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function t(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var w=function(){return(w=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function e(t,e,i,r){var n,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;0<=a;a--)(n=t[a])&&(s=(o<3?n(s):3<o?n(e,i,s):n(e,i))||s);return 3<o&&s&&Object.defineProperty(e,i,s),s}function n(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function j(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}}function x(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)s.push(r.value)}catch(a){n={error:a}}finally{try{r&&!r.done&&(i=o["return"])&&i.call(o)}finally{if(n)throw n.error}}return s}function m(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(x(arguments[e]));return t}function p(t){return Array.isArray(t)}function h(t){return!!p(t)&&0===t.length}function f(t,e,i){var r,n,o={entities:{},ids:[]};try{for(var s=j(t),a=s.next();!a.done;a=s.next()){var u=i(a.value);o.entities[u[e]]=u,o.ids.push(u[e])}}catch(c){r={error:c}}finally{try{a&&!a.done&&(n=s["return"])&&n.call(s)}finally{if(r)throw r.error}}return o}function I(t,e){return t.hasOwnProperty(e)}function l(t){return t.hasOwnProperty("active")}function o(t){return p(t)}function y(t){var e=t.active,i=t.ids,r=t.entities;return o(e)?a(e,i):!1===I(r,e)?null:e}function a(t,e){var i=t.filter(function(t){return-1<e.indexOf(t)});return i.length===t.length?t:i}function d(t){return t.entities&&t.ids}function v(t,e){var i,r,n={};try{for(var o=j(Object.keys(t)),s=o.next();!s.done;s=o.next()){var a=s.value;n[a]=e(t[a])}}catch(u){i={error:u}}finally{try{s&&!s.done&&(r=o["return"])&&r.call(o)}finally{if(i)throw i.error}}return n}function u(t){var e,i,r=t.state,n=t.entities,o=t.idKey,s=t.preAddEntity,a=t.isNativePreAdd;if(p(n)){var u=f(n,o,s);e=u.entities,i=u.ids}else i=d(n)?(e=a?n.entities:v(n.entities,s),n.ids):(e=a?n:v(n,s),Object.keys(e).map(function(t){return isNaN(t)?t:Number(t)}));var c=w({},r,{entities:e,ids:i,loading:!1});return l(r)&&(c.active=y(c)),c}var g={type:null,entityIds:null,skip:!1},c=!1;function b(){c=!1}function S(t,e){C(t,e),c=!0}function C(t,e){!1===c&&(g.type=t,g.entityIds=e)}function P(t){void 0===t&&(t=!0),g.skip=t}function E(n,o){return function(t,e,i){var r=i.value;return i.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return S(n,o),r.apply(this,t)},i}}var _={resettable:!1,ttl:null};function A(){return _}function k(e){Object.freeze(e);var i="function"==typeof e,r=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(e).forEach(function(t){!r.call(e,t)||i&&("caller"===t||"callee"===t||"arguments"===t)||null===e[t]||"object"!=typeof e[t]&&"function"!=typeof e[t]||Object.isFrozen(e[t])||k(e[t])}),e}var U=new s.Subject,F=new s.ReplaySubject(50,5e3),N=new s.Subject;function V(t){U.next(t)}function D(t){F.next(t)}function K(t){N.next(t)}function R(){return i.__DEV__}i.__DEV__=!0;var B,H=(t(M,B=Error),M);function M(t){return B.call(this,t)||this}function $(t){return null===t||t===undefined}function L(t){return!1===$(t)}function Q(t){return"function"==typeof t}function q(t){return null!=t&&""+t!="false"}function z(t){return q(t)&&"Object"===t.constructor.name}var J="undefined"!=typeof window,W=!J,X=("undefined"!=typeof global&&global.__runtimeVersion,"akitaConfig");var Y={},G={};J&&R()&&(window.$$stores=Y,window.$$queries=G);var Z=new s.Subject,tt=new s.BehaviorSubject(!1),et={activeTransactions:0,batchTransaction:null};function it(){nt()||(et.batchTransaction=new s.Subject),et.activeTransactions++,tt.next(!0)}function rt(){0==--et.activeTransactions&&(et.batchTransaction.next(!0),et.batchTransaction.complete(),tt.next(!1),Z.next(!0))}function nt(){return 0<et.activeTransactions}function ot(){return et.batchTransaction?et.batchTransaction.asObservable():s.of(!0)}function st(t,e){void 0===e&&(e=undefined),it();try{return t.apply(e)}finally{S("@Transaction"),rt()}}function at(){return function(t,e,i){var r=i.value;return i.value=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return st(function(){return r.apply(t,e)},this)},i}}var ut=(ct.prototype.setLoading=function(e){void 0===e&&(e=!1),e!==this._value().loading&&(R()&&C("Set Loading"),this._setState(function(t){return w({},t,{loading:e})}))},ct.prototype.setHasCache=function(t,e){var i=this;if(void 0===e&&(e={restartTTL:!1}),t!==this.cache.active.value&&this.cache.active.next(t),e.restartTTL){var r=this.getCacheTTL();r&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout(function(){return i.setHasCache(!1)},r))}},ct.prototype.getValue=function(){return this.storeValue},ct.prototype.setError=function(e){e!==this._value().error&&(R()&&C("Set Error"),this._setState(function(t){return w({},t,{error:e})}))},ct.prototype._select=function(t){return this.store.asObservable().pipe(O.map(t),O.distinctUntilChanged())},ct.prototype._value=function(){return this.storeValue},ct.prototype._cache=function(){return this.cache.active},Object.defineProperty(ct.prototype,"config",{get:function(){return this.constructor[X]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(ct.prototype,"storeName",{get:function(){return this.config.storeName||this.options.storeName||this.options.name},enumerable:!0,configurable:!0}),Object.defineProperty(ct.prototype,"deepFreeze",{get:function(){return this.config.deepFreezeFn||this.options.deepFreezeFn||k},enumerable:!0,configurable:!0}),Object.defineProperty(ct.prototype,"cacheConfig",{get:function(){return this.config.cache||this.options.cache},enumerable:!0,configurable:!0}),Object.defineProperty(ct.prototype,"resettable",{get:function(){return L(this.config.resettable)?this.config.resettable:this.options.resettable},enumerable:!0,configurable:!0}),ct.prototype._setState=function(t,e){void 0===e&&(e=!0),this.storeValue=i.__DEV__?this.deepFreeze(t(this._value())):t(this._value()),this.store?nt()?this.handleTransaction():this.dispatch(this.storeValue,e):this.store=new s.BehaviorSubject(this.storeValue)},ct.prototype.reset=function(){var t=this;this.isResettable()?(R()&&C("Reset"),this._setState(function(){return Object.assign({},t._initialState)}),this.setHasCache(!1)):R()&&console.warn("You need to enable the reset functionality")},ct.prototype.update=function(r){var n=this;R()&&C("Update"),this._setState(function(t){var e=Q(r)?r(t):r,i=n.akitaPreUpdate(t,w({},t,e));return z(t)?i:new t.constructor(i)})},ct.prototype.updateStoreConfig=function(t){this.options=w({},this.options,t)},ct.prototype.akitaPreUpdate=function(t,e){return e},ct.prototype.ngOnDestroy=function(){this.destroy()},ct.prototype.destroy=function(){J&&window.hmrEnabled||this!==Y[this.storeName]||(delete Y[this.storeName],V(this.storeName),this.setHasCache(!1),this.cache.active.complete())},ct.prototype.onInit=function(t){(Y[this.storeName]=this)._setState(function(){return t}),D(this.storeName),this.isResettable()&&(this._initialState=t),R()&&function i(t,e){t||console.error("@StoreConfig({ name }) is missing in "+e)}(this.storeName,this.constructor.name)},ct.prototype.dispatch=function(t,e){void 0===e&&(e=!0),this.store.next(t),e&&(K(this.storeName),b())},ct.prototype.watchTransaction=function(){var t=this;ot().subscribe(function(){t.inTransaction=!1,t.dispatch(t._value())})},ct.prototype.isResettable=function(){return!1!==this.resettable&&(this.resettable||A().resettable)},ct.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},ct.prototype.getCacheTTL=function(){return this.cacheConfig&&this.cacheConfig.ttl||A().ttl},ct);function ct(t,e){void 0===e&&(e={}),this.options=e,this.inTransaction=!1,this.cache={active:new s.BehaviorSubject(!1),ttl:null},this.onInit(t)}function pt(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function ht(t,e,i){var r;if(p(t))r=t;else if(pt(t)){if($(i))return;t=Object.assign({wrap:!0},t);var n=e.indexOf(i);if(t.prev){var o=0===n;if(o&&!t.wrap)return;r=o?e[e.length-1]:e[n-1]}else if(t.next){var s=e.length===n+1;if(s&&!t.wrap)return;r=s?e[0]:e[n+1]}}else{if(t===i)return;r=t}return r}function ft(t){var e,i,r=t.state,n=t.entities,o=t.idKey,s=t.options,a=void 0===s?{}:s,u=t.preAddEntity,c={},p=[],h=!1;try{for(var f=j(n),l=f.next();!l.done;l=f.next()){var y=l.value;if(!1===I(r.entities,y[o])){var d=u(y),v=d[o];c[v]=d,a.prepend?p.unshift(v):p.push(v),h=!0}}}catch(g){e={error:g}}finally{try{l&&!l.done&&(i=f["return"])&&i.call(f)}finally{if(e)throw e.error}}return h?{newState:w({},r,{entities:w({},r.entities,c),ids:a.prepend?m(p,r.ids):m(r.ids,p)}),newIds:p}:null}function lt(t){return $(t)?[]:Array.isArray(t)?t:[t]}function yt(t){var e,i,r=t.state,n=t.ids;if($(n))return dt(r);var o=r.entities,s={};try{for(var a=j(r.ids),u=a.next();!u.done;u=a.next()){var c=u.value;!1===n.includes(c)&&(s[c]=o[c])}}catch(h){e={error:h}}finally{try{u&&!u.done&&(i=a["return"])&&i.call(a)}finally{if(e)throw e.error}}var p=w({},r,{entities:s,ids:r.ids.filter(function(t){return!1===n.includes(t)})});return l(r)&&(p.active=y(p)),p}function dt(t){return w({},t,{entities:{},ids:[],active:o(t.active)?[]:null})}function vt(){return{entities:{},ids:[],loading:!0,error:null}}function gt(t){var e,i,r,n=t.state,o=t.ids,s=t.idKey,a=t.newStateOrFn,u=t.preUpdateEntity,c={},p=!1;try{for(var h=j(o),f=h.next();!f.done;f=h.next()){var l=f.value;if(!1!==I(n.entities,l)){var y=n.entities[l],d=Q(a)?a(y):a,v=d.hasOwnProperty(s)&&d[s]!==y[s],g=void 0;r=l,v&&(p=!0,r=d[s]);var b=w({},y,d);g=z(y)?b:z(d)?new y.constructor(b):new d.constructor(b),c[r]=u(y,g)}}}catch(A){e={error:A}}finally{try{f&&!f.done&&(i=h["return"])&&i.call(h)}finally{if(e)throw e.error}}var m=n.ids,S=n.entities;if(p){var P=x(o,1)[0],E=n.entities,_=P;E[_];S=function O(t,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)e.indexOf(r[n])<0&&(i[r[n]]=t[r[n]])}return i}(E,["symbol"==typeof _?_:_+""]),m=n.ids.map(function(t){return t===P?r:t})}return w({},n,{entities:w({},S,c),ids:m})}function bt(t){return t===undefined}var mt={Set:0,Add:1,Update:2,Remove:3};mt[mt.Set]="Set",mt[mt.Add]="Add",mt[mt.Update]="Update",mt[mt.Remove]="Remove";var St,Pt,Et="id",_t=(t(At,St=ut),Object.defineProperty(At.prototype,"selectEntityAction$",{get:function(){return this.entityActions.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"idKey",{get:function(){return this.config.idKey||this.options.idKey||Et},enumerable:!0,configurable:!0}),At.prototype.set=function(e){var i=this;if(!$(e)){R()&&C("Set Entity");var r=this.akitaPreAddEntity===At.prototype.akitaPreAddEntity;this._setState(function(t){return u({state:t,entities:e,idKey:i.idKey,preAddEntity:i.akitaPreAddEntity,isNativePreAdd:r})}),this.setHasCache(!0,{restartTTL:!0}),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:mt.Set,ids:this.ids})}},At.prototype.add=function(t,e){void 0===e&&(e={loading:!1});var i=lt(t);if(!h(i)){var r=ft({state:this._value(),preAddEntity:this.akitaPreAddEntity,entities:i,idKey:this.idKey,options:e});r&&(R()&&C("Add Entity"),r.newState.loading=e.loading,this._setState(function(){return r.newState}),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:mt.Add,ids:r.newIds}))}},At.prototype.update=function(e,i){var r=this;if(bt(i))St.prototype.update.call(this,e);else{var n=[];h(n=Q(e)?this.ids.filter(function(t){return e(r.entities[t])}):$(e)?this.ids:lt(e))||(R()&&C("Update Entity",n),this._setState(function(t){return gt({idKey:r.idKey,ids:n,preUpdateEntity:r.akitaPreUpdateEntity,state:t,newStateOrFn:i})}),this.entityActions.next({type:mt.Update,ids:n}))}},At.prototype.upsert=function(t,n,o){var s=this;function e(e){return function(t){return I(s.entities,t)===e}}void 0===o&&(o={});var i=lt(t),a=Q(o.baseClass),r=i.filter(e(!0)),u=i.filter(e(!1)).map(function(t){var e,i=Q(n)?n({}):n,r=w({},i,((e={})[s.idKey]=t,e));return a?new o.baseClass(r):r});this.update(r,n),this.add(u),R()&&S("Upsert Entity")},At.prototype.upsertMany=function(t,e){var i,r;void 0===e&&(e={});var n=[],o=[],s={};try{for(var a=j(t),u=a.next();!u.done;u=a.next()){var c=u.value,p=this.akitaPreCheckEntity(c),h=p[this.idKey];if(I(this.entities,h)){var f=this._value().entities[h],l=w({},this._value().entities[h],p),y=e.baseClass?new e.baseClass(l):l,d=(v=this.akitaPreUpdateEntity(f,y))[this.idKey];s[d]=v,o.push(d)}else{var v,g=e.baseClass?new e.baseClass(p):p;d=(v=this.akitaPreAddEntity(g))[this.idKey],n.push(d),s[d]=v}}}catch(b){i={error:b}}finally{try{u&&!u.done&&(r=a["return"])&&r.call(a)}finally{if(i)throw i.error}}R()&&S("Upsert Many"),this._setState(function(t){return w({},t,{ids:n.length?m(t.ids,n):t.ids,entities:w({},t.entities,s),loading:!!e.loading})}),o.length&&this.entityActions.next({type:mt.Update,ids:o}),n.length&&this.entityActions.next({type:mt.Add,ids:n}),n.length&&this.hasUIStore()&&this.handleUICreation(!0)},At.prototype.replace=function(t,e){var i,r,n=lt(t);if(!h(n)){var o={};try{for(var s=j(n),a=s.next();!a.done;a=s.next()){var u=a.value;e[this.idKey]=u,o[u]=e}}catch(c){i={error:c}}finally{try{a&&!a.done&&(r=s["return"])&&r.call(s)}finally{if(i)throw i.error}}R()&&C("Replace Entity",t),this._setState(function(t){return w({},t,{entities:w({},t.entities,o)})})}},At.prototype.move=function(t,e){var i=this.ids.slice();i.splice(e<0?i.length+e:e,0,i.splice(t,1)[0]),R()&&C("Move Entity"),this._setState(function(t){return w({},t,{entities:w({},t.entities),ids:i})})},At.prototype.remove=function(e){var i=this;if(!h(this.ids)){var t=L(e),r=[];h(r=Q(e)?this.ids.filter(function(t){return e(i.entities[t])}):t?lt(e):null)||(R()&&C("Remove Entity",r),this._setState(function(t){return yt({state:t,ids:r})}),null===r&&this.setHasCache(!1),this.handleUIRemove(r),this.entityActions.next({type:mt.Remove,ids:r}))}},At.prototype.updateActive=function(t){var e=lt(this.active);R()&&C("Update Active",e),this.update(e,t)},At.prototype.setActive=function(t){var e=ht(t,this.ids,this.active);e!==undefined&&(R()&&C("Set Active",e),this._setActive(e))},At.prototype.addActive=function(t){var e=this,i=lt(t);h(i)||i.every(function(t){return-1<e.active.indexOf(t)})||(R()&&C("Add Active",t),this._setState(function(t){var e=Array.from(new Set(m(t.active,i)));return w({},t,{active:e})}))},At.prototype.removeActive=function(t){var e=this,i=lt(t);h(i)||i.some(function(t){return-1<e.active.indexOf(t)})&&(R()&&C("Remove Active",t),this._setState(function(t){return w({},t,{active:Array.isArray(t.active)?t.active.filter(function(t){return-1===i.indexOf(t)}):null})}))},At.prototype.toggleActive=function(t){function e(e){return function(t){return i.active.includes(t)===e}}var i=this,r=lt(t),n=r.filter(e(!0)),o=r.filter(e(!1));this.removeActive(n),this.addActive(o),R()&&S("Toggle Active")},At.prototype.createUIStore=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var i={name:"UI/"+this.storeName,idKey:this.idKey};return this.ui=new wt(t,w({},i,e)),this.ui},At.prototype.destroy=function(){St.prototype.destroy.call(this),this.ui instanceof At&&this.ui.destroy(),this.entityActions.complete()},At.prototype.akitaPreUpdateEntity=function(t,e){return e},At.prototype.akitaPreAddEntity=function(t){return t},At.prototype.akitaPreCheckEntity=function(t){return t},Object.defineProperty(At.prototype,"ids",{get:function(){return this._value().ids},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"entities",{get:function(){return this._value().entities},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"active",{get:function(){return this._value().active},enumerable:!0,configurable:!0}),At.prototype._setActive=function(e){this._setState(function(t){return w({},t,{active:e})})},At.prototype.handleUICreation=function(t){var n=this;function e(t){var e,i=n.entities[t],r=o?n.ui._akitaCreateEntityFn(i):n.ui._akitaCreateEntityFn;return w(((e={})[n.idKey]=i[n.idKey],e),r)}void 0===t&&(t=!1);var i,r=this.ids,o=Q(this.ui._akitaCreateEntityFn);i=t?this.ids.filter(function(t){return bt(n.ui.entities[t])}).map(e):r.map(e),t?this.ui.add(i):this.ui.set(i)},At.prototype.hasInitialUIState=function(){return this.hasUIStore()&&!1===bt(this.ui._akitaCreateEntityFn)},At.prototype.handleUIRemove=function(t){this.hasUIStore()&&this.ui.remove(t)},At.prototype.hasUIStore=function(){return this.ui instanceof wt},e([at(),n("design:type",Function),n("design:paramtypes",[Object,Object,Object]),n("design:returntype",void 0)],At.prototype,"upsert",null),e([at(),n("design:type",Function),n("design:paramtypes",["function"==typeof(Pt="undefined"!=typeof T&&T)?Pt:Object]),n("design:returntype",void 0)],At.prototype,"toggleActive",null),At);function At(t,e){void 0===t&&(t={}),void 0===e&&(e={});var i=St.call(this,w({},{entities:{},ids:[],loading:!0,error:null},t),e)||this;return i.options=e,i.entityActions=new s.Subject,i}var Ot,wt=(t(jt,Ot=_t),jt.prototype.setInitialEntityState=function(t){this._akitaCreateEntityFn=t},jt);function jt(t,e){return void 0===t&&(t={}),void 0===e&&(e={}),Ot.call(this,t,e)||this}var xt="akitaQueryConfig";function It(t){return"string"==typeof t}var Ct=(kt.prototype.select=function(e){var t;if(Q(e))t=e;else if(It(e))t=function(t){return t[e]};else{if(Array.isArray(e))return this.store._select(function(t){return t}).pipe(O.distinctUntilChanged(function i(t){return function(e,i){var r=Q(t[0]);return!1===t.some(function(t){return r?t(e)!==t(i):e[t]!==i[t]})}}(e)),O.map(function(i){return Q(e[0])?e.map(function(t){return t(i)}):e.reduce(function(t,e){return t[e]=i[e],t},{})}));t=function(t){return t}}return this.store._select(t)},kt.prototype.selectLoading=function(){return this.select(function(t){return t.loading})},kt.prototype.selectError=function(){return this.select(function(t){return t.error})},kt.prototype.getValue=function(){return this.store._value()},kt.prototype.selectHasCache=function(){return this.store._cache().asObservable()},kt.prototype.getHasCache=function(){return this.store._cache().value},Object.defineProperty(kt.prototype,"config",{get:function(){return this.constructor[xt]},enumerable:!0,configurable:!0}),kt);function kt(t){this.store=t,this.__store__=t,R()&&(G[t.storeName]=this)}function Ut(t,e){t.sortBy=t.sortBy||e&&e.sortBy,t.sortByOrder=t.sortByOrder||e&&e.sortByOrder}var Tt={ASC:"asc",DESC:"desc"};function Ft(o,s){return void 0===s&&(s=Tt.ASC),function(t,e){if(!t.hasOwnProperty(o)||!e.hasOwnProperty(o))return 0;var i="string"==typeof t[o]?t[o].toUpperCase():t[o],r="string"==typeof e[o]?e[o].toUpperCase():e[o],n=0;return r<i?n=1:i<r&&(n=-1),s==Tt.DESC?-1*n:n}}function Nt(i,t){for(var r=[],n=i.ids,o=i.entities,s=t.filterBy,e=t.limitTo,a=t.sortBy,u=t.sortByOrder,c=function(e){var i=o[n[e]];if(!s)return r.push(i),"continue";lt(s).every(function(t){return t(i,e)})&&r.push(i)},p=0;p<n.length;p++)c(p);if(a){var h=Q(a)?a:Ft(a,u);r=r.sort(function(t,e){return h(t,e,i)})}var f=Math.min(e||r.length,r.length);return f===r.length?r:r.slice(0,f)}function Vt(t,e){var n={},o=e.filterBy,s=e.limitTo,a=t.ids,u=t.entities;if(!o&&!s)return u;var i=!1===$(s);if(o&&i)for(var c=0,r=function(e,t){if(c===s)return"break";var i=a[e],r=u[i];lt(o).every(function(t){return t(r,e)})&&(n[i]=r,c++)},p=0,h=a.length;p<h;p++){if("break"===r(p))break}else{var f=Math.min(s||a.length,a.length),l=function(e){var t=a[e],i=u[t];if(!o)return n[t]=i,"continue";lt(o).every(function(t){return t(i,e)})&&(n[t]=i)};for(p=0;p<f;p++)l(p)}return n}function Dt(i,r){return function(t){var e=t[i];return bt(e)?undefined:r?It(r)?e[r]:r(e):e}}function Kt(t,e,i){var r,n,o,s,a=[];if(Q(e))try{for(var u=j(t),c=u.next();!c.done;c=u.next()){!0===e(l=c.value)&&a.push(l)}}catch(y){r={error:y}}finally{try{c&&!c.done&&(n=u["return"])&&n.call(u)}finally{if(r)throw r.error}}else{var p=lt(e).reduce(function(t,e){return t.add(e)},new Set);try{for(var h=j(t),f=h.next();!f.done;f=h.next()){var l=f.value;p.has(l[i])&&a.push(l)}}catch(d){o={error:d}}finally{try{f&&!f.done&&(s=h["return"])&&s.call(h)}finally{if(o)throw o.error}}}return a}function Rt(){return O.distinctUntilChanged(function(t,e){return t===e||!1!==p(t)&&!1!==p(e)&&(!(!h(t)||!h(e))||!Bt(e,t)&&!1===Bt(t,e))})}function Bt(t,e){return e.some(function(e){return t.find(function(t){return t===e})===undefined})}var Ht,Mt=(t($t,Ht=Ct),$t.prototype.selectAll=function(t){var e=this;return void 0===t&&(t={asObject:!1}),this.select(function(t){return t.entities}).pipe(O.map(function(){return e.getAll(t)}))},$t.prototype.getAll=function(t){return void 0===t&&(t={asObject:!1,filterBy:undefined,limitTo:undefined}),t.asObject?Vt(this.getValue(),t):(Ut(t,this.config||this.options),Nt(this.getValue(),t))},$t.prototype.selectMany=function(t,r){return t&&t.length?this.select(function(t){return t.entities}).pipe(O.map(function(e){return function i(t,o){return t.reduce(function(t,e,i,r){var n=o(e,i,r);return n!==undefined&&t.push(n),t},[])}(t,function(t){return Dt(t,r)(e)})}),Rt()):s.of([])},$t.prototype.selectEntity=function(t,e){var i=t;return Q(t)&&(i=function u(t,e){var i,r;try{for(var n=j(Object.keys(e)),o=n.next();!o.done;o=n.next()){var s=o.value;if(!0===t(e[s]))return s}}catch(a){i={error:a}}finally{try{o&&!o.done&&(r=n["return"])&&r.call(n)}finally{if(i)throw i.error}}return undefined}(t,this.getValue().entities)),this.select(function(t){return t.entities}).pipe(O.map(Dt(i,e)),O.distinctUntilChanged())},$t.prototype.getEntity=function(t){return this.getValue().entities[t]},$t.prototype.selectActiveId=function(){return this.select(function(t){return t.active})},$t.prototype.getActiveId=function(){return this.getValue().active},$t.prototype.selectActive=function(e){var i=this;return p(this.getActive())?this.selectActiveId().pipe(O.switchMap(function(t){return i.selectMany(t,e)})):this.selectActiveId().pipe(O.switchMap(function(t){return i.selectEntity(t,e)}))},$t.prototype.getActive=function(){var e=this,t=this.getActiveId();return p(t)?t.map(function(t){return e.getValue().entities[t]}):q(t)?this.getEntity(t):undefined},$t.prototype.selectCount=function(t){var e=this;return this.select(function(t){return t.entities}).pipe(O.map(function(){return e.getCount(t)}))},$t.prototype.getCount=function(t){return Q(t)?this.getAll().filter(t).length:this.getValue().ids.length},$t.prototype.selectLast=function(t){return this.selectAt(function(t){return t[t.length-1]},t)},$t.prototype.selectFirst=function(t){return this.selectAt(function(t){return t[0]},t)},$t.prototype.selectEntityAction=function(e){return bt(e)?this.store.selectEntityAction$:this.store.selectEntityAction$.pipe(O.filter(function(t){return t.type===e}),O.map(function(t){return t.ids}))},$t.prototype.hasEntity=function(t){var e=this;return $(t)?0<this.getValue().ids.length:Q(t)?this.getAll().some(t):p(t)?t.every(function(t){return t in e.getValue().entities}):t in this.getValue().entities},$t.prototype.hasActive=function(t){var e=this.getValue().active;return Array.isArray(e)?L(t)?e.includes(t):0<e.length:L(e)},$t.prototype.createUIQuery=function(){this.ui=new Qt(this.__store__.ui)},$t.prototype.selectAt=function(t,e){var i=this;return this.select(function(t){return t.ids}).pipe(O.map(t),O.distinctUntilChanged(),O.switchMap(function(t){return i.selectEntity(t,e)}))},$t);function $t(t,e){void 0===e&&(e={});var i=Ht.call(this,t)||this;return i.options=e,i.__store__=t,i}var Lt,Qt=(t(qt,Lt=Mt),qt);function qt(t){return Lt.call(this,t)||this}function zt(t){return t.pipe(O.filter(function(t){return null!=t}))}function Jt(t,e){return 1===e.split(".").length?t:e.split(".").slice(1).join(".").split(".").reduce(function(t,e){return t&&t[e]},t)}function Wt(t,e,r){var i=e.split(".");if(1===i.length)return w({},t,r);t=w({},t);var n=i.length-2;return e.split(".").slice(1).reduce(function(t,e,i){return t[e]=i===n?r:w({},t[e]),t&&t[e]},t),t}var Xt=!1,Yt=new s.ReplaySubject(1);function Gt(t){Xt=t}function Zt(){return Xt}function te(t){return function e(t){return t&&Q(t.then)}(t)||s.isObservable(t)?s.from(t):s.of(t)}var ee=(ie.prototype.getStoresSnapshot=function(t){void 0===t&&(t=[]);for(var e={},i=0<t.length?t:Object.keys(Y),r=0;r<i.length;r++){var n=i[r];e[n]=Y[n]._value()}return e},ie.prototype.setStoresSnapshot=function(t,e){void 0===e&&(e={skipStorageUpdate:!1}),e.skipStorageUpdate&&Gt(!0);var r=t;It(t)&&(r=JSON.parse(r));for(var i=function(t,e){var i=e[t];Y[i]&&Y[i]._setState(function(){return r[i]})},n=0,o=Object.keys(r);n<o.length;n++)i(n,o);e.skipStorageUpdate&&Gt(!1)},ie);function ie(){}var re=new ee,ne=(oe.prototype.getQuery=function(){return this.query},oe.prototype.getStore=function(){return this.getQuery().__store__},oe.prototype.isEntityBased=function(t){return q(t)},oe.prototype.selectSource=function(t,e){var i=this;return this.isEntityBased(t)?this.getQuery().selectEntity(t).pipe(zt):e?this.getQuery().select(function(t){return Jt(t,i.withStoreName(e))}):this.getQuery().select()},oe.prototype.getSource=function(t,e){if(this.isEntityBased(t))return this.getQuery().getEntity(t);var i=this.getQuery().getValue();return e?Jt(i,this.withStoreName(e)):i},oe.prototype.withStoreName=function(t){return this.storeName+"."+t},Object.defineProperty(oe.prototype,"storeName",{get:function(){return this.getStore().storeName},enumerable:!0,configurable:!0}),oe.prototype.updateStore=function(e,t,i){var r=this;if(this.isEntityBased(t))this.getStore().update(t,e);else{if(i)return void this.getStore()._setState(function(t){return Wt(t,r.withStoreName(i),e)});this.getStore()._setState(function(t){return w({},t,e)})}},oe.prototype.onReset=function(i){var r=this,n=this.getStore().reset;this.getStore().reset=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];setTimeout(function(){n.apply(r.getStore(),t),i()})}},oe);function oe(t,e){this.query=t,e&&e.resetFn&&A().resettable&&this.onReset(e.resetFn)}var se,ae={pagesControls:!1,range:!1,startWith:1,cacheTimeout:undefined,clearStoreWithCache:!0},ue=(t(ce,se=ne),Object.defineProperty(ce.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(ce.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(ce.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(ce.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!0,configurable:!0}),ce.prototype.withControls=function(){return this.config.pagesControls=!0,this},ce.prototype.withRange=function(){return this.config.range=!0,this},ce.prototype.setLoading=function(t){void 0===t&&(t=!0),this.getStore().setLoading(t)},ce.prototype.update=function(t){this.pagination=t,this.addPage(t.data)},ce.prototype.addPage=function(t){var e=this;this.pages.set(this.currentPage,{ids:t.map(function(t){return t[e.getStore().idKey]})}),this.getStore().add(t)},ce.prototype.clearCache=function(t){void 0===t&&(t={}),this.initial||(S("@Pagination - Clear Cache"),!1!==t.clearStore&&(this.config.clearStoreWithCache||t.clearStore)&&this.getStore().remove(),this.pages=new Map,this.metadata=new Map),this.initial=!1},ce.prototype.clearPage=function(t){this.pages["delete"](t)},ce.prototype.destroy=function(t){var e=void 0===t?{}:t,i=e.clearCache,r=e.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),i&&this.clearCache(),bt(r)||this.setPage(r),this.initial=!0},ce.prototype.isPageActive=function(t){return this.currentPage===t},ce.prototype.setPage=function(t){t===this.currentPage&&this.hasPage(t)||this.page.next(this.pagination.currentPage=t)},ce.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},ce.prototype.prevPage=function(){1<this.pagination.currentPage&&this.setPage(this.pagination.currentPage-1)},ce.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},ce.prototype.setFirstPage=function(){this.setPage(1)},ce.prototype.hasPage=function(t){return this.pages.has(t)},ce.prototype.getPage=function(t){var e=this,i=this.pagination.currentPage;return this.hasPage(i)?this.selectPage(i):(this.setLoading(!0),s.from(t()).pipe(O.switchMap(function(t){return i=t.currentPage,st(function(){e.setLoading(!1),e.update(t)}),e.selectPage(i)})))},ce.prototype.getQuery=function(){return this.query},ce.prototype.refreshCurrentPage=function(){!1===$(this.currentPage)&&(this.clearPage(this.currentPage),this.setPage(this.currentPage))},ce.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},ce.prototype.getTo=function(){return this.isLast?this.pagination.total:this.currentPage*this.pagination.perPage},ce.prototype.selectPage=function(s){var a=this;return this.query.selectAll({asObject:!0}).pipe(O.take(1),O.map(function(e){var t=w({},a.pagination,{data:a.pages.get(s).ids.map(function(t){return e[t]})}),i=a.config,r=i.range,n=i.pagesControls;return isNaN(a.pagination.total)&&(1===t.lastPage?t.total=t.data?t.data.length:0:t.total=t.perPage*t.lastPage,a.pagination.total=t.total),r&&(t.from=a.getFrom(),t.to=a.getTo()),n&&(t.pageControls=function o(t,e){for(var i=Math.ceil(t/e),r=[],n=0;n<i;n++)r.push(n+1);return r}(a.pagination.total,a.pagination.perPage)),t}))},e([E("@Pagination - New Page"),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",void 0)],ce.prototype,"update",null),ce);function ce(t,e){void 0===e&&(e={});var i=se.call(this,t,{resetFn:function(){i.initial=!1,i.destroy({clearCache:!0,currentPage:1})}})||this;i.query=t,i.config=e,i.metadata=new Map,i.pages=new Map,i.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},i.initial=!0,i.isLoading$=i.query.selectLoading().pipe(O.delay(0)),i.config=Object.assign(ae,e);var r=i.config,n=r.startWith,o=r.cacheTimeout;return i.page=new s.BehaviorSubject(n),s.isObservable(o)&&(i.clearCacheSubscription=o.subscribe(function(){return i.clearCache()})),i}var pe,he=ue,fe=(t(le,pe=ne),le.prototype.setForm=function(t,e){return this.form=t,this.builder=e,this.activate(),this},le.prototype.reset=function(t){var e,i,r=this;i=t||(this.isKeyBased?this.initialValue:this.factoryFnOrPath()),this.isKeyBased&&Object.keys(this.initialValue).forEach(function(i){var t=r.initialValue[i];if(Array.isArray(t)&&r.builder){var e=r.form.controls[i];r.cleanArray(e),t.forEach(function(t,e){r.form.get(i).insert(e,r.params.arrControlFactory(t))})}}),this.form.patchValue(i,{emitEvent:this.params.emitEvent});var n=this.isKeyBased?Wt(this.getQuery().getValue(),this.getStore().storeName+"."+this.factoryFnOrPath,i):((e={})[this.params.formKey]=i,e);this.updateStore(n)},le.prototype.cleanArray=function(t){for(;0!==t.length;)t.removeAt(0)},le.prototype.resolveInitialValue=function(t,n){var o=this;if(t)return Object.keys(t).reduce(function(t,i){var e=n[i];if(Array.isArray(e)&&o.builder){var r=o.params.arrControlFactory;o.cleanArray(o.form.get(i)),e.forEach(function(t,e){o.form.get(i).insert(e,r(t))})}return t[i]=n[i],t},{})},le.prototype.activate=function(){var t,i,r=this;if(this.isKeyBased)if(this.isRootKeys)this.initialValue=this.resolveInitialValue(this.form.value,this.getQuery().getValue()),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent});else{i=this.getStore().storeName+"."+this.factoryFnOrPath;var e=Jt(this.getQuery().getValue(),i);this.initialValue=this.resolveInitialValue(e,e),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})}else{this.getQuery().getValue()[this.params.formKey]||(S("@PersistNgFormPlugin activate"),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t)));var n=this.getQuery().getValue()[this.params.formKey];this.form.patchValue(n)}this.formChanges=this.form.valueChanges.pipe(O.debounceTime(this.params.debounceTime)).subscribe(function(e){var t;S("@PersistForm - Update"),t=r.isKeyBased?r.isRootKeys?function(t){return w({},t,e)}:function(t){return Wt(t,i,e)}:function(){var t;return(t={})[r.params.formKey]=e,t},r.updateStore(t(r.getQuery().getValue()))})},le.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe(),this.form=null,this.builder=null},le);function le(t,e,i){void 0===i&&(i={});var r=pe.call(this,t)||this;return r.query=t,r.factoryFnOrPath=e,r.params=i,r.params=w({debounceTime:300,formKey:"akitaForm",emitEvent:!1,arrControlFactory:function(t){return r.builder.control(t)}},i),r.isRootKeys=!1===q(e),r.isKeyBased=It(e)||r.isRootKeys,r}function ye(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}var de=[];var ve=(ge.prototype.getEntity=function(t){return this.entities.get(t)},ge.prototype.hasEntity=function(t){return this.entities.has(t)},ge.prototype.removeEntity=function(t){return this.destroy(t),this.entities["delete"](t)},ge.prototype.createEntity=function(t,e){return this.entities.set(t,e)},ge.prototype.getIds=function(){return bt(this.entityIds)?this.query.getValue().ids:lt(this.entityIds)},ge.prototype.resolvedIds=function(t){return bt(t)?this.getIds():lt(t)},ge.prototype.rebase=function(i,r){var n=this;if(void 0===r&&(r={}),q(i))if(bt(this.entityIds)){for(var t=0,e=i.length;t<e;t++){var o=i[t];if(!1===this.hasEntity(o)){Q(r.beforeAdd)&&r.beforeAdd(o);var s=this.instantiatePlugin(o);this.entities.set(o,s),Q(r.afterAdd)&&r.afterAdd(s)}}this.entities.forEach(function(t,e){-1===i.indexOf(e)&&(Q(r.beforeRemove)&&r.beforeRemove(t),n.removeEntity(e))})}else{var a=lt(this.entityIds);for(t=0,e=a.length;t<e;t++)o=a[t],-1<i.indexOf(o)&&!1===this.hasEntity(o)?(Q(r.beforeAdd)&&r.beforeAdd(o),s=this.instantiatePlugin(o),this.entities.set(o,s),Q(r.afterAdd)&&r.afterAdd(s)):this.entities.forEach(function(t,e){-1===i.indexOf(e)&&!0===n.hasEntity(e)&&(Q(r.beforeRemove)&&r.beforeRemove(t),n.removeEntity(e))})}else this.getIds().forEach(function(t){n.hasEntity(t)||n.createEntity(t,n.instantiatePlugin(t))})},ge.prototype.selectIds=function(){return this.query.select(function(t){return t.ids})},ge.prototype.activate=function(t){this.rebase(t)},ge.prototype.forEachId=function(t,e){for(var i=this.resolvedIds(t),r=0,n=i.length;r<n;r++){var o=i[r];this.hasEntity(o)&&e(this.getEntity(o))}},ge);function ge(t,e){this.query=t,this.entityIds=e,this.entities=new Map}var be,me=(t(Se,be=ne),Object.defineProperty(Se.prototype,"hasPast$",{get:function(){return this._hasPast$},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"hasFuture$",{get:function(){return this._hasFuture$},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"hasPast",{get:function(){return 0<this.history.past.length},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"hasFuture",{get:function(){return 0<this.history.future.length},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"property",{get:function(){return this.params.watchProperty},enumerable:!0,configurable:!0}),Se.prototype.updateHasHistory=function(){this.hasFutureSubject.next(this.hasFuture),this.hasPastSubject.next(this.hasPast)},Se.prototype.activate=function(){var o=this;this.hasPastSubject=new s.BehaviorSubject(!1),this._hasPast$=this.hasPastSubject.asObservable().pipe(O.distinctUntilChanged()),this.hasFutureSubject=new s.BehaviorSubject(!1),this._hasFuture$=this.hasFutureSubject.asObservable().pipe(O.distinctUntilChanged()),this.history.present=this.getSource(this._entityId,this.property),this.subscription=this.selectSource(this._entityId,this.property).pipe(O.pairwise()).subscribe(function(t){var e=x(t,2),i=e[0],r=e[1];if(o.skip)o.skip=!1;else{var n=o.params.comparator(i,r);!o.skipUpdate&&n&&(o.history.past.length===o.params.maxAge&&(o.history.past=o.history.past.slice(1)),o.history.past=m(o.history.past,[i]),o.history.present=r,o.updateHasHistory())}})},Se.prototype.undo=function(){if(0<this.history.past.length){var t=this.history,e=t.past,i=t.present,r=e[e.length-1];this.history.past=e.slice(0,e.length-1),this.history.present=r,this.history.future=m([i],this.history.future),this.update()}},Se.prototype.redo=function(){if(0<this.history.future.length){var t=this.history,e=t.past,i=t.present,r=this.history.future[0],n=this.history.future.slice(1);this.history.past=m(e,[i]),this.history.present=r,this.history.future=n,this.update("Redo")}},Se.prototype.jumpToPast=function(t){if(!(t<0||t>=this.history.past.length)){var e=this.history,i=e.past,r=e.future,n=i.slice(0,t),o=m(i.slice(t+1),r),s=i[t];this.history.past=n,this.history.present=s,this.history.future=o,this.update()}},Se.prototype.jumpToFuture=function(t){if(!(t<0||t>=this.history.future.length)){var e=this.history,i=e.past,r=e.future,n=m(i,r.slice(0,t)),o=r[t],s=r.slice(t+1);this.history.past=n,this.history.present=o,this.history.future=s,this.update("Redo")}},Se.prototype.jump=function(t){return 0<t?this.jumpToFuture(t-1):t<0?this.jumpToPast(this.history.past.length+t):void 0},Se.prototype.clear=function(t){this.history=Q(t)?t(this.history):{past:[],present:null,future:[]},this.updateHasHistory()},Se.prototype.destroy=function(t){void 0===t&&(t=!1),t&&this.clear(),this.subscription.unsubscribe()},Se.prototype.ignoreNext=function(){this.skip=!0},Se.prototype.update=function(t){void 0===t&&(t="Undo"),this.skipUpdate=!0,S("@StateHistory - "+t),this.updateStore(this.history.present,this._entityId,this.property),this.updateHasHistory(),this.skipUpdate=!1},Se);function Se(t,e,i){void 0===e&&(e={});var r=be.call(this,t,{resetFn:function(){return r.clear()}})||this;return r.query=t,r.params=e,r._entityId=i,r.skip=!1,r.history={past:[],present:null,future:[]},r.skipUpdate=!1,e.maxAge=e.maxAge?e.maxAge:10,e.comparator=e.comparator||function(){return!0},r.activate(),r}var Pe,Ee=(t(_e,Pe=ve),_e.prototype.redo=function(t){this.forEachId(t,function(t){return t.redo()})},_e.prototype.undo=function(t){this.forEachId(t,function(t){return t.undo()})},_e.prototype.hasPast=function(t){if(this.hasEntity(t))return this.getEntity(t).hasPast},_e.prototype.hasFuture=function(t){if(this.hasEntity(t))return this.getEntity(t).hasFuture},_e.prototype.jumpToFuture=function(t,e){this.forEachId(t,function(t){return t.jumpToFuture(e)})},_e.prototype.jumpToPast=function(t,e){this.forEachId(t,function(t){return t.jumpToPast(e)})},_e.prototype.clear=function(t){this.forEachId(t,function(t){return t.clear()})},_e.prototype.destroy=function(t,e){void 0===e&&(e=!1),this.forEachId(t,function(t){return t.destroy(e)})},_e.prototype.ignoreNext=function(t){this.forEachId(t,function(t){return t.ignoreNext()})},_e.prototype.instantiatePlugin=function(t){return new me(this.query,this.params,t)},_e);function _e(t,e){void 0===e&&(e={});var i=Pe.call(this,t,e.entityIds)||this;return i.query=t,(i.params=e).maxAge=q(e.maxAge)?e.maxAge:10,i.activate(),i.selectIds().pipe(O.skip(1)).subscribe(function(t){return i.activate(t)}),i}var Ae={comparator:function(t,e){return JSON.stringify(t)!==JSON.stringify(e)}};function Oe(t,e){return e.split(".").reduce(function(t,e){return t&&"undefined"!==t[e]?t[e]:undefined},t)}var we,je=(t(xe,we=ne),xe.prototype.reset=function(t){void 0===t&&(t={});var e=this.head;Q(t.updateFn)&&(e=this.isEntityBased(this._entityId)?t.updateFn(this.head,this.getQuery().getEntity(this._entityId)):t.updateFn(this.head,this.getQuery().getValue())),S("@DirtyCheck - Revert"),this.updateStore(e,this._entityId),this._reset.next()},xe.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},xe.prototype.isDirty=function(){return!!this.dirty.value},xe.prototype.hasHead=function(){return!!this.getHead()},xe.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe(),this._reset&&this._reset.complete()},xe.prototype.isPathDirty=function(t){var e=this.getHead(),i=Oe(this.getQuery().getValue(),t),r=Oe(e,t);return this.params.comparator(i,r)},xe.prototype.getHead=function(){return this.head},xe.prototype.activate=function(){var r=this;this.head=this._getHead();var t=this.params.watchProperty?this.params.watchProperty.map(function(e){return r.query.select(function(t){return t[e]}).pipe(O.map(function(t){return{val:t,__akitaKey:e}}))}):[this.selectSource(this._entityId)];this.subscription=s.combineLatest.apply(void 0,m(t)).pipe(O.skip(1)).subscribe(function(t){if(!bt(r.head)){var e=t.some(function(t){var e=t.__akitaKey?r.head[t.__akitaKey]:r.head,i=t.__akitaKey?t.val:t;return r.params.comparator(e,i)});r.updateDirtiness(e)}})},xe.prototype.updateDirtiness=function(t){this.dirty.next(t)},xe.prototype._getHead=function(){var t=this.getSource(this._entityId);return this.params.watchProperty&&(t=this.getWatchedValues(t)),t},xe.prototype.getWatchedValues=function(i){return this.params.watchProperty.reduce(function(t,e){return t[e]=i[e],t},{})},xe);function xe(t,e,i){var r=we.call(this,t)||this;if(r.query=t,r.params=e,r._entityId=i,r.dirty=new s.BehaviorSubject(!1),r.active=!1,r._reset=new s.Subject,r.isDirty$=r.dirty.asObservable().pipe(O.distinctUntilChanged()),r.reset$=r._reset.asObservable(),r.params=w({},Ae,e),r.params.watchProperty){var n=lt(r.params.watchProperty);t instanceof Mt&&n.includes("entities")&&!n.includes("ids")&&n.push("ids"),r.params.watchProperty=n}return r}var Ie,Ce=(t(ke,Ie=ve),ke.prototype.setHead=function(t){if(this.params.entityIds&&t){var e=lt(t);if(!1===lt(this.params.entityIds).some(function(t){return-1<e.indexOf(t)}))return this}return this.forEachId(t,function(t){return t.setHead()}),this._someDirty.next(),this},ke.prototype.hasHead=function(t){return!!this.entities.has(t)&&this.getEntity(t).hasHead()},ke.prototype.reset=function(t,e){void 0===e&&(e={}),this.forEachId(t,function(t){return t.reset(e)})},ke.prototype.isDirty=function(t,e){if(void 0===e&&(e=!0),this.entities.has(t)){var i=this.getEntity(t);return e?i.isDirty$:i.isDirty()}return!1},ke.prototype.someDirty=function(){return this.checkSomeDirty()},ke.prototype.isPathDirty=function(t,e){if(this.entities.has(t)){var i=this.getEntity(t).getHead(),r=Oe(this.query.getEntity(t),e),n=Oe(i,e);return this.params.comparator(r,n)}return null},ke.prototype.destroy=function(t){this.forEachId(t,function(t){return t.destroy()}),t||this._someDirty.complete()},ke.prototype.instantiatePlugin=function(t){return new je(this.query,this.params,t)},ke.prototype.checkSomeDirty=function(){var t,e,i=this.resolvedIds();try{for(var r=j(i),n=r.next();!n.done;n=r.next()){var o=n.value;if(this.getEntity(o).isDirty())return!0}}catch(s){t={error:s}}finally{try{n&&!n.done&&(e=r["return"])&&e.call(r)}finally{if(t)throw t.error}}return!1},ke);function ke(t,e){void 0===e&&(e={});var i=Ie.call(this,t,e.entityIds)||this;return i.query=t,i.params=e,i._someDirty=new s.Subject,i.someDirty$=s.merge(i.query.select(function(t){return t.entities}),i._someDirty.asObservable()).pipe(O.auditTime(0),O.map(function(){return i.checkSomeDirty()})),i.params=w({},Ae,e),i.activate(),i.selectIds().pipe(O.skip(1)).subscribe(function(t){Ie.prototype.rebase.call(i,t,{afterAdd:function(t){return t.setHead()}})}),i}var Ue={Update:0,AddEntities:1,SetEntities:2,UpdateEntities:3,RemoveEntities:4,UpsertEntities:5};function Te(i,t,e,r){var n;if(void 0===r&&(r=Et),Q(t))n=t;else{var o=lt(t);n=function(t){return!0===o.includes(pt(t)?t[r]:t)}}function s(t){return t.map(function(t){return!0===n(t)?pt(t)?w({},t,e):e:t})}return p(i)?s(i):function(t){var e;return(e={})[i]=s(t[i]),e}}function Fe(i,t,e){void 0===e&&(e={});function r(t){return e.prepend?m(n,t||[]):m(t||[],n)}var n=lt(t);return p(i)?r(i):function(t){var e;return(e={})[i]=r(t[i]),e}}Ue[Ue.Update]="Update",Ue[Ue.AddEntities]="AddEntities",Ue[Ue.SetEntities]="SetEntities",Ue[Ue.UpdateEntities]="UpdateEntities",Ue[Ue.RemoveEntities]="RemoveEntities",Ue[Ue.UpsertEntities]="UpsertEntities";function Ne(){}i.EntityStore=_t,i.EntityUIStore=wt,i.QueryEntity=Mt,i.EntityUIQuery=Qt,i.Query=Ct,i.Store=ut,i.applyTransaction=st,i.transaction=at,i.commit=ot,i.endBatch=rt,i.isTransactionInProcess=nt,i.startBatch=it,i.transactionManager=et,i.withTransaction=function Ve(e){return function(t){return t.pipe(O.tap(function(t){return st(function(){return e(t)})}))}},i.filterNil=zt,i.DEFAULT_ID_KEY=Et,i.action=E,i.setAction=C,i.setSkipAction=P,i.logAction=S,i.currentAction=g,i.resetCustomAction=b,i.SnapshotManager=ee,i.snapshotManager=re,i.configKey=X,i.StoreConfig=function De(n){return function(t){t[X]={idKey:"id"};for(var e=0,i=Object.keys(n);e<i.length;e++){var r=i[e];"name"===r?t[X].storeName=n[r]:t[X][r]=n[r]}}},i.QueryConfig=function Ke(n){return function(t){t[xt]={};for(var e=0,i=Object.keys(n);e<i.length;e++){var r=i[e];t[xt][r]=n[r]}}},i.queryConfigKey=xt,i.akitaConfig=function Re(t){_=w({},_,t)},i.getAkitaConfig=A,i.compareValues=Ft,i.Order=Tt,i.AkitaPlugin=ne,i.Paginator=he,i.PaginatorPlugin=ue,i.PersistNgFormPlugin=fe,i.persistState=function Be(t){var e={key:"AkitaStores",enableInNonBrowser:!1,storage:"undefined"==typeof localStorage?t.storage:localStorage,deserialize:JSON.parse,serialize:JSON.stringify,include:[],exclude:[],persistOnDestroy:!1,preStorageUpdate:function(t,e){return e},preStoreUpdate:function(t,e){return e},skipStorageUpdate:Zt,preStorageUpdateOperator:function(){return function(t){return t}}},i=Object.assign({},e,t),a=i.storage,r=i.enableInNonBrowser,u=i.deserialize,c=i.serialize,n=i.include,p=i.exclude,h=i.key,f=i.preStorageUpdate,l=i.persistOnDestroy,y=i.preStorageUpdateOperator,d=i.preStoreUpdate,v=i.skipStorageUpdate;if(!W||r){var g,b=0<n.length,m=0<p.length;if(b&&m)throw new H("You can't use both include and exclude");b&&(g=n.reduce(function(t,e){Q(e)?t.fns.push(e):t[e.split(".")[0]]=e;return t},{fns:[]}));var S={},P={},E=[],_=[],A="undefined"!=typeof localStorage&&(a===localStorage||a===sessionStorage);return te(a.getItem(h)).subscribe(function(t){var n=pt(t)?t:u(t||"{}");function r(t){n.$cache=w({},n.$cache||{},t),n=Object.assign({},n,P),_.push(a.setItem(h,A?c(n):n)),function e(t){te(t).subscribe(function(){var t=_.shift();t&&e(t)})}(_.shift())}function o(e,i){S[e]=Y[e]._select(function(t){return Jt(t,i)}).pipe(O.skip(1),O.filter(function(){return!1===v()}),y()).subscribe(function(t){P[e]=f(e,t),Promise.resolve().then(function(){var t;return r(((t={})[e]=Y[e]._cache().getValue(),t))})})}function s(e,t,i){if(e in n){C("@PersistState"),t._setState(function(t){return Wt(t,i,d(e,n[e]))});var r=!!n.$cache&&n.$cache[e];Y[e].setHasCache(r,{restartTTL:!0})}}E.push(U.subscribe(function(t){var e;S[t]&&(!1===l&&r(((e={})[t]=!1,e)),S[t].unsubscribe(),delete S[t])})),E.push(F.subscribe(function(e){if(!m||!p.includes(e)){var t=Y[e];if(b){var i=g[e];if(!i){if(!g.fns.some(function(t){return t(e)}))return;i=e}s(e,t,i),o(e,i)}else s(e,t,e),o(e,e)}})),Yt.next()}),{destroy:function(){E.forEach(function(t){return t.unsubscribe()});for(var t=0,e=Object.keys(S);t<e.length;t++){var i=e[t];S[i].unsubscribe()}S={}},clear:function(){a.clear()},clearStore:function(i){$(i)?te(a.setItem(h,"{}")).subscribe():te(a.getItem(h)).subscribe(function(t){var e=u(t||"{}");e[i]&&(delete e[i],te(a.setItem(h,c(e))).subscribe())})}}}},i.selectPersistStateInit=function He(){return Yt.asObservable()},i.akitaDevtools=function Me(o,u){if(void 0===u&&(u={}),!W&&window.__REDUX_DEVTOOLS_EXTENSION__){de.length&&de.forEach(function(t){t.unsubscribe?t.unsubscribe():t&&t()}),o&&o.run||((o=o||{}).run=function(t){return t()},u=o);var t=Object.assign({},{name:"Akita",shallow:!0,storesWhitelist:[]},u),e=t.storesWhitelist,c=window.__REDUX_DEVTOOLS_EXTENSION__.connect(t),p={},h=function(t){return!e.length||-1<e.indexOf(t)};de.push(F.subscribe(function(t){var e;!1!==h(t)&&(p=w({},p,((e={})[t]=Y[t]._value(),e)),c.send({type:"["+ye(t)+"] - @@INIT"},p))})),de.push(U.subscribe(function(t){!1!==h(t)&&(delete p[t],c.send({type:"["+t+"] - Delete Store"},p))})),de.push(N.subscribe(function(t){var e;if(!1!==h(t)){var i=g.type,r=g.entityIds;if(g.skip)P(!1);else{var n=Y[t];if(n){if(!1===u.shallow&&p[t])if(JSON.stringify(n._value())===JSON.stringify(p[t]))return;p=w({},p,((e={})[t]=n._value(),e));var o=ye(t),s=L(r)?"["+o+"] - "+i+" (ids: "+r+")":"["+o+"] - "+i;if(u.logTrace&&(console.group(s),console.trace(),console.groupEnd()),u.sortAlphabetically){var a=Object.keys(p).sort().reduce(function(t,e){return t[e]=p[e],t},{});c.send({type:s},a)}else c.send({type:s},p)}}}})),de.push(c.subscribe(function(t){if("DISPATCH"===t.type){if("COMMIT"===t.payload.type)return void c.init(p);if(t.state)for(var r=JSON.parse(t.state),e=function(t,e){var i=e[t];Y[i]&&o.run(function(){Y[i]._setState(function(){return r[i]},!1)})},i=0,n=Object.keys(r);i<n.length;i++)e(i,n)}}))}},i.EntityCollectionPlugin=ve,i.StateHistoryPlugin=me,i.EntityStateHistoryPlugin=Ee,i.dirtyCheckDefaultParams=Ae,i.DirtyCheckPlugin=je,i.getNestedPath=Oe,i.EntityDirtyCheckPlugin=Ce,i.guid=function $e(){return"xxxxxx4xyx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},i.setEntities=u,i.isEntityState=d,i.toEntitiesIds=function Le(t,e){var i,r;void 0===e&&(e=Et);var n=[];try{for(var o=j(t),s=o.next();!s.done;s=o.next()){var a=s.value;n.push(a[e])}}catch(u){i={error:u}}finally{try{s&&!s.done&&(r=o["return"])&&r.call(o)}finally{if(i)throw i.error}}return n},i.toEntitiesObject=f,i.hasEntity=I,i.hasActiveState=l,i.getExitingActives=a,i.isMultiActiveState=o,i.resolveActiveEntity=y,i.isEmpty=h,i.coerceArray=lt,i.updateEntities=gt,i.removeEntities=yt,i.removeAllEntities=dt,i.getInitialEntitiesState=vt,i.getActiveEntities=ht,i.addEntities=ft,i.resetStores=function Qe(a){a=Object.assign({},{exclude:[]},a);var u=Object.keys(Y);st(function(){var t,e;try{for(var i=j(u),r=i.next();!r.done;r=i.next()){var n=r.value,o=Y[n];a.exclude?-1===a.exclude.indexOf(o.storeName)&&o.reset():o.reset()}}catch(s){t={error:s}}finally{try{r&&!r.done&&(e=i["return"])&&e.call(i)}finally{if(t)throw t.error}}})},i.isObject=pt,i.isPlainObject=z,i.isFunction=Q,i.isArray=p,i.toBoolean=q,i.isUndefined=bt,i.isNil=$,i.isString=It,i.isNumber=function qe(t){return!p(t)&&0<=t-parseFloat(t)+1},i.isDefined=L,i.setValue=Wt,i.getValue=Jt,i.sortByOptions=Ut,i.entitiesToArray=Nt,i.entitiesToMap=Vt,i.__stores__=Y,i.isDev=R,i.enableAkitaProdMode=function ze(){i.__DEV__=!1},i.isNotBrowser=W,i.runStoreAction=function Je(t,e,i){var r=Y[t];if($(r))throw new H(t+" doesn't exist");switch(e){case Ue.SetEntities:var n=i.payload;return void r.set(n.data);case Ue.AddEntities:n=i.payload;return void r.add(n.data,n.params);case Ue.UpdateEntities:n=i.payload;return void r.update(n.entityIds,n.data);case Ue.RemoveEntities:n=i.payload;return void r.remove(n.entityIds);case Ue.UpsertEntities:return void((n=i.payload).entityIds?r.upsert(n.entityIds,n.data):Array.isArray(n.data)?r.upsertMany(n.data):r.upsertMany([n.data]));case Ue.Update:n=i.payload;return void r.update(n.data)}},i.StoreActions=Ue,i.arrayUpdate=Te,i.arrayAdd=Fe,i.arrayUpsert=function We(t,e,i,r){var n;void 0===r&&(r=Et);var o=pt(i);return t.some(function(t){return o?t[r]===e:t===e})?Te(t,e,i,r):Fe(t,o?w({},i,((n={})[r]=e,n)):i)},i.arrayFind=function Xe(e,i){return function(t){return t.pipe(O.map(function(t){return!1===p(t)?t:Kt(t,e,i||Et)}),Rt(),O.map(function(t){return!1===p(t)?t:p(e)||Q(e)?t:t[0]}))}},i.distinctUntilArrayItemChanged=Rt,i.find=Kt,i.arrayRemove=function Ye(i,t,e){var r,n;return void 0===e&&(e=Et),n=Q(t)?function o(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return!i.apply(void 0,m(t))}}(t):(r=lt(t),function(t){return!1===r.includes(pt(t)?t[e]:t)}),Array.isArray(i)?i.filter(n):function(t){var e;return(e={})[i]=t[i].filter(n),e}},i.createEntityQuery=function Ge(t,e){return void 0===e&&(e={}),new Mt(t,e)},i.createEntityStore=function Ze(t,e){return new _t(t,e)},i.createQuery=function ti(t){return new Ct(t)},i.createStore=function ei(t,e){return new ut(t,e)},i.cacheable=function ii(t,e,i){return void 0===i&&(i={emitNext:!1}),t._cache().value?i.emitNext?s.of(undefined):s.EMPTY:e},i.combineQueries=function ri(t){return s.combineLatest(t).pipe(O.auditTime(0))},i.EntityService=Ne,i.setLoading=function ni(e){return function(t){return s.defer(function(){return e.setLoading(!0),t.pipe(O.finalize(function(){return e.setLoading(!1)}))})}},i.EntityActions=mt,i.dispatchDeleted=V,i.dispatchAdded=D,i.dispatchUpdate=K,i.$$deleteStore=U,i.$$addStore=F,i.$$updateStore=N,i.ɵa=J,Object.defineProperty(i,"__esModule",{value:!0})});
//# sourceMappingURL=datorama-akita.umd.min.js.map