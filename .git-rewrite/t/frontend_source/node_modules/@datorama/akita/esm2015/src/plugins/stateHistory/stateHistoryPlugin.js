/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { pairwise, distinctUntilChanged } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
import { AkitaPlugin } from '../plugin';
import { logAction } from '../../actions';
import { isFunction } from '../../isFunction';
/**
 * @record
 */
export function StateHistoryParams() { }
if (false) {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.watchProperty;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.comparator;
}
/**
 * @template State
 */
export class StateHistoryPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params = {}, _entityId) {
        super(query, {
            resetFn: (/**
             * @return {?}
             */
            () => this.clear())
        });
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        this.skip = false;
        this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        this.skipUpdate = false;
        params.maxAge = !!params.maxAge ? params.maxAge : 10;
        params.comparator = params.comparator || ((/**
         * @return {?}
         */
        () => true));
        this.activate();
    }
    /**
     * Observable stream representing whether the history plugin has an available past
     *
     * @return {?}
     */
    get hasPast$() {
        return this._hasPast$;
    }
    /**
     * Observable stream representing whether the history plugin has an available future
     *
     * @return {?}
     */
    get hasFuture$() {
        return this._hasFuture$;
    }
    /**
     * @return {?}
     */
    get hasPast() {
        return this.history.past.length > 0;
    }
    /**
     * @return {?}
     */
    get hasFuture() {
        return this.history.future.length > 0;
    }
    /**
     * @private
     * @return {?}
     */
    get property() {
        return this.params.watchProperty;
    }
    /* Updates the hasPast$ hasFuture$ observables*/
    /**
     * @private
     * @return {?}
     */
    updateHasHistory() {
        this.hasFutureSubject.next(this.hasFuture);
        this.hasPastSubject.next(this.hasPast);
    }
    /**
     * @return {?}
     */
    activate() {
        this.hasPastSubject = new BehaviorSubject(false);
        this._hasPast$ = this.hasPastSubject.asObservable().pipe(distinctUntilChanged());
        this.hasFutureSubject = new BehaviorSubject(false);
        this._hasFuture$ = this.hasFutureSubject.asObservable().pipe(distinctUntilChanged());
        this.history.present = this.getSource(this._entityId, this.property);
        this.subscription = ((/** @type {?} */ (this)))
            .selectSource(this._entityId, this.property)
            .pipe(pairwise())
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ([past, present]) => {
            if (this.skip) {
                this.skip = false;
                return;
            }
            /**
             *  comparator: (prev, current) => isEqual(prev, current) === false
             * @type {?}
             */
            const shouldUpdate = this.params.comparator(past, present);
            if (!this.skipUpdate && shouldUpdate) {
                if (this.history.past.length === this.params.maxAge) {
                    this.history.past = this.history.past.slice(1);
                }
                this.history.past = [...this.history.past, past];
                this.history.present = present;
                this.updateHasHistory();
            }
        }));
    }
    /**
     * @return {?}
     */
    undo() {
        if (this.history.past.length > 0) {
            const { past, present } = this.history;
            /** @type {?} */
            const previous = past[past.length - 1];
            this.history.past = past.slice(0, past.length - 1);
            this.history.present = previous;
            this.history.future = [present, ...this.history.future];
            this.update();
        }
    }
    /**
     * @return {?}
     */
    redo() {
        if (this.history.future.length > 0) {
            const { past, present } = this.history;
            /** @type {?} */
            const next = this.history.future[0];
            /** @type {?} */
            const newFuture = this.history.future.slice(1);
            this.history.past = [...past, present];
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToPast(index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        const { past, future } = this.history;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         *
         * newPast = past.slice(0, 2) = [1, 2];
         * present = past[index] = 3;
         * [...past.slice(2 + 1), ...future] = [4, 5];
         *
         * @type {?}
         */
        const newPast = past.slice(0, index);
        /** @type {?} */
        const newFuture = [...past.slice(index + 1), ...future];
        /** @type {?} */
        const newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToFuture(index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        const { past, future } = this.history;
        /** @type {?} */
        const newPast = [...past, ...future.slice(0, index)];
        /** @type {?} */
        const newPresent = future[index];
        /** @type {?} */
        const newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    }
    /**
     *
     * jump n steps in the past or forward
     *
     * @param {?} n
     * @return {?}
     */
    jump(n) {
        if (n > 0)
            return this.jumpToFuture(n - 1);
        if (n < 0)
            return this.jumpToPast(this.history.past.length + n);
    }
    /**
     * Clear the history
     *
     * \@example
     *
     * stateHistory.clear((history) => {
     *  return {
     *    past: history.past,
     *    present: history.present,
     *    future: []
     *  };
     * });
     * @param {?=} customUpdateFn Callback function for only clearing part of the history
     *
     * @return {?}
     */
    clear(customUpdateFn) {
        this.history = isFunction(customUpdateFn)
            ? customUpdateFn(this.history)
            : {
                past: [],
                present: null,
                future: []
            };
        this.updateHasHistory();
    }
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    destroy(clearHistory = false) {
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    }
    /**
     * @return {?}
     */
    ignoreNext() {
        this.skip = true;
    }
    /**
     * @private
     * @param {?=} action
     * @return {?}
     */
    update(action = 'Undo') {
        this.skipUpdate = true;
        logAction(`@StateHistory - ${action}`);
        this.updateStore(this.history.present, this._entityId, this.property);
        this.updateHasHistory();
        this.skipUpdate = false;
    }
}
if (false) {
    /**
     * Allow skipping an update from outside
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skip;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasPastSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasPast$;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasFutureSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasFuture$;
    /**
     * @type {?}
     * @protected
     */
    StateHistoryPlugin.prototype.query;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.params;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVIaXN0b3J5UGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvc3RhdGVIaXN0b3J5L3N0YXRlSGlzdG9yeVBsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBVyxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7OztBQUU5Qyx3Q0FJQzs7O0lBSEMsb0NBQWdCOztJQUNoQiwyQ0FBdUI7O0lBQ3ZCLHdDQUFrRDs7Ozs7QUFTcEQsTUFBTSxPQUFPLGtCQUFnQyxTQUFRLFdBQWtCOzs7Ozs7SUFvQnJFLFlBQXNCLEtBQXFCLEVBQVUsU0FBNkIsRUFBRSxFQUFVLFNBQWU7UUFDM0csS0FBSyxDQUFDLEtBQUssRUFBRTtZQUNYLE9BQU87OztZQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtTQUM1QixDQUFDLENBQUM7UUFIaUIsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQU07Ozs7UUFsQnJHLFNBQUksR0FBRyxLQUFLLENBQUM7UUFFYixZQUFPLEdBQUc7WUFDaEIsSUFBSSxFQUFFLEVBQUU7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxFQUFFO1NBQ1gsQ0FBQzs7OztRQUdNLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFhekIsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFD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QUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxVQUFVO1FBQ1IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQzs7Ozs7O0lBRU8sTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNO1FBQzVCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLFNBQVMsQ0FBQyxtQkFBbUIsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzFCLENBQUM7Q0FDRjs7Ozs7OztJQS9NQyxrQ0FBcUI7Ozs7O0lBRXJCLHFDQUlFOzs7Ozs7SUFHRix3Q0FBMkI7Ozs7O0lBQzNCLDBDQUFxQjs7Ozs7SUFHckIsNENBQWlEOzs7OztJQUNqRCx1Q0FBdUM7Ozs7O0lBQ3ZDLDhDQUFtRDs7Ozs7SUFDbkQseUNBQXlDOzs7OztJQUU3QixtQ0FBK0I7Ozs7O0lBQUUsb0NBQXVDOzs7OztJQUFFLHVDQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhaXJ3aXNlLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWtpdGFQbHVnaW4sIFF1ZXJpZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgbG9nQWN0aW9uIH0gZnJvbSAnLi4vLi4vYWN0aW9ucyc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi4vLi4vaXNGdW5jdGlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVIaXN0b3J5UGFyYW1zIHtcbiAgbWF4QWdlPzogbnVtYmVyO1xuICB3YXRjaFByb3BlcnR5Pzogc3RyaW5nO1xuICBjb21wYXJhdG9yPzogKHByZXZTdGF0ZSwgY3VycmVudFN0YXRlKSA9PiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBIaXN0b3J5PFN0YXRlPiA9IHtcbiAgcGFzdDogU3RhdGVbXTtcbiAgcHJlc2VudDogU3RhdGUgfCBudWxsO1xuICBmdXR1cmU6IFN0YXRlW107XG59O1xuXG5leHBvcnQgY2xhc3MgU3RhdGVIaXN0b3J5UGx1Z2luPFN0YXRlID0gYW55PiBleHRlbmRzIEFraXRhUGx1Z2luPFN0YXRlPiB7XG4gIC8qKiBBbGxvdyBza2lwcGluZyBhbiB1cGRhdGUgZnJvbSBvdXRzaWRlICovXG4gIHByaXZhdGUgc2tpcCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgaGlzdG9yeSA9IHtcbiAgICBwYXN0OiBbXSxcbiAgICBwcmVzZW50OiBudWxsLFxuICAgIGZ1dHVyZTogW11cbiAgfTtcblxuICAvKiogU2tpcCB0aGUgdXBkYXRlIHdoZW4gcmVkby91bmRvICovXG4gIHByaXZhdGUgc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjtcblxuICAvKiBTdWJqZWN0cyBmb3Igc3VwcG9ydGluZyBvYnNlcnZhYmxlIGhhc1Bhc3QkIGFuZCBoYXNGdXR1cmUkICovXG4gIHByaXZhdGUgaGFzUGFzdFN1YmplY3Q6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPjtcbiAgcHJpdmF0ZSBfaGFzUGFzdCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHByaXZhdGUgaGFzRnV0dXJlU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+O1xuICBwcml2YXRlIF9oYXNGdXR1cmUkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBxdWVyeTogUXVlcmllczxTdGF0ZT4sIHByaXZhdGUgcGFyYW1zOiBTdGF0ZUhpc3RvcnlQYXJhbXMgPSB7fSwgcHJpdmF0ZSBfZW50aXR5SWQ/OiBhbnkpIHtcbiAgICBzdXBlcihxdWVyeSwge1xuICAgICAgcmVzZXRGbjogKCkgPT4gdGhpcy5jbGVhcigpXG4gICAgfSk7XG4gICAgcGFyYW1zLm1heEFnZSA9ICEhcGFyYW1zLm1heEFnZSA/IHBhcmFtcy5tYXhBZ2UgOiAxMDtcbiAgICBwYXJhbXMuY29tcGFyYXRvciA9IHBhcmFtcy5jb21wYXJhdG9yIHx8ICgoKSA9PiB0cnVlKTtcblxuICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIHN0cmVhbSByZXByZXNlbnRpbmcgd2hldGhlciB0aGUgaGlzdG9yeSBwbHVnaW4gaGFzIGFuIGF2YWlsYWJsZSBwYXN0XG4gICAqXG4gICAqL1xuICBnZXQgaGFzUGFzdCQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc1Bhc3QkO1xuICB9XG5cbiAgLyoqXG4gICAqIE9ic2VydmFibGUgc3RyZWFtIHJlcHJlc2VudGluZyB3aGV0aGVyIHRoZSBoaXN0b3J5IHBsdWdpbiBoYXMgYW4gYXZhaWxhYmxlIGZ1dHVyZVxuICAgKlxuICAgKi9cbiAgZ2V0IGhhc0Z1dHVyZSQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc0Z1dHVyZSQ7XG4gIH1cblxuICBnZXQgaGFzUGFzdCgpIHtcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID4gMDtcbiAgfVxuXG4gIGdldCBoYXNGdXR1cmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoID4gMDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IHByb3BlcnR5KCkge1xuICAgIHJldHVybiB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5O1xuICB9XG5cbiAgLyogVXBkYXRlcyB0aGUgaGFzUGFzdCQgaGFzRnV0dXJlJCBvYnNlcnZhYmxlcyovXG4gIHByaXZhdGUgdXBkYXRlSGFzSGlzdG9yeSgpIHtcbiAgICB0aGlzLmhhc0Z1dHVyZVN1YmplY3QubmV4dCh0aGlzLmhhc0Z1dHVyZSk7XG4gICAgdGhpcy5oYXNQYXN0U3ViamVjdC5uZXh0KHRoaXMuaGFzUGFzdCk7XG4gIH1cblxuICBhY3RpdmF0ZSgpIHtcbiAgICB0aGlzLmhhc1Bhc3RTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gICAgdGhpcy5faGFzUGFzdCQgPSB0aGlzLmhhc1Bhc3RTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgdGhpcy5oYXNGdXR1cmVTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gICAgdGhpcy5faGFzRnV0dXJlJCA9IHRoaXMuaGFzRnV0dXJlU3ViamVjdC5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuXG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSB0aGlzLmdldFNvdXJjZSh0aGlzLl9lbnRpdHlJZCwgdGhpcy5wcm9wZXJ0eSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSAodGhpcyBhcyBhbnkpXG4gICAgICAuc2VsZWN0U291cmNlKHRoaXMuX2VudGl0eUlkLCB0aGlzLnByb3BlcnR5KVxuICAgICAgLnBpcGUocGFpcndpc2UoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtwYXN0LCBwcmVzZW50XSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5za2lwKSB7XG4gICAgICAgICAgdGhpcy5za2lwID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8qKlxuICAgICAgICAgKiAgY29tcGFyYXRvcjogKHByZXYsIGN1cnJlbnQpID0+IGlzRXF1YWwocHJldiwgY3VycmVudCkgPT09IGZhbHNlXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBzaG91bGRVcGRhdGUgPSB0aGlzLnBhcmFtcy5jb21wYXJhdG9yKHBhc3QsIHByZXNlbnQpO1xuXG4gICAgICAgIGlmICghdGhpcy5za2lwVXBkYXRlICYmIHNob3VsZFVwZGF0ZSkge1xuICAgICAgICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPT09IHRoaXMucGFyYW1zLm1heEFnZSkge1xuICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSB0aGlzLmhpc3RvcnkucGFzdC5zbGljZSgxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBbLi4udGhpcy5oaXN0b3J5LnBhc3QsIHBhc3RdO1xuICAgICAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gcHJlc2VudDtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUhhc0hpc3RvcnkoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB1bmRvKCkge1xuICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IHByZXZpb3VzID0gcGFzdFtwYXN0Lmxlbmd0aCAtIDFdO1xuICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBwYXN0LnNsaWNlKDAsIHBhc3QubGVuZ3RoIC0gMSk7XG4gICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHByZXZpb3VzO1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IFtwcmVzZW50LCAuLi50aGlzLmhpc3RvcnkuZnV0dXJlXTtcbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcmVkbygpIHtcbiAgICBpZiAodGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLmhpc3RvcnkuZnV0dXJlWzBdO1xuICAgICAgY29uc3QgbmV3RnV0dXJlID0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5zbGljZSgxKTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gWy4uLnBhc3QsIHByZXNlbnRdO1xuICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXh0O1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gICAgfVxuICB9XG5cbiAganVtcFRvUGFzdChpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBjb25zdCBwYXN0ID0gWzEsIDIsIDMsIDQsIDVdO1xuICAgICAqXG4gICAgICogbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgMikgPSBbMSwgMl07XG4gICAgICogcHJlc2VudCA9IHBhc3RbaW5kZXhdID0gMztcbiAgICAgKiBbLi4ucGFzdC5zbGljZSgyICsgMSksIC4uLmZ1dHVyZV0gPSBbNCwgNV07XG4gICAgICpcbiAgICAgKi9cbiAgICBjb25zdCBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCBpbmRleCk7XG4gICAgY29uc3QgbmV3RnV0dXJlID0gWy4uLnBhc3Quc2xpY2UoaW5kZXggKyAxKSwgLi4uZnV0dXJlXTtcbiAgICBjb25zdCBuZXdQcmVzZW50ID0gcGFzdFtpbmRleF07XG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBqdW1wVG9GdXR1cmUoaW5kZXg6IG51bWJlcikge1xuICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG5cbiAgICBjb25zdCBuZXdQYXN0ID0gWy4uLnBhc3QsIC4uLmZ1dHVyZS5zbGljZSgwLCBpbmRleCldO1xuICAgIGNvbnN0IG5ld1ByZXNlbnQgPSBmdXR1cmVbaW5kZXhdO1xuICAgIGNvbnN0IG5ld0Z1dHVyZSA9IGZ1dHVyZS5zbGljZShpbmRleCArIDEpO1xuXG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICoganVtcCBuIHN0ZXBzIGluIHRoZSBwYXN0IG9yIGZvcndhcmRcbiAgICpcbiAgICovXG4gIGp1bXAobjogbnVtYmVyKSB7XG4gICAgaWYgKG4gPiAwKSByZXR1cm4gdGhpcy5qdW1wVG9GdXR1cmUobiAtIDEpO1xuICAgIGlmIChuIDwgMCkgcmV0dXJuIHRoaXMuanVtcFRvUGFzdCh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggKyBuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB0aGUgaGlzdG9yeVxuICAgKlxuICAgKiBAcGFyYW0gY3VzdG9tVXBkYXRlRm4gQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIG9ubHkgY2xlYXJpbmcgcGFydCBvZiB0aGUgaGlzdG9yeVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdGF0ZUhpc3RvcnkuY2xlYXIoKGhpc3RvcnkpID0+IHtcbiAgICogIHJldHVybiB7XG4gICAqICAgIHBhc3Q6IGhpc3RvcnkucGFzdCxcbiAgICogICAgcHJlc2VudDogaGlzdG9yeS5wcmVzZW50LFxuICAgKiAgICBmdXR1cmU6IFtdXG4gICAqICB9O1xuICAgKiB9KTtcbiAgICovXG4gIGNsZWFyKGN1c3RvbVVwZGF0ZUZuPzogKGhpc3Rvcnk6IEhpc3Rvcnk8U3RhdGU+KSA9PiBIaXN0b3J5PFN0YXRlPikge1xuICAgIHRoaXMuaGlzdG9yeSA9IGlzRnVuY3Rpb24oY3VzdG9tVXBkYXRlRm4pXG4gICAgICA/IGN1c3RvbVVwZGF0ZUZuKHRoaXMuaGlzdG9yeSlcbiAgICAgIDoge1xuICAgICAgICAgIHBhc3Q6IFtdLFxuICAgICAgICAgIHByZXNlbnQ6IG51bGwsXG4gICAgICAgICAgZnV0dXJlOiBbXVxuICAgICAgICB9O1xuICAgIHRoaXMudXBkYXRlSGFzSGlzdG9yeSgpO1xuICB9XG5cbiAgZGVzdHJveShjbGVhckhpc3RvcnkgPSBmYWxzZSkge1xuICAgIGlmIChjbGVhckhpc3RvcnkpIHtcbiAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICB9XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIGlnbm9yZU5leHQoKSB7XG4gICAgdGhpcy5za2lwID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKGFjdGlvbiA9ICdVbmRvJykge1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IHRydWU7XG4gICAgbG9nQWN0aW9uKGBAU3RhdGVIaXN0b3J5IC0gJHthY3Rpb259YCk7XG4gICAgdGhpcy51cGRhdGVTdG9yZSh0aGlzLmhpc3RvcnkucHJlc2VudCwgdGhpcy5fZW50aXR5SWQsIHRoaXMucHJvcGVydHkpO1xuICAgIHRoaXMudXBkYXRlSGFzSGlzdG9yeSgpO1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICB9XG59XG4iXX0=