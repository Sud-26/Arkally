import * as tslib_1 from "tslib";
var _a;
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isEmpty } from './isEmpty';
import { setEntities } from './setEntities';
import { Store } from './store';
import { getActiveEntities } from './getActiveEntities';
import { addEntities } from './addEntities';
import { coerceArray } from './coerceArray';
import { removeEntities } from './removeEntities';
import { getInitialEntitiesState } from './getInitialEntitiesState';
import { isDefined } from './isDefined';
import { updateEntities } from './updateEntities';
import { transaction } from './transaction';
import { isNil } from './isNil';
import { isFunction } from './isFunction';
import { isUndefined } from './isUndefined';
import { logAction, setAction } from './actions';
import { isDev } from './env';
import { hasEntity } from './hasEntity';
import { Subject } from 'rxjs';
import { EntityActions } from './entityActions';
import { DEFAULT_ID_KEY } from './defaultIDKey';
/**
 *
 * Store for managing a collection of entities
 *
 * \@example
 *
 * export interface WidgetsState extends EntityState<Widget> { }
 *
 * \@StoreConfig({ name: 'widgets' })
 *  export class WidgetsStore extends EntityStore<WidgetsState> {
 *   constructor() {
 *     super();
 *   }
 * }
 *
 *
 * @template S, EntityType, IDType
 */
export class EntityStore extends Store {
    /**
     * @param {?=} initialState
     * @param {?=} options
     */
    constructor(initialState = {}, options = {}) {
        super(Object.assign({}, getInitialEntitiesState(), initialState), options);
        this.options = options;
        this.entityActions = new Subject();
    }
    // @internal
    /**
     * @return {?}
     */
    get selectEntityAction$() {
        return this.entityActions.asObservable();
    }
    // @internal
    /**
     * @return {?}
     */
    get idKey() {
        return ((/** @type {?} */ (this.config))).idKey || this.options.idKey || DEFAULT_ID_KEY;
    }
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @return {?}
     */
    set(entities) {
        if (isNil(entities))
            return;
        isDev() && setAction('Set Entity');
        /** @type {?} */
        const isNativePreAdd = this.akitaPreAddEntity === EntityStore.prototype.akitaPreAddEntity;
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => setEntities({
            state,
            entities,
            idKey: this.idKey,
            preAddEntity: this.akitaPreAddEntity,
            isNativePreAdd
        })));
        this.setHasCache(true, { restartTTL: true });
        if (this.hasInitialUIState()) {
            this.handleUICreation();
        }
        this.entityActions.next({ type: EntityActions.Set, ids: this.ids });
    }
    /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    add(entities, options = { loading: false }) {
        /** @type {?} */
        const collection = coerceArray(entities);
        if (isEmpty(collection))
            return;
        /** @type {?} */
        const data = addEntities({
            state: this._value(),
            preAddEntity: this.akitaPreAddEntity,
            entities: collection,
            idKey: this.idKey,
            options
        });
        if (data) {
            isDev() && setAction('Add Entity');
            data.newState.loading = options.loading;
            this._setState((/**
             * @return {?}
             */
            () => data.newState));
            if (this.hasInitialUIState()) {
                this.handleUICreation(true);
            }
            this.entityActions.next({ type: EntityActions.Add, ids: data.newIds });
        }
    }
    /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    update(idsOrFnOrState, newStateOrFn) {
        if (isUndefined(newStateOrFn)) {
            super.update((/** @type {?} */ (idsOrFnOrState)));
            return;
        }
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFnOrState)) {
            // We need to filter according the predicate function
            ids = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            id => ((/** @type {?} */ (idsOrFnOrState)))(this.entities[id])));
        }
        else {
            // If it's nil we want all of them
            ids = isNil(idsOrFnOrState) ? this.ids : coerceArray((/** @type {?} */ (idsOrFnOrState)));
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Update Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => updateEntities({
            idKey: this.idKey,
            ids,
            preUpdateEntity: this.akitaPreUpdateEntity,
            state,
            newStateOrFn
        })));
        this.entityActions.next({ type: EntityActions.Update, ids });
    }
    /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    upsert(ids, newState, options = {}) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        /** @type {?} */
        const predicate = (/**
         * @param {?} isUpdate
         * @return {?}
         */
        isUpdate => (/**
         * @param {?} id
         * @return {?}
         */
        id => hasEntity(this.entities, id) === isUpdate));
        /** @type {?} */
        const isClassBased = isFunction(options.baseClass);
        /** @type {?} */
        const updateIds = toArray.filter(predicate(true));
        /** @type {?} */
        const newEntities = toArray.filter(predicate(false)).map((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            let entity = isFunction(newState) ? newState((/** @type {?} */ ({}))) : newState;
            /** @type {?} */
            const withId = Object.assign({}, ((/** @type {?} */ (entity))), { [this.idKey]: id });
            if (isClassBased) {
                return new options.baseClass(withId);
            }
            return withId;
        }));
        // it can be any of the three types
        this.update((/** @type {?} */ (updateIds)), (/** @type {?} */ (newState)));
        this.add(newEntities);
        isDev() && logAction('Upsert Entity');
    }
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    upsertMany(entities, options = {}) {
        /** @type {?} */
        const addedIds = [];
        /** @type {?} */
        const updatedIds = [];
        /** @type {?} */
        const updatedEntities = {};
        // Update the state directly to optimize performance
        for (const entity of entities) {
            /** @type {?} */
            const withPreCheckHook = this.akitaPreCheckEntity(entity);
            /** @type {?} */
            const id = withPreCheckHook[this.idKey];
            if (hasEntity(this.entities, id)) {
                /** @type {?} */
                const prev = this._value().entities[id];
                /** @type {?} */
                const merged = Object.assign({}, this._value().entities[id], withPreCheckHook);
                /** @type {?} */
                const next = options.baseClass ? new options.baseClass(merged) : merged;
                /** @type {?} */
                const withHook = this.akitaPreUpdateEntity(prev, next);
                /** @type {?} */
                const nextId = withHook[this.idKey];
                updatedEntities[nextId] = withHook;
                updatedIds.push(nextId);
            }
            else {
                /** @type {?} */
                const newEntity = options.baseClass ? new options.baseClass(withPreCheckHook) : withPreCheckHook;
                /** @type {?} */
                const withHook = this.akitaPreAddEntity(newEntity);
                /** @type {?} */
                const nextId = withHook[this.idKey];
                addedIds.push(nextId);
                updatedEntities[nextId] = withHook;
            }
        }
        isDev() && logAction('Upsert Many');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { ids: addedIds.length ? [...state.ids, ...addedIds] : state.ids, entities: Object.assign({}, state.entities, updatedEntities), loading: !!options.loading }))));
        updatedIds.length && this.entityActions.next({ type: EntityActions.Update, ids: updatedIds });
        addedIds.length && this.entityActions.next({ type: EntityActions.Add, ids: addedIds });
        if (addedIds.length && this.hasUIStore()) {
            this.handleUICreation(true);
        }
    }
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    replace(ids, newState) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        let replaced = {};
        for (const id of toArray) {
            newState[this.idKey] = id;
            replaced[id] = newState;
        }
        isDev() && setAction('Replace Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { entities: Object.assign({}, state.entities, replaced) }))));
    }
    /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    move(from, to) {
        /** @type {?} */
        const ids = this.ids.slice();
        ids.splice(to < 0 ? ids.length + to : to, 0, ids.splice(from, 1)[0]);
        isDev() && setAction('Move Entity');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { entities: Object.assign({}, state.entities), ids }))));
    }
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    remove(idsOrFn) {
        if (isEmpty(this.ids))
            return;
        /** @type {?} */
        const idPassed = isDefined(idsOrFn);
        // null means remove all
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFn)) {
            ids = this.ids.filter((/**
             * @param {?} entityId
             * @return {?}
             */
            entityId => idsOrFn(this.entities[entityId])));
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Remove Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        (state) => removeEntities({ state, ids })));
        if (ids === null) {
            this.setHasCache(false);
        }
        this.handleUIRemove(ids);
        this.entityActions.next({ type: EntityActions.Remove, ids });
    }
    /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    updateActive(newStateOrCallback) {
        /** @type {?} */
        const ids = coerceArray(this.active);
        isDev() && setAction('Update Active', ids);
        this.update(ids, (/** @type {?} */ (newStateOrCallback)));
    }
    /**
     * @param {?} idOrOptions
     * @return {?}
     */
    setActive(idOrOptions) {
        /** @type {?} */
        const active = getActiveEntities(idOrOptions, this.ids, this.active);
        if (active === undefined) {
            return;
        }
        isDev() && setAction('Set Active', active);
        this._setActive(active);
    }
    /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    addActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        const everyExist = toArray.every((/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.indexOf(id) > -1));
        if (everyExist)
            return;
        isDev() && setAction('Add Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            /**
             * Protect against case that one of the items in the array exist
             * @type {?}
             */
            const uniques = Array.from(new Set([...((/** @type {?} */ (state.active))), ...toArray]));
            return Object.assign({}, state, { active: uniques });
        }));
    }
    /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    removeActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        const someExist = toArray.some((/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.indexOf(id) > -1));
        if (!someExist)
            return;
        isDev() && setAction('Remove Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            return Object.assign({}, state, { active: Array.isArray(state.active) ? state.active.filter((/**
                 * @param {?} currentId
                 * @return {?}
                 */
                currentId => toArray.indexOf(currentId) === -1)) : null });
        }));
    }
    /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    toggleActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        /** @type {?} */
        const filterExists = (/**
         * @param {?} remove
         * @return {?}
         */
        remove => (/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.includes(id) === remove));
        /** @type {?} */
        const remove = toArray.filter(filterExists(true));
        /** @type {?} */
        const add = toArray.filter(filterExists(false));
        this.removeActive(remove);
        this.addActive(add);
        isDev() && logAction('Toggle Active');
    }
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    createUIStore(initialState = {}, storeConfig = {}) {
        /** @type {?} */
        const defaults = { name: `UI/${this.storeName}`, idKey: this.idKey };
        this.ui = new EntityUIStore(initialState, Object.assign({}, defaults, storeConfig));
        return this.ui;
    }
    // @internal
    /**
     * @return {?}
     */
    destroy() {
        super.destroy();
        if (this.ui instanceof EntityStore) {
            this.ui.destroy();
        }
        this.entityActions.complete();
    }
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    akitaPreUpdateEntity(_, nextEntity) {
        return (/** @type {?} */ (nextEntity));
    }
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    akitaPreAddEntity(newEntity) {
        return (/** @type {?} */ (newEntity));
    }
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    akitaPreCheckEntity(newEntity) {
        return newEntity;
    }
    /**
     * @private
     * @return {?}
     */
    get ids() {
        return this._value().ids;
    }
    /**
     * @private
     * @return {?}
     */
    get entities() {
        return this._value().entities;
    }
    /**
     * @private
     * @return {?}
     */
    get active() {
        return this._value().active;
    }
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    _setActive(ids) {
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            return Object.assign({}, state, { active: ids });
        }));
    }
    /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    handleUICreation(add = false) {
        /** @type {?} */
        const ids = this.ids;
        /** @type {?} */
        const isFunc = isFunction(this.ui._akitaCreateEntityFn);
        /** @type {?} */
        let uiEntities;
        /** @type {?} */
        const createFn = (/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const current = this.entities[id];
            /** @type {?} */
            const ui = isFunc ? this.ui._akitaCreateEntityFn(current) : this.ui._akitaCreateEntityFn;
            return Object.assign({ [this.idKey]: current[this.idKey] }, ui);
        });
        if (add) {
            uiEntities = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            id => isUndefined(this.ui.entities[id]))).map(createFn);
        }
        else {
            uiEntities = ids.map(createFn);
        }
        add ? this.ui.add(uiEntities) : this.ui.set(uiEntities);
    }
    /**
     * @private
     * @return {?}
     */
    hasInitialUIState() {
        return this.hasUIStore() && isUndefined(this.ui._akitaCreateEntityFn) === false;
    }
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    handleUIRemove(ids) {
        if (this.hasUIStore()) {
            this.ui.remove(ids);
        }
    }
    /**
     * @private
     * @return {?}
     */
    hasUIStore() {
        return this.ui instanceof EntityUIStore;
    }
}
tslib_1.__decorate([
    transaction(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object, Object, Object]),
    tslib_1.__metadata("design:returntype", void 0)
], EntityStore.prototype, "upsert", null);
tslib_1.__decorate([
    transaction(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof T !== "undefined" && T) === "function" ? _a : Object]),
    tslib_1.__metadata("design:returntype", void 0)
], EntityStore.prototype, "toggleActive", null);
if (false) {
    /** @type {?} */
    EntityStore.prototype.ui;
    /**
     * @type {?}
     * @private
     */
    EntityStore.prototype.entityActions;
    /**
     * @type {?}
     * @protected
     */
    EntityStore.prototype.options;
}
// @internal
/**
 * @template UIState, DEPRECATED
 */
export class EntityUIStore extends EntityStore {
    /**
     * @param {?=} initialState
     * @param {?=} storeConfig
     */
    constructor(initialState = {}, storeConfig = {}) {
        super(initialState, storeConfig);
    }
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    setInitialEntityState(createFn) {
        this._akitaCreateEntityFn = createFn;
    }
}
if (false) {
    /** @type {?} */
    EntityUIStore.prototype._akitaCreateEntityFn;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5U3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvZW50aXR5U3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQWUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFaEMsT0FBTyxFQUFFLGlCQUFpQixFQUFvQixNQUFNLHFCQUFxQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFNUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFD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bkMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBZ0JELHFCQUFxQixDQUErQixRQUE0QztRQUM5RixJQUFJLENBQUMsb0JBQW9CLEdBQUcsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRjs7O0lBdkJDLDZDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICcuL2lzRW1wdHknO1xuaW1wb3J0IHsgU2V0RW50aXRpZXMsIHNldEVudGl0aWVzIH0gZnJvbSAnLi9zZXRFbnRpdGllcyc7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0b3IsIEVudGl0eVN0YXRlLCBFbnRpdHlVSUNyZWF0ZUZuLCBJRCwgSURTLCBPckFycmF5LCBTdGF0ZVdpdGhBY3RpdmUsIFVwZGF0ZUVudGl0eVByZWRpY2F0ZSwgVXBkYXRlU3RhdGVDYWxsYmFjaywgZ2V0RW50aXR5VHlwZSwgZ2V0SURUeXBlIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBnZXRBY3RpdmVFbnRpdGllcywgU2V0QWN0aXZlT3B0aW9ucyB9IGZyb20gJy4vZ2V0QWN0aXZlRW50aXRpZXMnO1xuaW1wb3J0IHsgYWRkRW50aXRpZXMsIEFkZEVudGl0aWVzT3B0aW9ucyB9IGZyb20gJy4vYWRkRW50aXRpZXMnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXkgfSBmcm9tICcuL2NvZXJjZUFycmF5JztcbmltcG9ydCB7IHJlbW92ZUVudGl0aWVzIH0gZnJvbSAnLi9yZW1vdmVFbnRpdGllcyc7XG5pbXBvcnQgeyBnZXRJbml0aWFsRW50aXRpZXNTdGF0ZSB9IGZyb20gJy4vZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUnO1xuaW1wb3J0IHsgaXNEZWZpbmVkIH0gZnJvbSAnLi9pc0RlZmluZWQnO1xuaW1wb3J0IHsgdXBkYXRlRW50aXRpZXMgfSBmcm9tICcuL3VwZGF0ZUVudGl0aWVzJztcbmltcG9ydCB7IHRyYW5zYWN0aW9uIH0gZnJvbSAnLi90cmFuc2FjdGlvbic7XG5pbXBvcnQgeyBpc05pbCB9IGZyb20gJy4vaXNOaWwnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4vaXNGdW5jdGlvbic7XG5pbXBvcnQgeyBpc1VuZGVmaW5lZCB9IGZyb20gJy4vaXNVbmRlZmluZWQnO1xuaW1wb3J0IHsgU3RvcmVDb25maWdPcHRpb25zIH0gZnJvbSAnLi9zdG9yZUNvbmZpZyc7XG5pbXBvcnQgeyBsb2dBY3Rpb24sIHNldEFjdGlvbiB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBpc0RldiB9IGZyb20gJy4vZW52JztcbmltcG9ydCB7IGhhc0VudGl0eSB9IGZyb20gJy4vaGFzRW50aXR5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEVudGl0eUFjdGlvbiwgRW50aXR5QWN0aW9ucyB9IGZyb20gJy4vZW50aXR5QWN0aW9ucyc7XG5pbXBvcnQgeyBERUZBVUxUX0lEX0tFWSB9IGZyb20gJy4vZGVmYXVsdElES2V5JztcblxuLyoqXG4gKlxuICogU3RvcmUgZm9yIG1hbmFnaW5nIGEgY29sbGVjdGlvbiBvZiBlbnRpdGllc1xuICpcbiAqIEBleGFtcGxlXG4gKlxuICogZXhwb3J0IGludGVyZmFjZSBXaWRnZXRzU3RhdGUgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxXaWRnZXQ+IHsgfVxuICpcbiAqIEBTdG9yZUNvbmZpZyh7IG5hbWU6ICd3aWRnZXRzJyB9KVxuICogIGV4cG9ydCBjbGFzcyBXaWRnZXRzU3RvcmUgZXh0ZW5kcyBFbnRpdHlTdG9yZTxXaWRnZXRzU3RhdGU+IHtcbiAqICAgY29uc3RydWN0b3IoKSB7XG4gKiAgICAgc3VwZXIoKTtcbiAqICAgfVxuICogfVxuICpcbiAqXG4gKi9cbmV4cG9ydCBjbGFzcyBFbnRpdHlTdG9yZTxTIGV4dGVuZHMgRW50aXR5U3RhdGUgPSBhbnksIEVudGl0eVR5cGUgPSBnZXRFbnRpdHlUeXBlPFM+LCBJRFR5cGUgPSBnZXRJRFR5cGU8Uz4+IGV4dGVuZHMgU3RvcmU8Uz4ge1xuICB1aTogRW50aXR5VUlTdG9yZTxhbnksIEVudGl0eVR5cGU+O1xuICBwcml2YXRlIGVudGl0eUFjdGlvbnMgPSBuZXcgU3ViamVjdDxFbnRpdHlBY3Rpb248SURUeXBlPj4oKTtcblxuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGU6IFBhcnRpYWw8Uz4gPSB7fSwgcHJvdGVjdGVkIG9wdGlvbnM6IFBhcnRpYWw8U3RvcmVDb25maWdPcHRpb25zPiA9IHt9KSB7XG4gICAgc3VwZXIoeyAuLi5nZXRJbml0aWFsRW50aXRpZXNTdGF0ZSgpLCAuLi5pbml0aWFsU3RhdGUgfSwgb3B0aW9ucyk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IHNlbGVjdEVudGl0eUFjdGlvbiQoKTogT2JzZXJ2YWJsZTxFbnRpdHlBY3Rpb248SURUeXBlPj4ge1xuICAgIHJldHVybiB0aGlzLmVudGl0eUFjdGlvbnMuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IGlkS2V5KCkge1xuICAgIHJldHVybiAodGhpcy5jb25maWcgYXMgU3RvcmVDb25maWdPcHRpb25zKS5pZEtleSB8fCB0aGlzLm9wdGlvbnMuaWRLZXkgfHwgREVGQVVMVF9JRF9LRVk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVwbGFjZSBjdXJyZW50IGNvbGxlY3Rpb24gd2l0aCBwcm92aWRlZCBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUuc2V0KFtFbnRpdHksIEVudGl0eV0pXG4gICAqIHRoaXMuc3RvcmUuc2V0KHtpZHM6IFtdLCBlbnRpdGllczoge319KVxuICAgKiB0aGlzLnN0b3JlLnNldCh7IDE6IHt9LCAyOiB7fX0pXG4gICAqXG4gICAqL1xuICBzZXQoZW50aXRpZXM6IFNldEVudGl0aWVzPEVudGl0eVR5cGU+KSB7XG4gICAgaWYgKGlzTmlsKGVudGl0aWVzKSkgcmV0dXJuO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBFbnRpdHknKTtcblxuICAgIGNvbnN0IGlzTmF0aXZlUHJlQWRkID0gdGhpcy5ha2l0YVByZUFkZEVudGl0eSA9PT0gRW50aXR5U3RvcmUucHJvdG90eXBlLmFraXRhUHJlQWRkRW50aXR5O1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+XG4gICAgICBzZXRFbnRpdGllcyh7XG4gICAgICAgIHN0YXRlLFxuICAgICAgICBlbnRpdGllcyxcbiAgICAgICAgaWRLZXk6IHRoaXMuaWRLZXksXG4gICAgICAgIHByZUFkZEVudGl0eTogdGhpcy5ha2l0YVByZUFkZEVudGl0eSxcbiAgICAgICAgaXNOYXRpdmVQcmVBZGRcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuc2V0SGFzQ2FjaGUodHJ1ZSwgeyByZXN0YXJ0VFRMOiB0cnVlIH0pO1xuXG4gICAgaWYgKHRoaXMuaGFzSW5pdGlhbFVJU3RhdGUoKSkge1xuICAgICAgdGhpcy5oYW5kbGVVSUNyZWF0aW9uKCk7XG4gICAgfVxuXG4gICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLlNldCwgaWRzOiB0aGlzLmlkcyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS5hZGQoW0VudGl0eSwgRW50aXR5XSlcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5KVxuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgcHJlcGVuZDogdHJ1ZSB9KVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgbG9hZGluZzogZmFsc2UgfSlcbiAgICovXG4gIGFkZChlbnRpdGllczogT3JBcnJheTxFbnRpdHlUeXBlPiwgb3B0aW9uczogQWRkRW50aXRpZXNPcHRpb25zID0geyBsb2FkaW5nOiBmYWxzZSB9KSB7XG4gICAgY29uc3QgY29sbGVjdGlvbiA9IGNvZXJjZUFycmF5KGVudGl0aWVzKTtcblxuICAgIGlmIChpc0VtcHR5KGNvbGxlY3Rpb24pKSByZXR1cm47XG5cbiAgICBjb25zdCBkYXRhID0gYWRkRW50aXRpZXMoe1xuICAgICAgc3RhdGU6IHRoaXMuX3ZhbHVlKCksXG4gICAgICBwcmVBZGRFbnRpdHk6IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHksXG4gICAgICBlbnRpdGllczogY29sbGVjdGlvbixcbiAgICAgIGlkS2V5OiB0aGlzLmlkS2V5LFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdBZGQgRW50aXR5Jyk7XG4gICAgICBkYXRhLm5ld1N0YXRlLmxvYWRpbmcgPSBvcHRpb25zLmxvYWRpbmc7XG5cbiAgICAgIHRoaXMuX3NldFN0YXRlKCgpID0+IGRhdGEubmV3U3RhdGUpO1xuXG4gICAgICBpZiAodGhpcy5oYXNJbml0aWFsVUlTdGF0ZSgpKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlVUlDcmVhdGlvbih0cnVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLkFkZCwgaWRzOiBkYXRhLm5ld0lkcyB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnVwZGF0ZSgxLCBlbnRpdHkgPT4gLi4uKVxuICAgKiBzdG9yZS51cGRhdGUoWzEsIDIsIDNdLCBlbnRpdHkgPT4gLi4uKVxuICAgKiBzdG9yZS51cGRhdGUobnVsbCwgZW50aXR5ID0+IC4uLilcbiAgICovXG4gIHVwZGF0ZShpZDogT3JBcnJheTxJRFR5cGU+IHwgbnVsbCwgbmV3U3RhdGVGbjogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPik7XG4gIC8qKlxuICAgKiBzdG9yZS51cGRhdGUoMSwgeyBuYW1lOiBuZXdOYW1lIH0pXG4gICAqL1xuICB1cGRhdGUoaWQ6IE9yQXJyYXk8SURUeXBlPiB8IG51bGwsIG5ld1N0YXRlOiBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgLyoqXG4gICAqIHN0b3JlLnVwZGF0ZShlbnRpdHkgPT4gZW50aXR5LnByaWNlID4gMywgZW50aXR5ID0+ICh7IG5hbWU6IG5ld05hbWUgfSkpXG4gICAqL1xuICB1cGRhdGUocHJlZGljYXRlOiBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sIG5ld1N0YXRlRm46IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4pO1xuICAvKipcbiAgICogc3RvcmUudXBkYXRlKGVudGl0eSA9PiBlbnRpdHkucHJpY2UgPiAzLCB7IG5hbWU6IG5ld05hbWUgfSlcbiAgICovXG4gIHVwZGF0ZShwcmVkaWNhdGU6IFVwZGF0ZUVudGl0eVByZWRpY2F0ZTxFbnRpdHlUeXBlPiwgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4pO1xuICAvKiogU3VwcG9ydCBub24tZW50aXR5IHVwZGF0ZXMgKi9cbiAgdXBkYXRlKG5ld1N0YXRlOiBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKFxuICAgIGlkc09yRm5PclN0YXRlOiBPckFycmF5PElEVHlwZT4gfCBudWxsIHwgUGFydGlhbDxTPiB8IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8Uz4gfCBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sXG4gICAgbmV3U3RhdGVPckZuPzogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IFBhcnRpYWw8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPFM+XG4gICkge1xuICAgIGlmIChpc1VuZGVmaW5lZChuZXdTdGF0ZU9yRm4pKSB7XG4gICAgICBzdXBlci51cGRhdGUoaWRzT3JGbk9yU3RhdGUgYXMgUGFydGlhbDxTPik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBpZHM6IElEVHlwZVtdID0gW107XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuT3JTdGF0ZSkpIHtcbiAgICAgIC8vIFdlIG5lZWQgdG8gZmlsdGVyIGFjY29yZGluZyB0aGUgcHJlZGljYXRlIGZ1bmN0aW9uXG4gICAgICBpZHMgPSB0aGlzLmlkcy5maWx0ZXIoaWQgPT4gKGlkc09yRm5PclN0YXRlIGFzIFVwZGF0ZUVudGl0eVByZWRpY2F0ZTxFbnRpdHlUeXBlPikodGhpcy5lbnRpdGllc1tpZF0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSWYgaXQncyBuaWwgd2Ugd2FudCBhbGwgb2YgdGhlbVxuICAgICAgaWRzID0gaXNOaWwoaWRzT3JGbk9yU3RhdGUpID8gdGhpcy5pZHMgOiBjb2VyY2VBcnJheShpZHNPckZuT3JTdGF0ZSBhcyBPckFycmF5PElEVHlwZT4pO1xuICAgIH1cblxuICAgIGlmIChpc0VtcHR5KGlkcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdVcGRhdGUgRW50aXR5JywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PlxuICAgICAgdXBkYXRlRW50aXRpZXMoe1xuICAgICAgICBpZEtleTogdGhpcy5pZEtleSxcbiAgICAgICAgaWRzLFxuICAgICAgICBwcmVVcGRhdGVFbnRpdHk6IHRoaXMuYWtpdGFQcmVVcGRhdGVFbnRpdHksXG4gICAgICAgIHN0YXRlLFxuICAgICAgICBuZXdTdGF0ZU9yRm5cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5VcGRhdGUsIGlkcyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDcmVhdGUgb3IgdXBkYXRlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnVwc2VydCgxLCB7IGFjdGl2ZTogdHJ1ZSB9KVxuICAgKiBzdG9yZS51cHNlcnQoWzIsIDNdLCB7IGFjdGl2ZTogdHJ1ZSB9KVxuICAgKiBzdG9yZS51cHNlcnQoWzIsIDNdLCBlbnRpdHkgPT4gKHsgaXNPcGVuOiAhZW50aXR5LmlzT3Blbn0pKVxuICAgKlxuICAgKi9cbiAgQHRyYW5zYWN0aW9uKClcbiAgdXBzZXJ0KGlkczogT3JBcnJheTxJRFR5cGU+LCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPiB8IEVudGl0eVR5cGUgfCBVcGRhdGVTdGF0ZUNhbGxiYWNrPEVudGl0eVR5cGU+IHwgRW50aXR5VHlwZVtdLCBvcHRpb25zOiB7IGJhc2VDbGFzcz86IENvbnN0cnVjdG9yIH0gPSB7fSkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGNvbnN0IHByZWRpY2F0ZSA9IGlzVXBkYXRlID0+IGlkID0+IGhhc0VudGl0eSh0aGlzLmVudGl0aWVzLCBpZCkgPT09IGlzVXBkYXRlO1xuICAgIGNvbnN0IGlzQ2xhc3NCYXNlZCA9IGlzRnVuY3Rpb24ob3B0aW9ucy5iYXNlQ2xhc3MpO1xuICAgIGNvbnN0IHVwZGF0ZUlkcyA9IHRvQXJyYXkuZmlsdGVyKHByZWRpY2F0ZSh0cnVlKSk7XG4gICAgY29uc3QgbmV3RW50aXRpZXMgPSB0b0FycmF5LmZpbHRlcihwcmVkaWNhdGUoZmFsc2UpKS5tYXAoaWQgPT4ge1xuICAgICAgbGV0IGVudGl0eSA9IGlzRnVuY3Rpb24obmV3U3RhdGUpID8gbmV3U3RhdGUoe30gYXMgRW50aXR5VHlwZSkgOiBuZXdTdGF0ZTtcbiAgICAgIGNvbnN0IHdpdGhJZCA9IHsgLi4uKGVudGl0eSBhcyBFbnRpdHlUeXBlKSwgW3RoaXMuaWRLZXldOiBpZCB9O1xuICAgICAgaWYgKGlzQ2xhc3NCYXNlZCkge1xuICAgICAgICByZXR1cm4gbmV3IG9wdGlvbnMuYmFzZUNsYXNzKHdpdGhJZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aElkO1xuICAgIH0pO1xuXG4gICAgLy8gaXQgY2FuIGJlIGFueSBvZiB0aGUgdGhyZWUgdHlwZXNcbiAgICB0aGlzLnVwZGF0ZSh1cGRhdGVJZHMgYXMgYW55LCBuZXdTdGF0ZSBhcyBhbnkpO1xuICAgIHRoaXMuYWRkKG5ld0VudGl0aWVzKTtcbiAgICBpc0RldigpICYmIGxvZ0FjdGlvbignVXBzZXJ0IEVudGl0eScpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwc2VydCBlbnRpdHkgY29sbGVjdGlvbiAoaWRLZXkgbXVzdCBiZSBwcmVzZW50KVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cHNlcnRNYW55KFsgeyBpZDogMSB9LCB7IGlkOiAyIH1dKTtcbiAgICpcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSwgeyBsb2FkaW5nOiB0cnVlICB9KTtcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSwgeyBiYXNlQ2xhc3M6IFRvZG8gIH0pO1xuICAgKlxuICAgKi9cbiAgdXBzZXJ0TWFueShlbnRpdGllczogRW50aXR5VHlwZVtdLCBvcHRpb25zOiB7IGJhc2VDbGFzcz86IENvbnN0cnVjdG9yOyBsb2FkaW5nPzogYm9vbGVhbiB9ID0ge30pIHtcbiAgICBjb25zdCBhZGRlZElkcyA9IFtdO1xuICAgIGNvbnN0IHVwZGF0ZWRJZHMgPSBbXTtcbiAgICBjb25zdCB1cGRhdGVkRW50aXRpZXMgPSB7fTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgc3RhdGUgZGlyZWN0bHkgdG8gb3B0aW1pemUgcGVyZm9ybWFuY2VcbiAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBlbnRpdGllcykge1xuICAgICAgY29uc3Qgd2l0aFByZUNoZWNrSG9vayA9IHRoaXMuYWtpdGFQcmVDaGVja0VudGl0eShlbnRpdHkpO1xuICAgICAgY29uc3QgaWQgPSB3aXRoUHJlQ2hlY2tIb29rW3RoaXMuaWRLZXldO1xuICAgICAgaWYgKGhhc0VudGl0eSh0aGlzLmVudGl0aWVzLCBpZCkpIHtcbiAgICAgICAgY29uc3QgcHJldiA9IHRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdO1xuICAgICAgICBjb25zdCBtZXJnZWQgPSB7IC4uLnRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdLCAuLi53aXRoUHJlQ2hlY2tIb29rIH07XG4gICAgICAgIGNvbnN0IG5leHQgPSBvcHRpb25zLmJhc2VDbGFzcyA/IG5ldyBvcHRpb25zLmJhc2VDbGFzcyhtZXJnZWQpIDogbWVyZ2VkO1xuICAgICAgICBjb25zdCB3aXRoSG9vayA9IHRoaXMuYWtpdGFQcmVVcGRhdGVFbnRpdHkocHJldiwgbmV4dCk7XG4gICAgICAgIGNvbnN0IG5leHRJZCA9IHdpdGhIb29rW3RoaXMuaWRLZXldO1xuICAgICAgICB1cGRhdGVkRW50aXRpZXNbbmV4dElkXSA9IHdpdGhIb29rO1xuICAgICAgICB1cGRhdGVkSWRzLnB1c2gobmV4dElkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5ld0VudGl0eSA9IG9wdGlvbnMuYmFzZUNsYXNzID8gbmV3IG9wdGlvbnMuYmFzZUNsYXNzKHdpdGhQcmVDaGVja0hvb2spIDogd2l0aFByZUNoZWNrSG9vaztcbiAgICAgICAgY29uc3Qgd2l0aEhvb2sgPSB0aGlzLmFraXRhUHJlQWRkRW50aXR5KG5ld0VudGl0eSk7XG4gICAgICAgIGNvbnN0IG5leHRJZCA9IHdpdGhIb29rW3RoaXMuaWRLZXldO1xuICAgICAgICBhZGRlZElkcy5wdXNoKG5leHRJZCk7XG4gICAgICAgIHVwZGF0ZWRFbnRpdGllc1tuZXh0SWRdID0gd2l0aEhvb2s7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1Vwc2VydCBNYW55Jyk7XG5cbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiAoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBpZHM6IGFkZGVkSWRzLmxlbmd0aCA/IFsuLi5zdGF0ZS5pZHMsIC4uLmFkZGVkSWRzXSA6IHN0YXRlLmlkcyxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICAuLi51cGRhdGVkRW50aXRpZXNcbiAgICAgIH0sXG4gICAgICBsb2FkaW5nOiAhIW9wdGlvbnMubG9hZGluZ1xuICAgIH0pKTtcblxuICAgIHVwZGF0ZWRJZHMubGVuZ3RoICYmIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5VcGRhdGUsIGlkczogdXBkYXRlZElkcyB9KTtcbiAgICBhZGRlZElkcy5sZW5ndGggJiYgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLkFkZCwgaWRzOiBhZGRlZElkcyB9KTtcbiAgICBpZiAoYWRkZWRJZHMubGVuZ3RoICYmIHRoaXMuaGFzVUlTdG9yZSgpKSB7XG4gICAgICB0aGlzLmhhbmRsZVVJQ3JlYXRpb24odHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlcGxhY2Ugb25lIG9yIG1vcmUgZW50aXRpZXMgKGV4Y2VwdCB0aGUgaWQgcHJvcGVydHkpXG4gICAqXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUucmVwbGFjZSg1LCBuZXdFbnRpdHkpXG4gICAqIHRoaXMuc3RvcmUucmVwbGFjZShbMSwyLDNdLCBuZXdFbnRpdHkpXG4gICAqL1xuICByZXBsYWNlKGlkczogSURTLCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPikge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgbGV0IHJlcGxhY2VkID0ge307XG4gICAgZm9yIChjb25zdCBpZCBvZiB0b0FycmF5KSB7XG4gICAgICBuZXdTdGF0ZVt0aGlzLmlkS2V5XSA9IGlkO1xuICAgICAgcmVwbGFjZWRbaWRdID0gbmV3U3RhdGU7XG4gICAgfVxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZXBsYWNlIEVudGl0eScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXMsXG4gICAgICAgIC4uLnJlcGxhY2VkXG4gICAgICB9XG4gICAgfSkpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIE1vdmUgZW50aXR5IGluc2lkZSB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLm1vdmUoZnJvbUluZGV4LCB0b0luZGV4KVxuICAgKi9cbiAgbW92ZShmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpIHtcbiAgICBjb25zdCBpZHMgPSB0aGlzLmlkcy5zbGljZSgpO1xuICAgIGlkcy5zcGxpY2UodG8gPCAwID8gaWRzLmxlbmd0aCArIHRvIDogdG8sIDAsIGlkcy5zcGxpY2UoZnJvbSwgMSlbMF0pO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ01vdmUgRW50aXR5Jyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgLy8gQ2hhbmdlIHRoZSBlbnRpdGllcyByZWZlcmVuY2Ugc28gdGhhdCBzZWxlY3RBbGwgZW1pdFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXNcbiAgICAgIH0sXG4gICAgICBpZHNcbiAgICB9KSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVtb3ZlIG9uZSBvciBtb3JlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKDUpXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKFsxLDIsM10pXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKClcbiAgICovXG4gIHJlbW92ZShpZD86IE9yQXJyYXk8SURUeXBlPik7XG4gIC8qKlxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShlbnRpdHkgPT4gZW50aXR5LmlkID09PSAxKVxuICAgKi9cbiAgcmVtb3ZlKHByZWRpY2F0ZTogKGVudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pID0+IGJvb2xlYW4pO1xuICByZW1vdmUoaWRzT3JGbj86IE9yQXJyYXk8SURUeXBlPiB8ICgoZW50aXR5OiBSZWFkb25seTxFbnRpdHlUeXBlPikgPT4gYm9vbGVhbikpIHtcbiAgICBpZiAoaXNFbXB0eSh0aGlzLmlkcykpIHJldHVybjtcblxuICAgIGNvbnN0IGlkUGFzc2VkID0gaXNEZWZpbmVkKGlkc09yRm4pO1xuXG4gICAgLy8gbnVsbCBtZWFucyByZW1vdmUgYWxsXG4gICAgbGV0IGlkczogSURUeXBlW10gfCBudWxsID0gW107XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuKSkge1xuICAgICAgaWRzID0gdGhpcy5pZHMuZmlsdGVyKGVudGl0eUlkID0+IGlkc09yRm4odGhpcy5lbnRpdGllc1tlbnRpdHlJZF0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWRzID0gaWRQYXNzZWQgPyBjb2VyY2VBcnJheShpZHNPckZuKSA6IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGlzRW1wdHkoaWRzKSkgcmV0dXJuO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1JlbW92ZSBFbnRpdHknLCBpZHMpO1xuICAgIHRoaXMuX3NldFN0YXRlKChzdGF0ZTogU3RhdGVXaXRoQWN0aXZlPFM+KSA9PiByZW1vdmVFbnRpdGllcyh7IHN0YXRlLCBpZHMgfSkpO1xuICAgIGlmIChpZHMgPT09IG51bGwpIHtcbiAgICAgIHRoaXMuc2V0SGFzQ2FjaGUoZmFsc2UpO1xuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlVUlSZW1vdmUoaWRzKTtcbiAgICB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuUmVtb3ZlLCBpZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIHRoZSBhY3RpdmUgZW50aXR5XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlQWN0aXZlKHsgY29tcGxldGVkOiB0cnVlIH0pXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlQWN0aXZlKGFjdGl2ZSA9PiB7XG4gICAqICAgcmV0dXJuIHtcbiAgICogICAgIGNvbmZpZzoge1xuICAgKiAgICAgIC4uYWN0aXZlLmNvbmZpZyxcbiAgICogICAgICBkYXRlXG4gICAqICAgICB9XG4gICAqICAgfVxuICAgKiB9KVxuICAgKi9cbiAgdXBkYXRlQWN0aXZlKG5ld1N0YXRlT3JDYWxsYmFjazogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IFBhcnRpYWw8RW50aXR5VHlwZT4pIHtcbiAgICBjb25zdCBpZHMgPSBjb2VyY2VBcnJheSh0aGlzLmFjdGl2ZSk7XG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1VwZGF0ZSBBY3RpdmUnLCBpZHMpO1xuICAgIHRoaXMudXBkYXRlKGlkcywgbmV3U3RhdGVPckNhbGxiYWNrIGFzIFBhcnRpYWw8RW50aXR5VHlwZT4pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZ2l2ZW4gZW50aXR5IGFzIGFjdGl2ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5zZXRBY3RpdmUoMSlcbiAgICogc3RvcmUuc2V0QWN0aXZlKFsxLCAyLCAzXSlcbiAgICovXG4gIHNldEFjdGl2ZShpZE9yT3B0aW9uczogU1snYWN0aXZlJ10gZXh0ZW5kcyBhbnlbXSA/IFNbJ2FjdGl2ZSddIDogKFNldEFjdGl2ZU9wdGlvbnMgfCBTWydhY3RpdmUnXSkpO1xuICBzZXRBY3RpdmUoaWRPck9wdGlvbnM6IElEVHlwZSB8IFNldEFjdGl2ZU9wdGlvbnMgfCBudWxsKSB7XG4gICAgY29uc3QgYWN0aXZlID0gZ2V0QWN0aXZlRW50aXRpZXMoaWRPck9wdGlvbnMsIHRoaXMuaWRzLCB0aGlzLmFjdGl2ZSk7XG5cbiAgICBpZiAoYWN0aXZlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignU2V0IEFjdGl2ZScsIGFjdGl2ZSk7XG4gICAgdGhpcy5fc2V0QWN0aXZlKGFjdGl2ZSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFjdGl2ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5hZGRBY3RpdmUoMik7XG4gICAqIHN0b3JlLmFkZEFjdGl2ZShbMywgNCwgNV0pO1xuICAgKi9cbiAgYWRkQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgY29uc3QgZXZlcnlFeGlzdCA9IHRvQXJyYXkuZXZlcnkoaWQgPT4gdGhpcy5hY3RpdmUuaW5kZXhPZihpZCkgPiAtMSk7XG4gICAgaWYgKGV2ZXJ5RXhpc3QpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdBZGQgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICAvKiogUHJvdGVjdCBhZ2FpbnN0IGNhc2UgdGhhdCBvbmUgb2YgdGhlIGl0ZW1zIGluIHRoZSBhcnJheSBleGlzdCAqL1xuICAgICAgY29uc3QgdW5pcXVlcyA9IEFycmF5LmZyb20obmV3IFNldChbLi4uKHN0YXRlLmFjdGl2ZSBhcyBJRFR5cGVbXSksIC4uLnRvQXJyYXldKSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgYWN0aXZlOiB1bmlxdWVzXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhY3RpdmUgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUucmVtb3ZlQWN0aXZlKDIpXG4gICAqIHN0b3JlLnJlbW92ZUFjdGl2ZShbMywgNCwgNV0pXG4gICAqL1xuICByZW1vdmVBY3RpdmU8VCA9IE9yQXJyYXk8SURUeXBlPj4oaWRzOiBUKSB7XG4gICAgY29uc3QgdG9BcnJheSA9IGNvZXJjZUFycmF5KGlkcyk7XG4gICAgaWYgKGlzRW1wdHkodG9BcnJheSkpIHJldHVybjtcbiAgICBjb25zdCBzb21lRXhpc3QgPSB0b0FycmF5LnNvbWUoaWQgPT4gdGhpcy5hY3RpdmUuaW5kZXhPZihpZCkgPiAtMSk7XG4gICAgaWYgKCFzb21lRXhpc3QpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZW1vdmUgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgYWN0aXZlOiBBcnJheS5pc0FycmF5KHN0YXRlLmFjdGl2ZSkgPyBzdGF0ZS5hY3RpdmUuZmlsdGVyKGN1cnJlbnRJZCA9PiB0b0FycmF5LmluZGV4T2YoY3VycmVudElkKSA9PT0gLTEpIDogbnVsbFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUb2dnbGUgYWN0aXZlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnRvZ2dsZSgyKVxuICAgKiBzdG9yZS50b2dnbGUoWzMsIDQsIDVdKVxuICAgKi9cbiAgQHRyYW5zYWN0aW9uKClcbiAgdG9nZ2xlQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGNvbnN0IGZpbHRlckV4aXN0cyA9IHJlbW92ZSA9PiBpZCA9PiB0aGlzLmFjdGl2ZS5pbmNsdWRlcyhpZCkgPT09IHJlbW92ZTtcbiAgICBjb25zdCByZW1vdmUgPSB0b0FycmF5LmZpbHRlcihmaWx0ZXJFeGlzdHModHJ1ZSkpO1xuICAgIGNvbnN0IGFkZCA9IHRvQXJyYXkuZmlsdGVyKGZpbHRlckV4aXN0cyhmYWxzZSkpO1xuICAgIHRoaXMucmVtb3ZlQWN0aXZlKHJlbW92ZSk7XG4gICAgdGhpcy5hZGRBY3RpdmUoYWRkKTtcbiAgICBpc0RldigpICYmIGxvZ0FjdGlvbignVG9nZ2xlIEFjdGl2ZScpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIENyZWF0ZSBzdWIgVUkgc3RvcmUgZm9yIG1hbmFnaW5nIEVudGl0eSdzIFVJIHN0YXRlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIGV4cG9ydCB0eXBlIFByb2R1Y3RVSSA9IHtcbiAgICogICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gICAqICAgaXNPcGVuOiBib29sZWFuXG4gICAqIH1cbiAgICpcbiAgICogaW50ZXJmYWNlIFByb2R1Y3RzVUlTdGF0ZSBleHRlbmRzIEVudGl0eVN0YXRlPFByb2R1Y3RVST4ge31cbiAgICpcbiAgICogZXhwb3J0IGNsYXNzIFByb2R1Y3RzU3RvcmUgRW50aXR5U3RvcmU8UHJvZHVjdHNTdGF0ZSwgUHJvZHVjdD4ge1xuICAgKiAgIHVpOiBFbnRpdHlVSVN0b3JlPFByb2R1Y3RzVUlTdGF0ZSwgUHJvZHVjdFVJPjtcbiAgICpcbiAgICogICBjb25zdHJ1Y3RvcigpIHtcbiAgICogICAgIHN1cGVyKCk7XG4gICAqICAgICB0aGlzLmNyZWF0ZVVJU3RvcmUoKTtcbiAgICogICB9XG4gICAqXG4gICAqIH1cbiAgICovXG4gIGNyZWF0ZVVJU3RvcmUoaW5pdGlhbFN0YXRlID0ge30sIHN0b3JlQ29uZmlnOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIGNvbnN0IGRlZmF1bHRzOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7IG5hbWU6IGBVSS8ke3RoaXMuc3RvcmVOYW1lfWAsIGlkS2V5OiB0aGlzLmlkS2V5IH07XG4gICAgdGhpcy51aSA9IG5ldyBFbnRpdHlVSVN0b3JlKGluaXRpYWxTdGF0ZSwgeyAuLi5kZWZhdWx0cywgLi4uc3RvcmVDb25maWcgfSk7XG4gICAgcmV0dXJuIHRoaXMudWk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZGVzdHJveSgpIHtcbiAgICBzdXBlci5kZXN0cm95KCk7XG4gICAgaWYgKHRoaXMudWkgaW5zdGFuY2VvZiBFbnRpdHlTdG9yZSkge1xuICAgICAgdGhpcy51aS5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlVXBkYXRlRW50aXR5KF86IFJlYWRvbmx5PEVudGl0eVR5cGU+LCBuZXh0RW50aXR5OiBhbnkpOiBFbnRpdHlUeXBlIHtcbiAgICByZXR1cm4gbmV4dEVudGl0eSBhcyBFbnRpdHlUeXBlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlQWRkRW50aXR5KG5ld0VudGl0eTogYW55KTogRW50aXR5VHlwZSB7XG4gICAgcmV0dXJuIG5ld0VudGl0eSBhcyBFbnRpdHlUeXBlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlQ2hlY2tFbnRpdHkobmV3RW50aXR5OiBSZWFkb25seTxFbnRpdHlUeXBlPik6IEVudGl0eVR5cGUge1xuICAgIHJldHVybiBuZXdFbnRpdHk7XG4gIH1cblxuICBwcml2YXRlIGdldCBpZHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuaWRzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgZW50aXRpZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXM7XG4gIH1cblxuICBwcml2YXRlIGdldCBhY3RpdmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuYWN0aXZlO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0QWN0aXZlKGlkczogT3JBcnJheTxJRFR5cGU+KSB7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogaWRzXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVVSUNyZWF0aW9uKGFkZCA9IGZhbHNlKSB7XG4gICAgY29uc3QgaWRzID0gdGhpcy5pZHM7XG4gICAgY29uc3QgaXNGdW5jID0gaXNGdW5jdGlvbih0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuKTtcbiAgICBsZXQgdWlFbnRpdGllcztcbiAgICBjb25zdCBjcmVhdGVGbiA9IGlkID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmVudGl0aWVzW2lkXTtcbiAgICAgIGNvbnN0IHVpID0gaXNGdW5jID8gdGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbihjdXJyZW50KSA6IHRoaXMudWkuX2FraXRhQ3JlYXRlRW50aXR5Rm47XG4gICAgICByZXR1cm4ge1xuICAgICAgICBbdGhpcy5pZEtleV06IGN1cnJlbnRbdGhpcy5pZEtleV0sXG4gICAgICAgIC4uLnVpXG4gICAgICB9O1xuICAgIH07XG5cbiAgICBpZiAoYWRkKSB7XG4gICAgICB1aUVudGl0aWVzID0gdGhpcy5pZHMuZmlsdGVyKGlkID0+IGlzVW5kZWZpbmVkKHRoaXMudWkuZW50aXRpZXNbaWRdKSkubWFwKGNyZWF0ZUZuKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdWlFbnRpdGllcyA9IGlkcy5tYXAoY3JlYXRlRm4pO1xuICAgIH1cblxuICAgIGFkZCA/IHRoaXMudWkuYWRkKHVpRW50aXRpZXMpIDogdGhpcy51aS5zZXQodWlFbnRpdGllcyk7XG4gIH1cblxuICBwcml2YXRlIGhhc0luaXRpYWxVSVN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLmhhc1VJU3RvcmUoKSAmJiBpc1VuZGVmaW5lZCh0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuKSA9PT0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVVJUmVtb3ZlKGlkczogSURUeXBlW10pIHtcbiAgICBpZiAodGhpcy5oYXNVSVN0b3JlKCkpIHtcbiAgICAgIHRoaXMudWkucmVtb3ZlKGlkcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNVSVN0b3JlKCkge1xuICAgIHJldHVybiB0aGlzLnVpIGluc3RhbmNlb2YgRW50aXR5VUlTdG9yZTtcbiAgfVxufVxuXG4vLyBAaW50ZXJuYWxcbmV4cG9ydCBjbGFzcyBFbnRpdHlVSVN0b3JlPFVJU3RhdGUsIERFUFJFQ0FURUQgPSBhbnk+IGV4dGVuZHMgRW50aXR5U3RvcmU8VUlTdGF0ZT4ge1xuICBfYWtpdGFDcmVhdGVFbnRpdHlGbjogRW50aXR5VUlDcmVhdGVGbjtcblxuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGUgPSB7fSwgc3RvcmVDb25maWc6IFBhcnRpYWw8U3RvcmVDb25maWdPcHRpb25zPiA9IHt9KSB7XG4gICAgc3VwZXIoaW5pdGlhbFN0YXRlLCBzdG9yZUNvbmZpZyk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogU2V0IHRoZSBpbml0aWFsIFVJIGVudGl0eSBzdGF0ZS4gVGhpcyBmdW5jdGlvbiB3aWxsIGRldGVybWluZSB0aGUgZW50aXR5J3NcbiAgICogaW5pdGlhbCBzdGF0ZSB3aGVuIHdlIGNhbGwgYHNldCgpYCBvciBgYWRkKClgLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBjb25zdHJ1Y3RvcigpIHtcbiAgICogICBzdXBlcigpO1xuICAgKiAgIHRoaXMuY3JlYXRlVUlTdG9yZSgpLnNldEluaXRpYWxFbnRpdHlTdGF0ZShlbnRpdHkgPT4gKHsgaXNMb2FkaW5nOiBmYWxzZSwgaXNPcGVuOiB0cnVlIH0pKTtcbiAgICogICB0aGlzLmNyZWF0ZVVJU3RvcmUoKS5zZXRJbml0aWFsRW50aXR5U3RhdGUoeyBpc0xvYWRpbmc6IGZhbHNlLCBpc09wZW46IHRydWUgfSk7XG4gICAqIH1cbiAgICpcbiAgICovXG4gIHNldEluaXRpYWxFbnRpdHlTdGF0ZTxFbnRpdHlVSSA9IGFueSwgRW50aXR5ID0gYW55PihjcmVhdGVGbjogRW50aXR5VUlDcmVhdGVGbjxFbnRpdHlVSSwgRW50aXR5Pikge1xuICAgIHRoaXMuX2FraXRhQ3JlYXRlRW50aXR5Rm4gPSBjcmVhdGVGbjtcbiAgfVxufVxuIl19