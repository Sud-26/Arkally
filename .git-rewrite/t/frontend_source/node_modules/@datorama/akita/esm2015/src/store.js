/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { resetCustomAction, setAction } from './actions';
import { getAkitaConfig } from './config';
import { deepFreeze } from './deepFreeze';
import { dispatchAdded, dispatchDeleted, dispatchUpdate } from './dispatchers';
import { __DEV__, isDev } from './env';
import { assertStoreHasName } from './errors';
import { isDefined } from './isDefined';
import { isFunction } from './isFunction';
import { isPlainObject } from './isPlainObject';
import { isBrowser } from './root';
import { configKey } from './storeConfig';
import { __stores__ } from './stores';
import { commit, isTransactionInProcess } from './transaction';
/**
 *
 * Store for managing any type of data
 *
 * \@example
 *
 * export interface SessionState {
 *   token: string;
 *   userDetails: UserDetails
 * }
 *
 * export function createInitialState(): SessionState {
 *  return {
 *    token: '',
 *    userDetails: null
 *  };
 * }
 *
 * \@StoreConfig({ name: 'session' })
 * export class SessionStore extends Store<SessionState> {
 *   constructor() {
 *    super(createInitialState());
 *   }
 * }
 * @template S
 */
export class Store {
    /**
     * @param {?} initialState
     * @param {?=} options
     */
    constructor(initialState, options = {}) {
        this.options = options;
        this.inTransaction = false;
        this.cache = {
            active: new BehaviorSubject(false),
            ttl: null
        };
        this.onInit((/** @type {?} */ (initialState)));
    }
    /**
     *  Set the loading state
     *
     * \@example
     *
     *  store.setLoading(true)
     *
     * @param {?=} loading
     * @return {?}
     */
    setLoading(loading = false) {
        if (loading !== ((/** @type {?} */ (this._value()))).loading) {
            isDev() && setAction('Set Loading');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            state => ((/** @type {?} */ (Object.assign({}, state, { loading }))))));
        }
    }
    /**
     *
     * Set whether the data is cached
     *
     * \@example
     *
     * store.setHasCache(true)
     * store.setHasCache(false)
     * store.setHasCache(true, { restartTTL: true })
     *
     * @param {?} hasCache
     * @param {?=} options
     * @return {?}
     */
    setHasCache(hasCache, options = { restartTTL: false }) {
        if (hasCache !== this.cache.active.value) {
            this.cache.active.next(hasCache);
        }
        if (options.restartTTL) {
            /** @type {?} */
            const ttlConfig = this.getCacheTTL();
            if (ttlConfig) {
                if (this.cache.ttl !== null) {
                    clearTimeout(this.cache.ttl);
                }
                this.cache.ttl = (/** @type {?} */ (setTimeout((/**
                 * @return {?}
                 */
                () => this.setHasCache(false)), ttlConfig)));
            }
        }
    }
    /**
     *
     * Sometimes we need to access the store value from a store
     *
     * \@example middleware
     *
     * @return {?}
     */
    getValue() {
        return this.storeValue;
    }
    /**
     *  Set the error state
     *
     * \@example
     *
     *  store.setError({text: 'unable to load data' })
     *
     * @template T
     * @param {?} error
     * @return {?}
     */
    setError(error) {
        if (error !== ((/** @type {?} */ (this._value()))).error) {
            isDev() && setAction('Set Error');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            state => ((/** @type {?} */ (Object.assign({}, state, { error }))))));
        }
    }
    // @internal
    /**
     * @template R
     * @param {?} project
     * @return {?}
     */
    _select(project) {
        return this.store.asObservable().pipe(map(project), distinctUntilChanged());
    }
    // @internal
    /**
     * @return {?}
     */
    _value() {
        return this.storeValue;
    }
    // @internal
    /**
     * @return {?}
     */
    _cache() {
        return this.cache.active;
    }
    // @internal
    /**
     * @return {?}
     */
    get config() {
        return this.constructor[configKey] || {};
    }
    // @internal
    /**
     * @return {?}
     */
    get storeName() {
        return ((/** @type {?} */ (this.config))).storeName || ((/** @type {?} */ (this.options))).storeName || this.options.name;
    }
    // @internal
    /**
     * @return {?}
     */
    get deepFreeze() {
        return this.config.deepFreezeFn || this.options.deepFreezeFn || deepFreeze;
    }
    // @internal
    /**
     * @return {?}
     */
    get cacheConfig() {
        return this.config.cache || this.options.cache;
    }
    // @internal
    /**
     * @return {?}
     */
    get resettable() {
        return isDefined(this.config.resettable) ? this.config.resettable : this.options.resettable;
    }
    // @internal
    /**
     * @param {?} newStateFn
     * @param {?=} _dispatchAction
     * @return {?}
     */
    _setState(newStateFn, _dispatchAction = true) {
        this.storeValue = __DEV__ ? this.deepFreeze(newStateFn(this._value())) : newStateFn(this._value());
        if (!this.store) {
            this.store = new BehaviorSubject(this.storeValue);
            return;
        }
        if (isTransactionInProcess()) {
            this.handleTransaction();
            return;
        }
        this.dispatch(this.storeValue, _dispatchAction);
    }
    /**
     *
     * Reset the current store back to the initial value
     *
     * \@example
     *
     * store.reset()
     *
     * @return {?}
     */
    reset() {
        if (this.isResettable()) {
            isDev() && setAction('Reset');
            this._setState((/**
             * @return {?}
             */
            () => Object.assign({}, this._initialState)));
            this.setHasCache(false);
        }
        else {
            isDev() && console.warn(`You need to enable the reset functionality`);
        }
    }
    /**
     * @param {?} stateOrCallback
     * @return {?}
     */
    update(stateOrCallback) {
        isDev() && setAction('Update');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            /** @type {?} */
            const newState = isFunction(stateOrCallback) ? stateOrCallback(state) : stateOrCallback;
            /** @type {?} */
            const merged = this.akitaPreUpdate(state, (/** @type {?} */ (Object.assign({}, state, newState))));
            return isPlainObject(state) ? merged : new ((/** @type {?} */ (state))).constructor(merged);
        }));
    }
    /**
     * @param {?} newOptions
     * @return {?}
     */
    updateStoreConfig(newOptions) {
        this.options = Object.assign({}, this.options, newOptions);
    }
    // @internal
    /**
     * @param {?} _
     * @param {?} nextState
     * @return {?}
     */
    akitaPreUpdate(_, nextState) {
        return nextState;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
    }
    /**
     *
     * Destroy the store
     *
     * \@example
     *
     * store.destroy()
     *
     * @return {?}
     */
    destroy() {
        /** @type {?} */
        const hmrEnabled = isBrowser ? ((/** @type {?} */ (window))).hmrEnabled : false;
        if (!hmrEnabled && this === __stores__[this.storeName]) {
            delete __stores__[this.storeName];
            dispatchDeleted(this.storeName);
            this.setHasCache(false);
            this.cache.active.complete();
        }
    }
    /**
     * @private
     * @param {?} initialState
     * @return {?}
     */
    onInit(initialState) {
        __stores__[this.storeName] = this;
        this._setState((/**
         * @return {?}
         */
        () => initialState));
        dispatchAdded(this.storeName);
        if (this.isResettable()) {
            this._initialState = initialState;
        }
        isDev() && assertStoreHasName(this.storeName, this.constructor.name);
    }
    /**
     * @private
     * @param {?} state
     * @param {?=} _dispatchAction
     * @return {?}
     */
    dispatch(state, _dispatchAction = true) {
        this.store.next(state);
        if (_dispatchAction) {
            dispatchUpdate(this.storeName);
            resetCustomAction();
        }
    }
    /**
     * @private
     * @return {?}
     */
    watchTransaction() {
        commit().subscribe((/**
         * @return {?}
         */
        () => {
            this.inTransaction = false;
            this.dispatch(this._value());
        }));
    }
    /**
     * @private
     * @return {?}
     */
    isResettable() {
        if (this.resettable === false) {
            return false;
        }
        return this.resettable || getAkitaConfig().resettable;
    }
    /**
     * @private
     * @return {?}
     */
    handleTransaction() {
        if (!this.inTransaction) {
            this.watchTransaction();
            this.inTransaction = true;
        }
    }
    /**
     * @private
     * @return {?}
     */
    getCacheTTL() {
        return (this.cacheConfig && this.cacheConfig.ttl) || getAkitaConfig().ttl;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    Store.prototype.store;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.storeValue;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.inTransaction;
    /**
     * @type {?}
     * @private
     */
    Store.prototype._initialState;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.cache;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUN2QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxTQUFTLEVBQW1ELE1BQU0sZUFBZSxDQUFDO0FBQzNGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFdEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBNEIvRCxNQUFNLE9BQU8sS0FBSzs7Ozs7SUFVaEIsWUFBWSxZQUF3QixFQUFZLFVBQXVDLEVBQUU7UUFBekMs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S0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QixJQUFJLGVBQWUsRUFBRTtZQUNuQixjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQy9CLGlCQUFpQixFQUFFLENBQUM7U0FDckI7SUFDSCxDQUFDOzs7OztJQUVPLGdCQUFnQjtRQUN0QixNQUFNLEVBQUUsQ0FBQyxTQUFTOzs7UUFBQyxHQUFHLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7WUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUMvQixDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRU8sWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssS0FBSyxFQUFFO1lBQzdCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLElBQUksY0FBYyxFQUFFLENBQUMsVUFBVSxDQUFDO0lBQ3hELENBQUM7Ozs7O0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQzs7Ozs7SUFFTyxXQUFXO1FBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksY0FBYyxFQUFFLENBQUMsR0FBRyxDQUFDO0lBQzVFLENBQUM7Q0FDRjs7Ozs7O0lBdFFDLHNCQUE0Qzs7Ozs7SUFDNUMsMkJBQXNCOzs7OztJQUN0Qiw4QkFBOEI7Ozs7O0lBQzlCLDhCQUF5Qjs7Ozs7SUFDekIsc0JBR0U7Ozs7O0lBRW9DLHdCQUFtRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHJlc2V0Q3VzdG9tQWN0aW9uLCBzZXRBY3Rpb24gfSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgZ2V0QWtpdGFDb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBkZWVwRnJlZXplIH0gZnJvbSAnLi9kZWVwRnJlZXplJztcbmltcG9ydCB7IGRpc3BhdGNoQWRkZWQsIGRpc3BhdGNoRGVsZXRlZCwgZGlzcGF0Y2hVcGRhdGUgfSBmcm9tICcuL2Rpc3BhdGNoZXJzJztcbmltcG9ydCB7IF9fREVWX18sIGlzRGV2IH0gZnJvbSAnLi9lbnYnO1xuaW1wb3J0IHsgYXNzZXJ0U3RvcmVIYXNOYW1lIH0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgaXNEZWZpbmVkIH0gZnJvbSAnLi9pc0RlZmluZWQnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4vaXNGdW5jdGlvbic7XG5pbXBvcnQgeyBpc1BsYWluT2JqZWN0IH0gZnJvbSAnLi9pc1BsYWluT2JqZWN0JztcbmltcG9ydCB7IGlzQnJvd3NlciB9IGZyb20gJy4vcm9vdCc7XG5pbXBvcnQgeyBjb25maWdLZXksIFN0b3JlQ29uZmlnT3B0aW9ucywgVXBkYXRhYmxlU3RvcmVDb25maWdPcHRpb25zIH0gZnJvbSAnLi9zdG9yZUNvbmZpZyc7XG5pbXBvcnQgeyBfX3N0b3Jlc19fIH0gZnJvbSAnLi9zdG9yZXMnO1xuaW1wb3J0IHsgdG9Cb29sZWFuIH0gZnJvbSAnLi90b0Jvb2xlYW4nO1xuaW1wb3J0IHsgY29tbWl0LCBpc1RyYW5zYWN0aW9uSW5Qcm9jZXNzIH0gZnJvbSAnLi90cmFuc2FjdGlvbic7XG5pbXBvcnQgeyBTdG9yZUNhY2hlLCBVcGRhdGVTdGF0ZUNhbGxiYWNrIH0gZnJvbSAnLi90eXBlcyc7XG5cbi8qKlxuICpcbiAqIFN0b3JlIGZvciBtYW5hZ2luZyBhbnkgdHlwZSBvZiBkYXRhXG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiBleHBvcnQgaW50ZXJmYWNlIFNlc3Npb25TdGF0ZSB7XG4gKiAgIHRva2VuOiBzdHJpbmc7XG4gKiAgIHVzZXJEZXRhaWxzOiBVc2VyRGV0YWlsc1xuICogfVxuICpcbiAqIGV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbml0aWFsU3RhdGUoKTogU2Vzc2lvblN0YXRlIHtcbiAqICByZXR1cm4ge1xuICogICAgdG9rZW46ICcnLFxuICogICAgdXNlckRldGFpbHM6IG51bGxcbiAqICB9O1xuICogfVxuICpcbiAqIEBTdG9yZUNvbmZpZyh7IG5hbWU6ICdzZXNzaW9uJyB9KVxuICogZXhwb3J0IGNsYXNzIFNlc3Npb25TdG9yZSBleHRlbmRzIFN0b3JlPFNlc3Npb25TdGF0ZT4ge1xuICogICBjb25zdHJ1Y3RvcigpIHtcbiAqICAgIHN1cGVyKGNyZWF0ZUluaXRpYWxTdGF0ZSgpKTtcbiAqICAgfVxuICogfVxuICovXG5leHBvcnQgY2xhc3MgU3RvcmU8UyA9IGFueT4ge1xuICBwcml2YXRlIHN0b3JlOiBCZWhhdmlvclN1YmplY3Q8UmVhZG9ubHk8Uz4+O1xuICBwcml2YXRlIHN0b3JlVmFsdWU6IFM7XG4gIHByaXZhdGUgaW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xuICBwcml2YXRlIF9pbml0aWFsU3RhdGU6IFM7XG4gIHByb3RlY3RlZCBjYWNoZTogU3RvcmVDYWNoZSA9IHtcbiAgICBhY3RpdmU6IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpLFxuICAgIHR0bDogbnVsbFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGluaXRpYWxTdGF0ZTogUGFydGlhbDxTPiwgcHJvdGVjdGVkIG9wdGlvbnM6IFBhcnRpYWw8U3RvcmVDb25maWdPcHRpb25zPiA9IHt9KSB7XG4gICAgdGhpcy5vbkluaXQoaW5pdGlhbFN0YXRlIGFzIFMpO1xuICB9XG5cbiAgLyoqXG4gICAqICBTZXQgdGhlIGxvYWRpbmcgc3RhdGVcbiAgICpcbiAgICogIEBleGFtcGxlXG4gICAqXG4gICAqICBzdG9yZS5zZXRMb2FkaW5nKHRydWUpXG4gICAqXG4gICAqL1xuICBzZXRMb2FkaW5nKGxvYWRpbmcgPSBmYWxzZSkge1xuICAgIGlmIChsb2FkaW5nICE9PSAodGhpcy5fdmFsdWUoKSBhcyBTICYgeyBsb2FkaW5nOiBib29sZWFuIH0pLmxvYWRpbmcpIHtcbiAgICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdTZXQgTG9hZGluZycpO1xuICAgICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHsgLi4uc3RhdGUsIGxvYWRpbmcgfSBhcyBTICYgeyBsb2FkaW5nOiBib29sZWFuIH0pKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogU2V0IHdoZXRoZXIgdGhlIGRhdGEgaXMgY2FjaGVkXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnNldEhhc0NhY2hlKHRydWUpXG4gICAqIHN0b3JlLnNldEhhc0NhY2hlKGZhbHNlKVxuICAgKiBzdG9yZS5zZXRIYXNDYWNoZSh0cnVlLCB7IHJlc3RhcnRUVEw6IHRydWUgfSlcbiAgICpcbiAgICovXG4gIHNldEhhc0NhY2hlKGhhc0NhY2hlOiBib29sZWFuLCBvcHRpb25zOiB7IHJlc3RhcnRUVEw6IGJvb2xlYW4gfSA9IHsgcmVzdGFydFRUTDogZmFsc2UgfSkge1xuICAgIGlmIChoYXNDYWNoZSAhPT0gdGhpcy5jYWNoZS5hY3RpdmUudmFsdWUpIHtcbiAgICAgIHRoaXMuY2FjaGUuYWN0aXZlLm5leHQoaGFzQ2FjaGUpO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnJlc3RhcnRUVEwpIHtcbiAgICAgIGNvbnN0IHR0bENvbmZpZyA9IHRoaXMuZ2V0Q2FjaGVUVEwoKTtcbiAgICAgIGlmICh0dGxDb25maWcpIHtcbiAgICAgICAgaWYgKHRoaXMuY2FjaGUudHRsICE9PSBudWxsKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuY2FjaGUudHRsKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNhY2hlLnR0bCA9IDxhbnk+c2V0VGltZW91dCgoKSA9PiB0aGlzLnNldEhhc0NhY2hlKGZhbHNlKSwgdHRsQ29uZmlnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogU29tZXRpbWVzIHdlIG5lZWQgdG8gYWNjZXNzIHRoZSBzdG9yZSB2YWx1ZSBmcm9tIGEgc3RvcmVcbiAgICpcbiAgICogQGV4YW1wbGUgbWlkZGxld2FyZVxuICAgKlxuICAgKi9cbiAgZ2V0VmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmVWYWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgU2V0IHRoZSBlcnJvciBzdGF0ZVxuICAgKlxuICAgKiAgQGV4YW1wbGVcbiAgICpcbiAgICogIHN0b3JlLnNldEVycm9yKHt0ZXh0OiAndW5hYmxlIHRvIGxvYWQgZGF0YScgfSlcbiAgICpcbiAgICovXG4gIHNldEVycm9yPFQ+KGVycm9yOiBUKSB7XG4gICAgaWYgKGVycm9yICE9PSAodGhpcy5fdmFsdWUoKSBhcyBTICYgeyBlcnJvcjogYW55IH0pLmVycm9yKSB7XG4gICAgICBpc0RldigpICYmIHNldEFjdGlvbignU2V0IEVycm9yJyk7XG4gICAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiAoeyAuLi5zdGF0ZSwgZXJyb3IgfSBhcyBTICYgeyBlcnJvcjogYW55IH0pKTtcbiAgICB9XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgX3NlbGVjdDxSPihwcm9qZWN0OiAoc3RvcmU6IFMpID0+IFIpOiBPYnNlcnZhYmxlPFI+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgbWFwKHByb2plY3QpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgX3ZhbHVlKCk6IFMge1xuICAgIHJldHVybiB0aGlzLnN0b3JlVmFsdWU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgX2NhY2hlKCk6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuYWN0aXZlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBjb25maWcoKTogU3RvcmVDb25maWdPcHRpb25zIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcltjb25maWdLZXldIHx8IHt9O1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBzdG9yZU5hbWUoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNvbmZpZyBhcyBTdG9yZUNvbmZpZ09wdGlvbnMgJiB7IHN0b3JlTmFtZTogc3RyaW5nIH0pLnN0b3JlTmFtZSB8fCAodGhpcy5vcHRpb25zIGFzIFN0b3JlQ29uZmlnT3B0aW9ucyAmIHsgc3RvcmVOYW1lOiBzdHJpbmcgfSkuc3RvcmVOYW1lIHx8IHRoaXMub3B0aW9ucy5uYW1lO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBkZWVwRnJlZXplKCkge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5kZWVwRnJlZXplRm4gfHwgdGhpcy5vcHRpb25zLmRlZXBGcmVlemVGbiB8fCBkZWVwRnJlZXplO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCBjYWNoZUNvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcuY2FjaGUgfHwgdGhpcy5vcHRpb25zLmNhY2hlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCByZXNldHRhYmxlKCkge1xuICAgIHJldHVybiBpc0RlZmluZWQodGhpcy5jb25maWcucmVzZXR0YWJsZSkgPyB0aGlzLmNvbmZpZy5yZXNldHRhYmxlIDogdGhpcy5vcHRpb25zLnJlc2V0dGFibGU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgX3NldFN0YXRlKG5ld1N0YXRlRm46IChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFMsIF9kaXNwYXRjaEFjdGlvbiA9IHRydWUpIHtcbiAgICB0aGlzLnN0b3JlVmFsdWUgPSBfX0RFVl9fID8gdGhpcy5kZWVwRnJlZXplKG5ld1N0YXRlRm4odGhpcy5fdmFsdWUoKSkpIDogbmV3U3RhdGVGbih0aGlzLl92YWx1ZSgpKTtcblxuICAgIGlmICghdGhpcy5zdG9yZSkge1xuICAgICAgdGhpcy5zdG9yZSA9IG5ldyBCZWhhdmlvclN1YmplY3QodGhpcy5zdG9yZVZhbHVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNUcmFuc2FjdGlvbkluUHJvY2VzcygpKSB7XG4gICAgICB0aGlzLmhhbmRsZVRyYW5zYWN0aW9uKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5kaXNwYXRjaCh0aGlzLnN0b3JlVmFsdWUsIF9kaXNwYXRjaEFjdGlvbik7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVzZXQgdGhlIGN1cnJlbnQgc3RvcmUgYmFjayB0byB0aGUgaW5pdGlhbCB2YWx1ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5yZXNldCgpXG4gICAqXG4gICAqL1xuICByZXNldCgpIHtcbiAgICBpZiAodGhpcy5pc1Jlc2V0dGFibGUoKSkge1xuICAgICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1Jlc2V0Jyk7XG4gICAgICB0aGlzLl9zZXRTdGF0ZSgoKSA9PiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLl9pbml0aWFsU3RhdGUpKTtcbiAgICAgIHRoaXMuc2V0SGFzQ2FjaGUoZmFsc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpc0RldigpICYmIGNvbnNvbGUud2FybihgWW91IG5lZWQgdG8gZW5hYmxlIHRoZSByZXNldCBmdW5jdGlvbmFsaXR5YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSB0aGUgc3RvcmUncyB2YWx1ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShzdGF0ZSA9PiB7XG4gICAqICAgcmV0dXJuIHsuLi59XG4gICAqIH0pXG4gICAqL1xuICB1cGRhdGUoc3RhdGVDYWxsYmFjazogVXBkYXRlU3RhdGVDYWxsYmFjazxTPik7XG4gIC8qKlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiAgdGhpcy5zdG9yZS51cGRhdGUoeyB0b2tlbjogdG9rZW4gfSlcbiAgICovXG4gIHVwZGF0ZShzdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShzdGF0ZU9yQ2FsbGJhY2s6IFBhcnRpYWw8Uz4gfCBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+KSB7XG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1VwZGF0ZScpO1xuXG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKHN0YXRlT3JDYWxsYmFjaykgPyBzdGF0ZU9yQ2FsbGJhY2soc3RhdGUpIDogc3RhdGVPckNhbGxiYWNrO1xuICAgICAgY29uc3QgbWVyZ2VkID0gdGhpcy5ha2l0YVByZVVwZGF0ZShzdGF0ZSwgeyAuLi5zdGF0ZSwgLi4ubmV3U3RhdGUgfSBhcyBTKTtcbiAgICAgIHJldHVybiBpc1BsYWluT2JqZWN0KHN0YXRlKSA/IG1lcmdlZCA6IG5ldyAoc3RhdGUgYXMgYW55KS5jb25zdHJ1Y3RvcihtZXJnZWQpO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlU3RvcmVDb25maWcobmV3T3B0aW9uczogVXBkYXRhYmxlU3RvcmVDb25maWdPcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0geyAuLi50aGlzLm9wdGlvbnMsIC4uLm5ld09wdGlvbnMgfTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZVVwZGF0ZShfOiBSZWFkb25seTxTPiwgbmV4dFN0YXRlOiBSZWFkb25seTxTPik6IFMge1xuICAgIHJldHVybiBuZXh0U3RhdGU7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBEZXN0cm95IHRoZSBzdG9yZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5kZXN0cm95KClcbiAgICpcbiAgICovXG4gIGRlc3Ryb3koKSB7XG4gICAgY29uc3QgaG1yRW5hYmxlZCA9IGlzQnJvd3NlciA/ICh3aW5kb3cgYXMgYW55KS5obXJFbmFibGVkIDogZmFsc2U7XG4gICAgaWYgKCFobXJFbmFibGVkICYmIHRoaXMgPT09IF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdKSB7XG4gICAgICBkZWxldGUgX19zdG9yZXNfX1t0aGlzLnN0b3JlTmFtZV07XG4gICAgICBkaXNwYXRjaERlbGV0ZWQodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgdGhpcy5zZXRIYXNDYWNoZShmYWxzZSk7XG4gICAgICB0aGlzLmNhY2hlLmFjdGl2ZS5jb21wbGV0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Jbml0KGluaXRpYWxTdGF0ZTogUykge1xuICAgIF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdID0gdGhpcztcbiAgICB0aGlzLl9zZXRTdGF0ZSgoKSA9PiBpbml0aWFsU3RhdGUpO1xuICAgIGRpc3BhdGNoQWRkZWQodGhpcy5zdG9yZU5hbWUpO1xuICAgIGlmICh0aGlzLmlzUmVzZXR0YWJsZSgpKSB7XG4gICAgICB0aGlzLl9pbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGU7XG4gICAgfVxuICAgIGlzRGV2KCkgJiYgYXNzZXJ0U3RvcmVIYXNOYW1lKHRoaXMuc3RvcmVOYW1lLCB0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwYXRjaChzdGF0ZTogUywgX2Rpc3BhdGNoQWN0aW9uID0gdHJ1ZSkge1xuICAgIHRoaXMuc3RvcmUubmV4dChzdGF0ZSk7XG4gICAgaWYgKF9kaXNwYXRjaEFjdGlvbikge1xuICAgICAgZGlzcGF0Y2hVcGRhdGUodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgcmVzZXRDdXN0b21BY3Rpb24oKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHdhdGNoVHJhbnNhY3Rpb24oKSB7XG4gICAgY29tbWl0KCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xuICAgICAgdGhpcy5kaXNwYXRjaCh0aGlzLl92YWx1ZSgpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNSZXNldHRhYmxlKCkge1xuICAgIGlmICh0aGlzLnJlc2V0dGFibGUgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJlc2V0dGFibGUgfHwgZ2V0QWtpdGFDb25maWcoKS5yZXNldHRhYmxlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVUcmFuc2FjdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuaW5UcmFuc2FjdGlvbikge1xuICAgICAgdGhpcy53YXRjaFRyYW5zYWN0aW9uKCk7XG4gICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2FjaGVUVEwoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNhY2hlQ29uZmlnICYmIHRoaXMuY2FjaGVDb25maWcudHRsKSB8fCBnZXRBa2l0YUNvbmZpZygpLnR0bDtcbiAgfVxufVxuIl19