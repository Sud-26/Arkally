/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { filter, skip } from 'rxjs/operators';
import { from, isObservable, of, ReplaySubject } from 'rxjs';
import { isFunction } from './isFunction';
import { AkitaError } from './errors';
import { __stores__ } from './stores';
import { getValue } from './getValueByString';
import { setAction } from './actions';
import { setValue } from './setValueByString';
import { $$addStore, $$deleteStore } from './dispatchers';
import { isNil } from './isNil';
import { isObject } from './isObject';
import { isNotBrowser } from './root';
/** @type {?} */
let skipStorageUpdate = false;
/** @type {?} */
const _persistStateInit = new ReplaySubject(1);
/**
 * @return {?}
 */
export function selectPersistStateInit() {
    return _persistStateInit.asObservable();
}
/**
 * @param {?} skip
 * @return {?}
 */
export function setSkipStorageUpdate(skip) {
    skipStorageUpdate = skip;
}
/**
 * @return {?}
 */
export function getSkipStorageUpdate() {
    return skipStorageUpdate;
}
/**
 * @record
 */
export function PersistStateStorage() { }
if (false) {
    /**
     * @param {?} key
     * @return {?}
     */
    PersistStateStorage.prototype.getItem = function (key) { };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    PersistStateStorage.prototype.setItem = function (key, value) { };
    /**
     * @return {?}
     */
    PersistStateStorage.prototype.clear = function () { };
}
/**
 * @param {?} v
 * @return {?}
 */
function isPromise(v) {
    return v && isFunction(v.then);
}
/**
 * @param {?} asyncOrValue
 * @return {?}
 */
function observify(asyncOrValue) {
    if (isPromise(asyncOrValue) || isObservable(asyncOrValue)) {
        return from(asyncOrValue);
    }
    return of(asyncOrValue);
}
/**
 * @record
 */
export function PersistStateParams() { }
if (false) {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Whether to enable persistState in a non-browser environment
     * @type {?}
     */
    PersistStateParams.prototype.enableInNonBrowser;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
    /** @type {?} */
    PersistStateParams.prototype.skipStorageUpdate;
    /** @type {?} */
    PersistStateParams.prototype.preStorageUpdateOperator;
    /**
     * Whether to persist a dynamic store upon destroy
     * @type {?}
     */
    PersistStateParams.prototype.persistOnDestroy;
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStorageUpdate = function (storeName, state) { };
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStoreUpdate = function (storeName, state) { };
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    /** @type {?} */
    const defaults = {
        key: 'AkitaStores',
        enableInNonBrowser: false,
        storage: typeof localStorage === 'undefined' ? params.storage : localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        // @deprecated
        exclude: [],
        persistOnDestroy: false,
        preStorageUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        preStoreUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        skipStorageUpdate: getSkipStorageUpdate,
        preStorageUpdateOperator: (/**
         * @return {?}
         */
        () => (/**
         * @param {?} source
         * @return {?}
         */
        source => source))
    };
    const { storage, enableInNonBrowser, deserialize, serialize, include, exclude, key, preStorageUpdate, persistOnDestroy, preStorageUpdateOperator, preStoreUpdate, skipStorageUpdate } = Object.assign({}, defaults, params);
    if (isNotBrowser && !enableInNonBrowser)
        return;
    /** @type {?} */
    const hasInclude = include.length > 0;
    /** @type {?} */
    const hasExclude = exclude.length > 0;
    /** @type {?} */
    let includeStores;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    if (hasInclude) {
        includeStores = include.reduce((/**
         * @param {?} acc
         * @param {?} path
         * @return {?}
         */
        (acc, path) => {
            if (isFunction(path)) {
                acc.fns.push(path);
            }
            else {
                /** @type {?} */
                const storeName = path.split('.')[0];
                acc[storeName] = path;
            }
            return acc;
        }), { fns: [] });
    }
    /** @type {?} */
    let stores = {};
    /** @type {?} */
    let acc = {};
    /** @type {?} */
    let subscriptions = [];
    /** @type {?} */
    const buffer = [];
    /**
     * @param {?} v
     * @return {?}
     */
    function _save(v) {
        observify(v).subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const next = buffer.shift();
            next && _save(next);
        }));
    }
    // when we use the local/session storage we perform the serialize, otherwise we let the passed storage implementation to do it
    /** @type {?} */
    const isLocalStorage = typeof localStorage !== 'undefined' && (storage === localStorage || storage === sessionStorage);
    observify(storage.getItem(key)).subscribe((/**
     * @param {?} value
     * @return {?}
     */
    (value) => {
        /** @type {?} */
        let storageState = isObject(value) ? value : deserialize(value || '{}');
        /**
         * @param {?} storeCache
         * @return {?}
         */
        function save(storeCache) {
            storageState['$cache'] = Object.assign({}, (storageState['$cache'] || {}), storeCache);
            storageState = Object.assign({}, storageState, acc);
            buffer.push(storage.setItem(key, isLocalStorage ? serialize(storageState) : storageState));
            _save(buffer.shift());
        }
        /**
         * @param {?} storeName
         * @param {?} path
         * @return {?}
         */
        function subscribe(storeName, path) {
            stores[storeName] = __stores__[storeName]
                ._select((/**
             * @param {?} state
             * @return {?}
             */
            state => getValue(state, path)))
                .pipe(skip(1), filter((/**
             * @return {?}
             */
            () => skipStorageUpdate() === false)), preStorageUpdateOperator())
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                acc[storeName] = preStorageUpdate(storeName, data);
                Promise.resolve().then((/**
                 * @return {?}
                 */
                () => save({ [storeName]: __stores__[storeName]._cache().getValue() })));
            }));
        }
        /**
         * @param {?} storeName
         * @param {?} store
         * @param {?} path
         * @return {?}
         */
        function setInitial(storeName, store, path) {
            if (storeName in storageState) {
                setAction('@PersistState');
                store._setState((/**
                 * @param {?} state
                 * @return {?}
                 */
                state => {
                    return setValue(state, path, preStoreUpdate(storeName, storageState[storeName]));
                }));
                /** @type {?} */
                const hasCache = storageState['$cache'] ? storageState['$cache'][storeName] : false;
                __stores__[storeName].setHasCache(hasCache, { restartTTL: true });
            }
        }
        subscriptions.push($$deleteStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        storeName => {
            if (stores[storeName]) {
                if (persistOnDestroy === false) {
                    save({ [storeName]: false });
                }
                stores[storeName].unsubscribe();
                delete stores[storeName];
            }
        })));
        subscriptions.push($$addStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        storeName => {
            if (hasExclude && exclude.includes(storeName)) {
                return;
            }
            /** @type {?} */
            const store = __stores__[storeName];
            if (hasInclude) {
                /** @type {?} */
                let path = includeStores[storeName];
                if (!path) {
                    /** @type {?} */
                    const passPredicate = includeStores.fns.some((/**
                     * @param {?} fn
                     * @return {?}
                     */
                    fn => fn(storeName)));
                    if (passPredicate) {
                        path = storeName;
                    }
                    else {
                        return;
                    }
                }
                setInitial(storeName, store, path);
                subscribe(storeName, path);
            }
            else {
                setInitial(storeName, store, storeName);
                subscribe(storeName, storeName);
            }
        })));
        _persistStateInit.next();
    }));
    return {
        /**
         * @return {?}
         */
        destroy() {
            subscriptions.forEach((/**
             * @param {?} s
             * @return {?}
             */
            s => s.unsubscribe()));
            for (let i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                const storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        /**
         * @return {?}
         */
        clear() {
            storage.clear();
        },
        /**
         * @param {?=} storeName
         * @return {?}
         */
        clearStore(storeName) {
            if (isNil(storeName)) {
                /** @type {?} */
                const value = observify(storage.setItem(key, '{}'));
                value.subscribe();
                return;
            }
            /** @type {?} */
            const value = storage.getItem(key);
            observify(value).subscribe((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                /** @type {?} */
                const storageState = deserialize(v || '{}');
                if (storageState[storeName]) {
                    delete storageState[storeName];
                    /** @type {?} */
                    const value = observify(storage.setItem(key, serialize(storageState)));
                    value.subscribe();
                }
            }));
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdFN0YXRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BlcnNpc3RTdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQW9CLGFBQWEsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFFN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDaEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sUUFBUSxDQUFDOztJQUVsQyxpQkFBaUIsR0FBRyxLQUFLOztNQUV2QixpQkFBaUIsR0FBRyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUM7Ozs7QUFFOUMsTUFBTSxVQUFVLHNCQUFzQjtJQUNwQyxPQUFPLGlCQUFpQixDQUFDLFlBQVksRUFBRSxDQUFDO0FBQzFDLENBQUM7Ozs7O0FBRUQsTUFBTSxVQUFVLG9CQUFvQixDQUFDLElBQWE7SUFDaEQsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0FBQzNCLENB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QUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbEIsQ0FBQzs7Ozs7UUFDRCxVQUFVLENBQUMsU0FBa0I7WUFDM0IsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUU7O3NCQUNkLEtBQUssR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ25ELEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDbEIsT0FBTzthQUNSOztrQkFDSyxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDbEMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVM7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTs7c0JBQ3ZCLFlBQVksR0FBRyxXQUFXLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztnQkFFM0MsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUU7b0JBQzNCLE9BQU8sWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDOzswQkFDekIsS0FBSyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztvQkFDdEUsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUNuQjtZQUNILENBQUMsRUFBQyxDQUFDO1FBQ0wsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZmlsdGVyLCBza2lwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZnJvbSwgaXNPYnNlcnZhYmxlLCBvZiwgT3BlcmF0b3JGdW5jdGlvbiwgUmVwbGF5U3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIYXNoTWFwLCBNYXliZUFzeW5jIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi9pc0Z1bmN0aW9uJztcbmltcG9ydCB7IEFraXRhRXJyb3IgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBfX3N0b3Jlc19fIH0gZnJvbSAnLi9zdG9yZXMnO1xuaW1wb3J0IHsgZ2V0VmFsdWUgfSBmcm9tICcuL2dldFZhbHVlQnlTdHJpbmcnO1xuaW1wb3J0IHsgc2V0QWN0aW9uIH0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IHNldFZhbHVlIH0gZnJvbSAnLi9zZXRWYWx1ZUJ5U3RyaW5nJztcbmltcG9ydCB7ICQkYWRkU3RvcmUsICQkZGVsZXRlU3RvcmUgfSBmcm9tICcuL2Rpc3BhdGNoZXJzJztcbmltcG9ydCB7IGlzTmlsIH0gZnJvbSAnLi9pc05pbCc7XG5pbXBvcnQgeyBpc09iamVjdCB9IGZyb20gJy4vaXNPYmplY3QnO1xuaW1wb3J0IHsgaXNOb3RCcm93c2VyIH0gZnJvbSAnLi9yb290JztcblxubGV0IHNraXBTdG9yYWdlVXBkYXRlID0gZmFsc2U7XG5cbmNvbnN0IF9wZXJzaXN0U3RhdGVJbml0ID0gbmV3IFJlcGxheVN1YmplY3QoMSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3RQZXJzaXN0U3RhdGVJbml0KCkge1xuICByZXR1cm4gX3BlcnNpc3RTdGF0ZUluaXQuYXNPYnNlcnZhYmxlKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRTa2lwU3RvcmFnZVVwZGF0ZShza2lwOiBib29sZWFuKSB7XG4gIHNraXBTdG9yYWdlVXBkYXRlID0gc2tpcDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNraXBTdG9yYWdlVXBkYXRlKCkge1xuICByZXR1cm4gc2tpcFN0b3JhZ2VVcGRhdGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVyc2lzdFN0YXRlU3RvcmFnZSB7XG4gIGdldEl0ZW0oa2V5OiBzdHJpbmcpOiBNYXliZUFzeW5jO1xuXG4gIHNldEl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBNYXliZUFzeW5jO1xuXG4gIGNsZWFyKCk6IHZvaWQ7XG59XG5cbmZ1bmN0aW9uIGlzUHJvbWlzZSh2OiBhbnkpIHtcbiAgcmV0dXJuIHYgJiYgaXNGdW5jdGlvbih2LnRoZW4pO1xufVxuXG5mdW5jdGlvbiBvYnNlcnZpZnkoYXN5bmNPclZhbHVlOiBhbnkpIHtcbiAgaWYgKGlzUHJvbWlzZShhc3luY09yVmFsdWUpIHx8IGlzT2JzZXJ2YWJsZShhc3luY09yVmFsdWUpKSB7XG4gICAgcmV0dXJuIGZyb20oYXN5bmNPclZhbHVlKTtcbiAgfVxuXG4gIHJldHVybiBvZihhc3luY09yVmFsdWUpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlcnNpc3RTdGF0ZVBhcmFtcyB7XG4gIC8qKiBUaGUgc3RvcmFnZSBrZXkgKi9cbiAga2V5OiBzdHJpbmc7XG4gIC8qKiBXaGV0aGVyIHRvIGVuYWJsZSBwZXJzaXN0U3RhdGUgaW4gYSBub24tYnJvd3NlciBlbnZpcm9ubWVudCAqL1xuICBlbmFibGVJbk5vbkJyb3dzZXI6IGJvb2xlYW47XG4gIC8qKiBTdG9yYWdlIHN0cmF0ZWd5IHRvIHVzZS4gVGhpcyBkZWZhdWx0cyB0byBMb2NhbFN0b3JhZ2UgYnV0IHlvdSBjYW4gcGFzcyBTZXNzaW9uU3RvcmFnZSBvciBhbnl0aGluZyB0aGF0IGltcGxlbWVudHMgdGhlIFN0b3JhZ2VFbmdpbmUgQVBJLiAqL1xuICBzdG9yYWdlOiBQZXJzaXN0U3RhdGVTdG9yYWdlO1xuICAvKiogQ3VzdG9tIGRlc2VyaWFsaXplci4gRGVmYXVsdHMgdG8gSlNPTi5wYXJzZSAqL1xuICBkZXNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKiBDdXN0b20gc2VyaWFsaXplciwgZGVmYXVsdHMgdG8gSlNPTi5zdHJpbmdpZnkgKi9cbiAgc2VyaWFsaXplOiBGdW5jdGlvbjtcbiAgLyoqXG4gICAqIEJ5IGRlZmF1bHQgdGhlIHdob2xlIHN0YXRlIGlzIHNhdmVkIHRvIHN0b3JhZ2UsIHVzZSB0aGlzIHBhcmFtIHRvIGluY2x1ZGUgb25seSB0aGUgc3RvcmVzIHlvdSBuZWVkLlxuICAgKiBQYXkgYXR0ZW50aW9uIHRoYXQgeW91IGNhbid0IHVzZSBib3RoIGluY2x1ZGUgYW5kIGV4Y2x1ZGVcbiAgICovXG4gIGluY2x1ZGU6IChzdHJpbmcgfCAoKHN0b3JlTmFtZTogc3RyaW5nKSA9PiBib29sZWFuKSlbXTtcbiAgLyoqXG4gICAqICBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBleGNsdWRlIHN0b3JlcyB0aGF0IHlvdSBkb24ndCBuZWVkLlxuICAgKiAgUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBleGNsdWRlOiBzdHJpbmdbXTtcblxuICBwcmVTdG9yYWdlVXBkYXRlKHN0b3JlTmFtZTogc3RyaW5nLCBzdGF0ZTogYW55KTogYW55O1xuXG4gIHByZVN0b3JlVXBkYXRlKHN0b3JlTmFtZTogc3RyaW5nLCBzdGF0ZTogYW55KTogYW55O1xuXG4gIHNraXBTdG9yYWdlVXBkYXRlOiAoKSA9PiBib29sZWFuO1xuICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3I6ICgpID0+IE9wZXJhdG9yRnVuY3Rpb248YW55LCBhbnk+O1xuICAvKiogV2hldGhlciB0byBwZXJzaXN0IGEgZHluYW1pYyBzdG9yZSB1cG9uIGRlc3Ryb3kgKi9cbiAgcGVyc2lzdE9uRGVzdHJveTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcnNpc3RTdGF0ZShwYXJhbXM/OiBQYXJ0aWFsPFBlcnNpc3RTdGF0ZVBhcmFtcz4pIHtcbiAgY29uc3QgZGVmYXVsdHM6IFBlcnNpc3RTdGF0ZVBhcmFtcyA9IHtcbiAgICBrZXk6ICdBa2l0YVN0b3JlcycsXG4gICAgZW5hYmxlSW5Ob25Ccm93c2VyOiBmYWxzZSxcbiAgICBzdG9yYWdlOiB0eXBlb2YgbG9jYWxTdG9yYWdlID09PSAndW5kZWZpbmVkJyA/IHBhcmFtcy5zdG9yYWdlIDogbG9jYWxTdG9yYWdlLFxuICAgIGRlc2VyaWFsaXplOiBKU09OLnBhcnNlLFxuICAgIHNlcmlhbGl6ZTogSlNPTi5zdHJpbmdpZnksXG4gICAgaW5jbHVkZTogW10sXG4gICAgLy8gQGRlcHJlY2F0ZWRcbiAgICBleGNsdWRlOiBbXSxcbiAgICBwZXJzaXN0T25EZXN0cm95OiBmYWxzZSxcbiAgICBwcmVTdG9yYWdlVXBkYXRlOiBmdW5jdGlvbihzdG9yZU5hbWUsIHN0YXRlKSB7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfSxcbiAgICBwcmVTdG9yZVVwZGF0ZTogZnVuY3Rpb24oc3RvcmVOYW1lLCBzdGF0ZSkge1xuICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH0sXG4gICAgc2tpcFN0b3JhZ2VVcGRhdGU6IGdldFNraXBTdG9yYWdlVXBkYXRlLFxuICAgIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvcjogKCkgPT4gc291cmNlID0+IHNvdXJjZVxuICB9O1xuXG4gIGNvbnN0IHsgc3RvcmFnZSwgZW5hYmxlSW5Ob25Ccm93c2VyLCBkZXNlcmlhbGl6ZSwgc2VyaWFsaXplLCBpbmNsdWRlLCBleGNsdWRlLCBrZXksIHByZVN0b3JhZ2VVcGRhdGUsIHBlcnNpc3RPbkRlc3Ryb3ksIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvciwgcHJlU3RvcmVVcGRhdGUsIHNraXBTdG9yYWdlVXBkYXRlIH0gPSBPYmplY3QuYXNzaWduKFxuICAgIHt9LFxuICAgIGRlZmF1bHRzLFxuICAgIHBhcmFtc1xuICApO1xuXG4gIGlmIChpc05vdEJyb3dzZXIgJiYgIWVuYWJsZUluTm9uQnJvd3NlcikgcmV0dXJuO1xuXG4gIGNvbnN0IGhhc0luY2x1ZGUgPSBpbmNsdWRlLmxlbmd0aCA+IDA7XG4gIGNvbnN0IGhhc0V4Y2x1ZGUgPSBleGNsdWRlLmxlbmd0aCA+IDA7XG4gIGxldCBpbmNsdWRlU3RvcmVzOiB7IGZuczogRnVuY3Rpb25bXTsgW2tleTogc3RyaW5nXTogRnVuY3Rpb25bXSB8IHN0cmluZyB9O1xuXG4gIGlmIChoYXNJbmNsdWRlICYmIGhhc0V4Y2x1ZGUpIHtcbiAgICB0aHJvdyBuZXcgQWtpdGFFcnJvcihcIllvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXCIpO1xuICB9XG5cbiAgaWYgKGhhc0luY2x1ZGUpIHtcbiAgICBpbmNsdWRlU3RvcmVzID0gaW5jbHVkZS5yZWR1Y2UoXG4gICAgICAoYWNjLCBwYXRoKSA9PiB7XG4gICAgICAgIGlmIChpc0Z1bmN0aW9uKHBhdGgpKSB7XG4gICAgICAgICAgYWNjLmZucy5wdXNoKHBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHN0b3JlTmFtZSA9IHBhdGguc3BsaXQoJy4nKVswXTtcbiAgICAgICAgICBhY2Nbc3RvcmVOYW1lXSA9IHBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7IGZuczogW10gfVxuICAgICk7XG4gIH1cblxuICBsZXQgc3RvcmVzOiBIYXNoTWFwPFN1YnNjcmlwdGlvbj4gPSB7fTtcbiAgbGV0IGFjYyA9IHt9O1xuICBsZXQgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcblxuICBjb25zdCBidWZmZXIgPSBbXTtcblxuICBmdW5jdGlvbiBfc2F2ZSh2OiBhbnkpIHtcbiAgICBvYnNlcnZpZnkodikuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGNvbnN0IG5leHQgPSBidWZmZXIuc2hpZnQoKTtcbiAgICAgIG5leHQgJiYgX3NhdmUobmV4dCk7XG4gICAgfSk7XG4gIH1cblxuICAvLyB3aGVuIHdlIHVzZSB0aGUgbG9jYWwvc2Vzc2lvbiBzdG9yYWdlIHdlIHBlcmZvcm0gdGhlIHNlcmlhbGl6ZSwgb3RoZXJ3aXNlIHdlIGxldCB0aGUgcGFzc2VkIHN0b3JhZ2UgaW1wbGVtZW50YXRpb24gdG8gZG8gaXRcbiAgY29uc3QgaXNMb2NhbFN0b3JhZ2UgPSB0eXBlb2YgbG9jYWxTdG9yYWdlICE9PSAndW5kZWZpbmVkJyAmJiAoc3RvcmFnZSA9PT0gbG9jYWxTdG9yYWdlIHx8IHN0b3JhZ2UgPT09IHNlc3Npb25TdG9yYWdlKTtcblxuICBvYnNlcnZpZnkoc3RvcmFnZS5nZXRJdGVtKGtleSkpLnN1YnNjcmliZSgodmFsdWU6IGFueSkgPT4ge1xuICAgIGxldCBzdG9yYWdlU3RhdGUgPSBpc09iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IGRlc2VyaWFsaXplKHZhbHVlIHx8ICd7fScpO1xuXG4gICAgZnVuY3Rpb24gc2F2ZShzdG9yZUNhY2hlKSB7XG4gICAgICBzdG9yYWdlU3RhdGVbJyRjYWNoZSddID0geyAuLi4oc3RvcmFnZVN0YXRlWyckY2FjaGUnXSB8fCB7fSksIC4uLnN0b3JlQ2FjaGUgfTtcbiAgICAgIHN0b3JhZ2VTdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0b3JhZ2VTdGF0ZSwgYWNjKTtcblxuICAgICAgYnVmZmVyLnB1c2goc3RvcmFnZS5zZXRJdGVtKGtleSwgaXNMb2NhbFN0b3JhZ2UgPyBzZXJpYWxpemUoc3RvcmFnZVN0YXRlKSA6IHN0b3JhZ2VTdGF0ZSkpO1xuICAgICAgX3NhdmUoYnVmZmVyLnNoaWZ0KCkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpIHtcbiAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdID0gX19zdG9yZXNfX1tzdG9yZU5hbWVdXG4gICAgICAgIC5fc2VsZWN0KHN0YXRlID0+IGdldFZhbHVlKHN0YXRlLCBwYXRoKSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgc2tpcCgxKSxcbiAgICAgICAgICBmaWx0ZXIoKCkgPT4gc2tpcFN0b3JhZ2VVcGRhdGUoKSA9PT0gZmFsc2UpLFxuICAgICAgICAgIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvcigpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShkYXRhID0+IHtcbiAgICAgICAgICBhY2Nbc3RvcmVOYW1lXSA9IHByZVN0b3JhZ2VVcGRhdGUoc3RvcmVOYW1lLCBkYXRhKTtcbiAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHNhdmUoeyBbc3RvcmVOYW1lXTogX19zdG9yZXNfX1tzdG9yZU5hbWVdLl9jYWNoZSgpLmdldFZhbHVlKCkgfSkpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpIHtcbiAgICAgIGlmIChzdG9yZU5hbWUgaW4gc3RvcmFnZVN0YXRlKSB7XG4gICAgICAgIHNldEFjdGlvbignQFBlcnNpc3RTdGF0ZScpO1xuICAgICAgICBzdG9yZS5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICAgIHJldHVybiBzZXRWYWx1ZShzdGF0ZSwgcGF0aCwgcHJlU3RvcmVVcGRhdGUoc3RvcmVOYW1lLCBzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgaGFzQ2FjaGUgPSBzdG9yYWdlU3RhdGVbJyRjYWNoZSddID8gc3RvcmFnZVN0YXRlWyckY2FjaGUnXVtzdG9yZU5hbWVdIDogZmFsc2U7XG4gICAgICAgIF9fc3RvcmVzX19bc3RvcmVOYW1lXS5zZXRIYXNDYWNoZShoYXNDYWNoZSwgeyByZXN0YXJ0VFRMOiB0cnVlIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICQkZGVsZXRlU3RvcmUuc3Vic2NyaWJlKHN0b3JlTmFtZSA9PiB7XG4gICAgICAgIGlmIChzdG9yZXNbc3RvcmVOYW1lXSkge1xuICAgICAgICAgIGlmIChwZXJzaXN0T25EZXN0cm95ID09PSBmYWxzZSkge1xuICAgICAgICAgICAgc2F2ZSh7IFtzdG9yZU5hbWVdOiBmYWxzZSB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc3RvcmVzW3N0b3JlTmFtZV0udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICBkZWxldGUgc3RvcmVzW3N0b3JlTmFtZV07XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICQkYWRkU3RvcmUuc3Vic2NyaWJlKHN0b3JlTmFtZSA9PiB7XG4gICAgICAgIGlmIChoYXNFeGNsdWRlICYmIGV4Y2x1ZGUuaW5jbHVkZXMoc3RvcmVOYW1lKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHN0b3JlID0gX19zdG9yZXNfX1tzdG9yZU5hbWVdO1xuICAgICAgICBpZiAoaGFzSW5jbHVkZSkge1xuICAgICAgICAgIGxldCBwYXRoID0gaW5jbHVkZVN0b3Jlc1tzdG9yZU5hbWVdO1xuXG4gICAgICAgICAgaWYgKCFwYXRoKSB7XG4gICAgICAgICAgICBjb25zdCBwYXNzUHJlZGljYXRlID0gaW5jbHVkZVN0b3Jlcy5mbnMuc29tZShmbiA9PiBmbihzdG9yZU5hbWUpKTtcbiAgICAgICAgICAgIGlmIChwYXNzUHJlZGljYXRlKSB7XG4gICAgICAgICAgICAgIHBhdGggPSBzdG9yZU5hbWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHNldEluaXRpYWwoc3RvcmVOYW1lLCBzdG9yZSwgcGF0aCk7XG4gICAgICAgICAgc3Vic2NyaWJlKHN0b3JlTmFtZSwgcGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2V0SW5pdGlhbChzdG9yZU5hbWUsIHN0b3JlLCBzdG9yZU5hbWUpO1xuICAgICAgICAgIHN1YnNjcmliZShzdG9yZU5hbWUsIHN0b3JlTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIF9wZXJzaXN0U3RhdGVJbml0Lm5leHQoKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBkZXN0cm95KCkge1xuICAgICAgc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHMgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBrZXlzID0gT2JqZWN0LmtleXMoc3RvcmVzKTsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgc3RvcmVOYW1lID0ga2V5c1tpXTtcbiAgICAgICAgc3RvcmVzW3N0b3JlTmFtZV0udW5zdWJzY3JpYmUoKTtcbiAgICAgIH1cbiAgICAgIHN0b3JlcyA9IHt9O1xuICAgIH0sXG4gICAgY2xlYXIoKSB7XG4gICAgICBzdG9yYWdlLmNsZWFyKCk7XG4gICAgfSxcbiAgICBjbGVhclN0b3JlKHN0b3JlTmFtZT86IHN0cmluZykge1xuICAgICAgaWYgKGlzTmlsKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBvYnNlcnZpZnkoc3RvcmFnZS5zZXRJdGVtKGtleSwgJ3t9JykpO1xuICAgICAgICB2YWx1ZS5zdWJzY3JpYmUoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgdmFsdWUgPSBzdG9yYWdlLmdldEl0ZW0oa2V5KTtcbiAgICAgIG9ic2VydmlmeSh2YWx1ZSkuc3Vic2NyaWJlKHYgPT4ge1xuICAgICAgICBjb25zdCBzdG9yYWdlU3RhdGUgPSBkZXNlcmlhbGl6ZSh2IHx8ICd7fScpO1xuXG4gICAgICAgIGlmIChzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXSkge1xuICAgICAgICAgIGRlbGV0ZSBzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXTtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9ic2VydmlmeShzdG9yYWdlLnNldEl0ZW0oa2V5LCBzZXJpYWxpemUoc3RvcmFnZVN0YXRlKSkpO1xuICAgICAgICAgIHZhbHVlLnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG4iXX0=